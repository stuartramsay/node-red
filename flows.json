[
    {
        "id": "3bdea1b6503b06dc",
        "type": "tab",
        "label": "TESTING AREA",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "cfcf0d8f65cecaa7",
        "type": "tab",
        "label": "Watchdog",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "238bdd166ab1d860",
        "type": "tab",
        "label": "❤ Heartbeat",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a90cc5d82d9a1021",
        "type": "tab",
        "label": "AA API Endpoints",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "1dc165ed61e2f895",
        "type": "tab",
        "label": "Internal Endpoints",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "token_validation_flow",
        "type": "tab",
        "label": "AA Token Validation",
        "disabled": false,
        "info": "Flow to test Automation Anywhere API token validity"
    },
    {
        "id": "36cc116f1f3383e8",
        "type": "tab",
        "label": "Get All Bots Flow",
        "disabled": false,
        "info": "Complete flow to collect ALL bot records from Automation Anywhere API with pagination support",
        "env": []
    },
    {
        "id": "885f4ac2cb49a2c1",
        "type": "tab",
        "label": "Python Training",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e295b550a1e2af80",
        "type": "tab",
        "label": "GraphAPI",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "96f51dbb3fe375ba",
        "type": "tab",
        "label": "GraphAPI Testing",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "11ae27e22bf567bd",
        "type": "tab",
        "label": "Monitors",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "594708c349b147f4",
        "type": "tab",
        "label": "Schedules",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f778b963edde7e03",
        "type": "tab",
        "label": "SUGAR",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d6212fb1464d8c29",
        "type": "tab",
        "label": "Watchfolders",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "2ef09639923d028e",
        "type": "subflow",
        "name": "AA Authentication",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 280,
                "y": 300,
                "wires": [
                    {
                        "id": "736935bc8ed505e0"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 2740,
                "y": 320,
                "wires": [
                    {
                        "id": "d42035da1fe4afe3",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "c4217fb89f6015dc",
        "type": "subflow",
        "name": "Permit Run",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 100,
                "wires": [
                    {
                        "id": "b017ab080fcff0b5"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1120,
                "y": 60,
                "wires": [
                    {
                        "id": "131131fe24b9f5dc",
                        "port": 0
                    },
                    {
                        "id": "545b190f7a643621",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "6f225a1da665927d",
        "type": "group",
        "z": "d6212fb1464d8c29",
        "name": "Multi Relationships - New",
        "style": {
            "label": true
        },
        "nodes": [
            "ce5a44e76716bbec",
            "054e3aad9e3f5dc4",
            "2575216802b03675",
            "78f1d70fb7480504"
        ],
        "x": 694,
        "y": 39,
        "w": 872,
        "h": 82
    },
    {
        "id": "0b41605f5c419952",
        "type": "group",
        "z": "d6212fb1464d8c29",
        "name": "Multi Relationships - New",
        "style": {
            "label": true
        },
        "nodes": [
            "151af69c044aa10b",
            "8b60c785a303fd1f",
            "e1571a0d7d10ecf2",
            "639c78af7a2f0a7b"
        ],
        "x": 694,
        "y": 159,
        "w": 872,
        "h": 82
    },
    {
        "id": "33674f8857a0f888",
        "type": "global-config",
        "name": "global-config",
        "env": [
            {
                "name": "test",
                "value": "",
                "type": "str"
            }
        ]
    },
    {
        "id": "4159b2383138607d",
        "type": "MSSQL-CN",
        "tdsVersion": "7_4",
        "name": "Jupiter",
        "server": "emdb",
        "port": "1433",
        "encyption": false,
        "trustServerCertificate": true,
        "database": "Jupiter",
        "useUTC": true,
        "connectTimeout": "15000",
        "requestTimeout": "0",
        "cancelTimeout": "5000",
        "pool": "5",
        "parseJSON": false,
        "enableArithAbort": true,
        "readOnlyIntent": false
    },
    {
        "id": "93257d4a00304d23",
        "type": "MSSQL",
        "z": "2ef09639923d028e",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "query",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 2280,
        "y": 180,
        "wires": [
            [
                "d42035da1fe4afe3"
            ]
        ]
    },
    {
        "id": "8291117233ce1222",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "function 7",
        "func": "const sql = `\n    BEGIN TRANSACTION;\n\n    UPDATE aa.api_tokens\n    SET is_expired = 1,\n        expired_utc = GETUTCDATE(),\n        is_active = 0\n    WHERE username = '${msg.username}'\n    AND environment = '${msg.environment}'\n    AND is_expired = 0\n    AND is_active = 1;\n\n    INSERT INTO aa.api_tokens\n    (\n        username,\n        token,\n        environment,\n        used_count,\n        last_used_utc\n    )\n    VALUES\n    (\n        '${msg.username}',\n        '${msg.token}',\n        '${msg.environment}',\n        1,\n        getutcdate()\n    );\n\n    COMMIT TRANSACTION;\n\n`\n\nmsg.query = sql\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1920,
        "y": 180,
        "wires": [
            [
                "93257d4a00304d23"
            ]
        ]
    },
    {
        "id": "d42035da1fe4afe3",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Set Response",
        "func": "msg.payload = {\n    \"token\": msg.token\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2500,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "90d8430c8f5b4a35",
        "type": "change",
        "z": "2ef09639923d028e",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "payload.token",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1740,
        "y": 180,
        "wires": [
            [
                "8291117233ce1222"
            ]
        ]
    },
    {
        "id": "0f4b241c5edb1dd7",
        "type": "MSSQL",
        "z": "2ef09639923d028e",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "query",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 2280,
        "y": 320,
        "wires": [
            [
                "d42035da1fe4afe3"
            ]
        ]
    },
    {
        "id": "f75229c81b413397",
        "type": "http request",
        "z": "2ef09639923d028e",
        "name": "API Call",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1560,
        "y": 180,
        "wires": [
            [
                "90d8430c8f5b4a35"
            ]
        ]
    },
    {
        "id": "1d20233980c3deac",
        "type": "switch",
        "z": "2ef09639923d028e",
        "name": "Requires new?",
        "property": "requires_new",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2060,
        "y": 320,
        "wires": [
            [
                "f0c176381a422d65"
            ],
            [
                "0f4b241c5edb1dd7"
            ]
        ]
    },
    {
        "id": "f0c176381a422d65",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Authenticate for New Token",
        "func": "// Build authentication request to get new token\nconst BASE_URL = msg.baseUrl;\nconst AUTH_ENDPOINT = `${BASE_URL}/v2/authentication`;\nconst authBody = {\n    \"username\": msg.username,\n    \"password\": msg.password\n};\nmsg.url = AUTH_ENDPOINT;\nmsg.method = \"POST\";\nmsg.headers = { 'Content-Type': 'application/json' };\nmsg.payload = JSON.stringify(authBody);\nmsg.requestType = \"authentication\";\nmsg.reason = msg.tokenExists ? \"invalid_token\" : \"no_token\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 180,
        "wires": [
            [
                "f75229c81b413397"
            ]
        ]
    },
    {
        "id": "73bda980b02c789a",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Check if requires new",
        "func": "let requires_new\nlet sql\n\nif (msg.payload?.page?.totalFilter !== undefined) {\n    requires_new = false;\n    sql = `UPDATE aa.api_tokens SET used_count = used_count + 1, last_used_utc = getutcdate() WHERE username = '${msg.username}' and environment = '${msg.environment}' and token = '${msg.token}'`\n} else {\n    requires_new = true;\n}\n\nmsg.requires_new = requires_new\nmsg.query = sql\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 320,
        "wires": [
            [
                "1d20233980c3deac"
            ]
        ]
    },
    {
        "id": "b08cbac46a9bb92d",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Check Token Exists",
        "func": "// Check if any non-expired token exists\nif (!msg.payload || msg.payload.length === 0) {\n    // No tokens found - go straight to create new token\n    msg.tokenExists = false;\n    return [msg, null]; // Output 1: authenticate_for_new_token\n} else {\n    // Token found - validate\n    const tokenData = msg.payload[0];\n    msg.tokenId = tokenData.id;\n    msg.token = tokenData.token;\n    msg.tokenExists = true;\n    msg.tokenData = tokenData;\n    return [null, msg]; // Output 2: validate_token_request\n}",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 260,
        "wires": [
            [
                "f0c176381a422d65"
            ],
            [
                "52831a2a249f4f2e"
            ]
        ]
    },
    {
        "id": "4bfd155a1db5edd8",
        "type": "http request",
        "z": "2ef09639923d028e",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1550,
        "y": 320,
        "wires": [
            [
                "73bda980b02c789a"
            ]
        ]
    },
    {
        "id": "b2a32a77f6194e2b",
        "type": "MSSQL",
        "z": "2ef09639923d028e",
        "mssqlCN": "4159b2383138607d",
        "name": "Get Latest Non-Expired Token",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT TOP 1 id, username, token, creation_utc, last_used_utc, used_count, environment FROM aa.api_tokens WHERE username = 'bot_api' AND environment = '{{payload.environment}}' AND is_active = 1 AND is_expired = 0 ORDER BY creation_utc DESC;",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "none",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 830,
        "y": 260,
        "wires": [
            [
                "b08cbac46a9bb92d"
            ]
        ]
    },
    {
        "id": "52831a2a249f4f2e",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Validate Token Request",
        "func": "// Use BASE_URL and TOKEN from the msg object, not hardcoded strings\nconst BASE_URL = msg.baseUrl; // e.g., \"https://inspired-1.my.automationanywhere.digital\"\nconst TOKEN = msg.token; // or msg.payload.token if that's where your token lives\n\n// Compose the endpoint\nconst ACTIVITY_ENDPOINT = `${BASE_URL}/v3/activity/list`;\n\n// Set up headers\nmsg.url = ACTIVITY_ENDPOINT;\nmsg.headers = { \n    \"Content-Type\": \"application/json\", \n    \"accept\": \"application/json\", \n    \"X-Authorization\": TOKEN \n};\n\n// Set up the payload object\nmsg.payload = {\n    \"filter\": {\n        \"operator\": \"and\",\n        \"operands\": [],\n        \"sort\": [\n            {\n                \"field\": \"startDateTime\",\n                \"direction\": \"desc\"\n            }\n        ]\n    }\n};\n\n// You can set the request method and any other tracking properties as needed\nmsg.method = \"POST\";\nmsg.requestType = \"activityList\"; // Optional, for your own tracking\nmsg.originalToken = TOKEN; // Optional, like your original\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 320,
        "wires": [
            [
                "4bfd155a1db5edd8"
            ]
        ]
    },
    {
        "id": "736935bc8ed505e0",
        "type": "function",
        "z": "2ef09639923d028e",
        "name": "Process Request & Map Environment",
        "func": "// Process incoming request and map environment to URL\nconst USERNAME = \"bot_api\";\nconst PASSWORD = \"Welcome@2021\";\nconst ENVIRONMENT_URLS = {\n    \"dev\": \"https://inspired-1dev.my.automationanywhere.digital\",\n    \"uat\": \"https://inspired-1uat.my.automationanywhere.digital\",\n    \"live\": \"https://inspired-1.my.automationanywhere.digital\",\n    \"https://inspired-1dev.my.automationanywhere.digital\": \"https://inspired-1dev.my.automationanywhere.digital\",\n    \"https://inspired-1uat.my.automationanywhere.digital\": \"https://inspired-1uat.my.automationanywhere.digital\",\n    \"https://inspired-1.my.automationanywhere.digital\": \"https://inspired-1.my.automationanywhere.digital\",\n    \"https://inspired-1dev.my.automationanywhere.digital/\": \"https://inspired-1dev.my.automationanywhere.digital\",\n    \"https://inspired-1uat.my.automationanywhere.digital/\": \"https://inspired-1uat.my.automationanywhere.digital\",\n    \"https://inspired-1.my.automationanywhere.digital/\": \"https://inspired-1.my.automationanywhere.digital\",\n};\nlet environment = null;\nif (msg.payload && typeof msg.payload === 'object') {\n    environment = msg.payload.environment;\n} else if (msg.payload && typeof msg.payload === 'string') {\n    try {\n        const parsed = JSON.parse(msg.payload);\n        environment = parsed.environment;\n    } catch (e) {\n        environment = msg.payload;\n    }\n}\nif (!environment || !ENVIRONMENT_URLS[environment]) {\n    environment = 'live'\n    // node.error(`Invalid or missing environment. Must be one of: ${Object.keys(ENVIRONMENT_URLS).join(', ')}`, msg);\n    // return null;\n}\nmsg.environment = environment;\nmsg.baseUrl = ENVIRONMENT_URLS[environment];\nmsg.username = USERNAME;\nmsg.password = PASSWORD;\nmsg.payload = {\n    environment: environment\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 260,
        "wires": [
            [
                "b2a32a77f6194e2b"
            ]
        ]
    },
    {
        "id": "d1793b5e080446f1",
        "type": "inject",
        "z": "2ef09639923d028e",
        "name": "Test LIVE Environment",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "x": 140,
        "y": 260,
        "wires": [
            [
                "736935bc8ed505e0"
            ]
        ]
    },
    {
        "id": "b017ab080fcff0b5",
        "type": "exec",
        "z": "c4217fb89f6015dc",
        "command": "hostname",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 200,
        "y": 100,
        "wires": [
            [
                "f54ff459a40967a1"
            ],
            [],
            []
        ]
    },
    {
        "id": "f54ff459a40967a1",
        "type": "function",
        "z": "c4217fb89f6015dc",
        "name": "Analyse Hostname",
        "func": "const HOSTNAME = (msg.payload || \"\").toString().toUpperCase().trim();\n\n// Normalised role\nlet role = \"UNKNOWN\";\n\n// Primary patterns\nconst primaryList = [\n    \"MAN-BOTR-V25\",\n    \"MAN-BOT-WD-PRIMARY\"\n];\n\n// Secondary patterns\nconst secondaryList = [\n    \"MAN-BOTR-V21\",\n    \"MAN-BOT-WD-SECONDARY\"\n];\n\nfunction match(list, host) {\n    return list.some(p => host.includes(p));\n}\n\nif (match(primaryList, HOSTNAME)) {\n    role = \"PRIMARY\";\n}\n\nif (match(secondaryList, HOSTNAME)) {\n    role = \"SECONDARY\";\n}\n\nmsg.role = role;\nmsg.hostname = HOSTNAME;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 100,
        "wires": [
            [
                "8bd73f646c97847a"
            ]
        ]
    },
    {
        "id": "8bd73f646c97847a",
        "type": "switch",
        "z": "c4217fb89f6015dc",
        "name": "Role",
        "property": "role",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "PRIMARY",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "SECONDARY",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 590,
        "y": 100,
        "wires": [
            [
                "131131fe24b9f5dc"
            ],
            [
                "f98e70f5bdd2cd2c"
            ]
        ]
    },
    {
        "id": "131131fe24b9f5dc",
        "type": "function",
        "z": "c4217fb89f6015dc",
        "name": "Allow",
        "func": "msg.payload = true;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "f98e70f5bdd2cd2c",
        "type": "http request",
        "z": "c4217fb89f6015dc",
        "name": "",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://10.8.8.70:1880/endpoint/test",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 750,
        "y": 120,
        "wires": [
            [
                "545b190f7a643621"
            ]
        ]
    },
    {
        "id": "545b190f7a643621",
        "type": "function",
        "z": "c4217fb89f6015dc",
        "name": "Check if Primary Up",
        "func": "// Decide if this secondary should run, based on health of primary\n\nlet primaryUp = true;\n\n// If HTTP Request succeeded with a 2xx status, assume primary is up\nif (typeof msg.statusCode === \"number\") {\n    if (msg.statusCode >= 200 && msg.statusCode < 300) {\n        primaryUp = true;\n    } else {\n        primaryUp = false;\n    }\n} else if (msg.error) {\n    // HTTP node put an error on msg.error when the request failed\n    primaryUp = false;\n} else {\n    // No clear info, treat as up for safety, or change to false if you prefer\n    primaryUp = true;\n}\n\nif (primaryUp) {\n    // Primary is healthy, do NOT run secondary\n    msg.payload = false;\n} else {\n    // Primary is down or unreachable, run secondary\n    msg.payload = true;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "9bed9279d88df787",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 770,
        "y": 60,
        "wires": [
            [
                "ac8e7543ac81dfb1"
            ]
        ]
    },
    {
        "id": "ac8e7543ac81dfb1",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 12",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 60,
        "wires": []
    },
    {
        "id": "ae7ae50d25f6baa1",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 1",
        "func": "const TOKEN = msg.token;          // JWT generated earlier\n\n// 1. Get the list safely\nconst schedules = Array.isArray(msg.payload?.list) ? msg.payload.list : [];\n\n// 2. Filter out anything whose ownedBy is 632 (handle number or string)\nconst ids = schedules\n            .filter(item => item.ownedBy !== 632 && item.ownedBy !== \"632\" && item.id == \"2848\")\n            .map(item   => item.id);\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/schedule/automations/changeOwner\";\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  \"scheduleIds\": [\"2848\"],\n  \"userId\": \"632\",\n}\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 600,
        "wires": [
            [
                "111c99844b9b3cf5"
            ]
        ]
    },
    {
        "id": "111c99844b9b3cf5",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1690,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "84def4be77223126",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 130,
        "y": 60,
        "wires": [
            [
                "ca56fc05b538aeb2"
            ]
        ]
    },
    {
        "id": "ca56fc05b538aeb2",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 320,
        "y": 60,
        "wires": [
            [
                "596476e67696bc03"
            ]
        ]
    },
    {
        "id": "596476e67696bc03",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 60,
        "wires": [
            [
                "9bed9279d88df787"
            ]
        ]
    },
    {
        "id": "ac5be936f3dbbd32",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get Scheduled",
        "func": "// Node-RED Function  :  list scheduled activity but exclude owner 632\n\nconst TOKEN = msg.payload.token;          // JWT generated earlier\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v1/schedule/automations/list\";\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\n// ‘owner’ in the Schedule API is the user who created the schedule → field = createdBy\n// Use operator \"ne\" (not-equal) to exclude ID 632\nmsg.payload = {\n    filter:{\n    // \"operator\": \"eq\",\n    // \"field\": \"ownedBy\",\n    // \"value\": \"632\"\n  },\n    sort: [],\n    page: {\n      offset: 0, \n      length: 1000 \n      }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 120,
        "wires": [
            [
                "458711efda0ef2ed"
            ]
        ]
    },
    {
        "id": "ffd9a984ae6bcee1",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 130,
        "y": 120,
        "wires": [
            [
                "4edc8ef0524e70ab"
            ]
        ]
    },
    {
        "id": "4edc8ef0524e70ab",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 320,
        "y": 120,
        "wires": [
            [
                "ac5be936f3dbbd32"
            ]
        ]
    },
    {
        "id": "458711efda0ef2ed",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 730,
        "y": 120,
        "wires": [
            [
                "9a4d6a18ec64156c",
                "69b1447ceb6568f4"
            ]
        ]
    },
    {
        "id": "639de70cb1164ef7",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 120,
        "y": 280,
        "wires": [
            [
                "fd76e27e2983b43d"
            ]
        ]
    },
    {
        "id": "fd76e27e2983b43d",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 310,
        "y": 280,
        "wires": [
            [
                "23164de51cc82c9a"
            ]
        ]
    },
    {
        "id": "23164de51cc82c9a",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 9",
        "func": "const TOKEN = msg.payload.token;\n\n// Only run if we haven't started collection\nif (!msg.collectingAll) {\n    msg.collectingAll = true;\n    msg.allResults = [];\n    msg.currentOffset = 0;\n    msg.pageSize = 1000;\n    msg.totalRecords = null;\n}\n\nconst makeRequest = async () => {\n    const response = await new Promise((resolve, reject) => {\n        const requestMsg = {\n            url: \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\",\n            method: \"POST\",\n            headers: { \n                \"Content-Type\": \"application/json\", \n                \"accept\": \"application/json\", \n                \"X-Authorization\": TOKEN \n            },\n            payload: {\n                \"filter\": {\n                    \"operator\": \"and\",\n                    \"operands\": [],\n                    \"sort\": [{ \"field\": \"startDateTime\", \"direction\": \"desc\" }]\n                },\n                \"page\": {\n                    \"offset\": msg.currentOffset,\n                    \"length\": msg.pageSize\n                }\n            }\n        };\n        \n        // You'd need to modify this to work with Node-RED's HTTP request node\n        // This is pseudo-code for the concept\n    });\n    \n    return response;\n};\n\n// Continue with current request\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \n    \"Content-Type\": \"application/json\", \n    \"accept\": \"application/json\", \n    \"X-Authorization\": TOKEN \n};\n\nmsg.payload = {\n    \"filter\": {\n        \"operator\": \"and\",\n        \"operands\": [],\n        \"sort\": [{ \"field\": \"startDateTime\", \"direction\": \"desc\" }]\n    },\n    \"page\": {\n        \"offset\": msg.currentOffset,\n        \"length\": msg.pageSize\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 280,
        "wires": [
            [
                "90c5fe640a275c06"
            ]
        ]
    },
    {
        "id": "49ed46d967a330f9",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 280,
        "wires": []
    },
    {
        "id": "90c5fe640a275c06",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 670,
        "y": 280,
        "wires": [
            [
                "49ed46d967a330f9"
            ]
        ]
    },
    {
        "id": "e148db479d277da0",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 620,
        "wires": [
            [
                "ef0c83b460dbde49"
            ]
        ]
    },
    {
        "id": "ef0c83b460dbde49",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 290,
        "y": 620,
        "wires": [
            [
                "e6c4a433980c1189"
            ]
        ]
    },
    {
        "id": "e6c4a433980c1189",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get All Users",
        "func": "// Node-RED Function: Get all users\n\nconst TOKEN = msg.payload.token;          // JWT generated earlier\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/usermanagement/users/list\"\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n    filter: {\n        \"operator\": \"eq\",\n        \"field\": \"username\",\n        \"value\": \"aautomationmanager\"\n    },\n    sort: [],\n    page: {\n        offset: 0, \n        length: 1000 \n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 620,
        "wires": [
            [
                "96cc7d4d641f9793"
            ]
        ]
    },
    {
        "id": "96cc7d4d641f9793",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 790,
        "y": 620,
        "wires": [
            [
                "6f9507a042a45ba0"
            ]
        ]
    },
    {
        "id": "6f9507a042a45ba0",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 16",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 620,
        "wires": []
    },
    {
        "id": "6dcbfaf021624056",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            },
            {
                "p": "payload.bot_name",
                "v": "performanceShareBillings",
                "vt": "str"
            },
            {
                "p": "payload.username",
                "v": "botrunner42",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 760,
        "wires": [
            [
                "8adf7c8467c4bb8d"
            ]
        ]
    },
    {
        "id": "8adf7c8467c4bb8d",
        "type": "change",
        "z": "3bdea1b6503b06dc",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "bot_name",
                "pt": "msg",
                "to": "payload.bot_name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runner_username",
                "pt": "msg",
                "to": "payload.username",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 760,
        "wires": [
            [
                "3dd3f917cf4b141a"
            ]
        ]
    },
    {
        "id": "3dd3f917cf4b141a",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 510,
        "y": 760,
        "wires": [
            [
                "140ad66a55f8ce8f"
            ]
        ]
    },
    {
        "id": "40c8bbb167746c5c",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get all bots",
        "func": "/***********************\n * Requires:\n *   msg.baseUrl           (e.g., https://inspired-1.my.automationanywhere.digital)\n *   msg.payload.token     (Bearer token)\n *   msg.pageSize          (e.g., 200)\n *   msg.workspaceIds      (Array of NUMERIC PRIVATE workspace ids: [12345, ...])\n ***********************/\nconst baseUrl   = msg.baseUrl;\nconst token     = msg?.payload?.token || msg.token;\nconst pageSize  = Number(msg.pageSize || 200);\nconst wsIds     = Array.isArray(msg.workspaceIds) ? msg.workspaceIds.map(x => String(x)) : [];\n\nif (!baseUrl) throw new Error(\"baseUrl missing (msg.baseUrl).\");\nif (!token)   throw new Error(\"token missing (msg.payload.token).\");\nif (!wsIds.length) throw new Error(\"workspaceIds missing. Set msg.workspaceIds to PRIVATE workspace numeric id(s), e.g. [12345].\");\n\n// init accumulators\nflow.set('repo_all', []);\n\n// pager + multi-workspace state\nmsg.state = {\n  wsIds,        // array of workspace ids (strings)\n  wsIndex: 0,   // current workspace pointer\n  offset: 0,\n  size: pageSize,\n  total: null\n};\n\n// build first POST for the first PRIVATE workspace\nconst ws = msg.state.wsIds[msg.state.wsIndex]; // numeric id as string\nmsg.method = \"POST\";\nmsg.url = `${baseUrl}/v2/repository/workspaces/${ws}/files/list`;\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"accept\": \"application/json\",\n  \"X-Authorization\": token\n};\nmsg.payload = {\n  filter: { operator: \"and\", operands: [] },    // ALL items\n  sort:   [{ field: \"path\", direction: \"asc\" }],\n  page:   { offset: msg.state.offset, size: msg.state.size }\n};\n\n// carry core info for the loop\nmsg._aa = { baseUrl, token };\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 760,
        "wires": [
            [
                "c6e5bb56450fe887"
            ]
        ]
    },
    {
        "id": "1e4acc53e21e2d69",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 27",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1540,
        "y": 760,
        "wires": []
    },
    {
        "id": "c6e5bb56450fe887",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1110,
        "y": 760,
        "wires": [
            [
                "1e4acc53e21e2d69"
            ]
        ]
    },
    {
        "id": "140ad66a55f8ce8f",
        "type": "change",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.token",
                "pt": "msg",
                "to": "token",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 760,
        "wires": [
            [
                "f58ced0c1c477cde"
            ]
        ]
    },
    {
        "id": "b84c4c81b910df63",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 15",
        "func": "// Expect HTTP response: msg.payload = { page: {...}, list: [...] }\nconst resp = msg.payload || {};\nconst list = Array.isArray(resp.list) ? resp.list : [];\nconst page = resp.page || {};\n\n// keep using your client-side filter: only TaskBots when msg.extractBots = true\nconst onlyBots = !!msg.extractBots;\nconst mapped = list\n  .filter(x => !onlyBots || x?.typeLabel === \"TASK_BOT\")\n  // you asked for name + labelType\n  .map(x => ({ name: x?.name || \"\", labelType: x?.typeLabel || \"\" }));\n\nlet agg = flow.get(\"allBots\") || [];\nagg = agg.concat(mapped);\nflow.set(\"allBots\", agg);\n\n// pagination bookkeeping\nconst total = (typeof page.totalFilter === \"number\") ? page.totalFilter\n             : (typeof page.total === \"number\") ? page.total\n             : null;\n\nif (total !== null && (msg._paging.offset + list.length) < total) {\n  // more pages\n  msg._paging.offset += msg._paging.length;\n\n  msg.method = \"POST\";\n  // reuse the same PRIVATE endpoint\n  msg.payload = {\n    filter: { operator: \"eq\", field: \"folder\", value: false },\n    sort:   [{ field: \"name\", direction: \"asc\" }],\n    page:   { offset: msg._paging.offset, length: msg._paging.length }\n  };\n  return [msg, null];\n}\n\n// done\nconst out = { payload: agg };\n// cleanup\nflow.set(\"allBots\", []);\ndelete msg._paging;\n\nreturn [null, out];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 760,
        "wires": [
            [
                "1e4acc53e21e2d69"
            ],
            [
                "c6e5bb56450fe887"
            ]
        ]
    },
    {
        "id": "f58ced0c1c477cde",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get all bots",
        "func": "// Inputs already present in your flow:\n//   msg.token   (from AA Authentication)\n// No other assumptions.\n\n// --- PRIVATE workspace endpoint ---\nconst BASE = \"https://inspired-1.my.automationanywhere.digital\";\nconst TOKEN = msg.token;\n\nmsg.url = `${BASE}/v2/repository/workspaces/private/files/list`;\nmsg.method = \"POST\";\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\n// Return files (not folders), sort by name; request first page.\n// Note: Control Room accepts boolean; your old string \"false\" also worked.\n// Keep page length 200 like before.\nmsg.payload = {\n  filter: { operator: \"eq\", field: \"folder\", value: false },\n  sort:   [{ field: \"name\", direction: \"asc\" }],\n  page:   { offset: 0, length: 200 }\n};\n\n// paging state for the loop\nmsg._paging = { offset: 0, length: 200, total: null };\n\n// tell the downstream node we only want TaskBots (same as your extractBots flag)\nmsg.extractBots = true;\n\n// accumulator\nflow.set(\"allBots\", []);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 820,
        "wires": [
            [
                "c6e5bb56450fe887"
            ]
        ]
    },
    {
        "id": "9a4d6a18ec64156c",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 4",
        "func": "\nlet originalArray = msg.payload.list\nlet trimmedArray = originalArray.slice(0, 10);\nmsg.example = trimmedArray\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "69b1447ceb6568f4",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 13",
        "func": "/**\n * Input: msg.payload.list = Array of schedule objects\n * Output: multiple messages to MSSQL node:\n *   1) TRUNCATE TABLE\n *   2..N) INSERT with named params @p1..@p38 and params as [{name,type,value,length?},...]\n */\n\nfunction nz(v) { return (v === undefined || v === null) ? null : v; }\nfunction toBool(v) {\n  if (typeof v === \"boolean\") return v;\n  if (v === 1 || v === \"1\" || v === \"true\" || v === \"TRUE\") return true;\n  if (v === 0 || v === \"0\" || v === \"false\" || v === \"FALSE\") return false;\n  return v ? true : false;\n}\nfunction toIntOrNull(v) {\n  if (v === \"\" || v === undefined || v === null) return null;\n  const n = parseInt(v, 10);\n  return Number.isFinite(n) ? n : null;\n}\nfunction toDateOrNull(v) { return (!v || v === \"\") ? null : v; }            // 'YYYY-MM-DD'\nfunction toDtoOrNull(v) { return (!v || v === \"\") ? null : v; }             // ISO w/ Z or offset\nfunction toGuidOrNull(v){ return (!v || v === \"\") ? null : v; }\nfunction jsonify(v) {\n  if (v === undefined || v === null) return null;\n  try { return JSON.stringify(v); } catch(e) { return null; }\n}\n\n// Expect array at msg.payload.list\nconst rows = (msg && msg.payload && Array.isArray(msg.payload.list)) ? msg.payload.list : [];\nif (rows.length === 0) {\n  node.warn(\"watchdog: msg.payload.list is empty or missing; nothing to insert.\");\n  return null;\n}\n\n// 1) TRUNCATE\nnode.send({ topic: \"TRUNCATE TABLE aa.watchdog_schedule_data;\", params: [] });\n\n// 2) INSERT with named params\nconst sql = `\nINSERT INTO aa.watchdog_schedule_data (\n  id, name, fileId, status,\n  description, rdpEnabled, scheduleType, timeZone,\n  startDate, endDate, startTime, repeatEnabled,\n  zonedNextRunDateTime, createdBy, createdOn, updatedBy, updatedOn, tenantId,\n  fileName, filePath, tenantUuid, overrideDefaultDevice, runElevated, automationPriority,\n  botLabel, misfireScheduleConfig, numOfRunAsUsersToUse, handleUnexpectedPopups, ownedBy, hideBotAgentUi,\n  deviceIds, weeklyRecurrence, dailyRecurrence, repeatOccurrence, runAsUserIds, botInput, poolId, resiliency\n) VALUES (\n  @p1,@p2,@p3,@p4,\n  @p5,@p6,@p7,@p8,\n  @p9,@p10,@p11,@p12,\n  @p13,@p14,@p15,@p16,@p17,@p18,\n  @p19,@p20,@p21,@p22,@p23,@p24,\n  @p25,@p26,@p27,@p28,@p29,@p30,\n  @p31,@p32,@p33,@p34,@p35,@p36,@p37,@p38\n);`.replace(/\\s+/g,\" \").trim();\n\n// helper to build a parameter object; mssql-plus expects {name,type,value[,length]}\nfunction P(name, type, value, length) {\n  const p = { name, type, value };\n  if (length !== undefined) p.length = length;\n  return p;\n}\n\n// For each row, send one INSERT\nfor (const r of rows) {\n  const params = [\n    // NVARCHARs\n    P('p1','NVarChar', nz(r.id), 50),\n    P('p2','NVarChar', nz(r.name), 255),\n    P('p3','NVarChar', nz(r.fileId), 50),\n    P('p4','NVarChar', nz(r.status), 32),\n\n    P('p5','NVarChar', nz(r.description), 4000),\n    P('p6','Bit',       toBool(r.rdpEnabled)),\n    P('p7','NVarChar', nz(r.scheduleType), 32),\n    P('p8','NVarChar', nz(r.timeZone), 100),\n\n    // Dates / times\n    P('p9','Date',            toDateOrNull(r.startDate)),\n    P('p10','Date',           toDateOrNull(r.endDate)),\n    P('p11','VarChar',        nz(r.startTime), 5),          // 'HH:mm'\n    P('p12','Bit',            toBool(r.repeatEnabled)),\n\n    P('p13','DateTimeOffset', toDtoOrNull(r.zonedNextRunDateTime)),\n    P('p14','NVarChar',       nz(r.createdBy), 50),\n    P('p15','DateTimeOffset', toDtoOrNull(r.createdOn)),\n    P('p16','NVarChar',       nz(r.updatedBy), 50),\n    P('p17','DateTimeOffset', toDtoOrNull(r.updatedOn)),\n    P('p18','NVarChar',       nz(r.tenantId), 50),\n\n    P('p19','NVarChar', nz(r.fileName), 255),\n    P('p20','NVarChar', nz(r.filePath), 1024),\n    P('p21','UniqueIdentifier', toGuidOrNull(r.tenantUuid)),\n    P('p22','Bit', toBool(r.overrideDefaultDevice)),\n    P('p23','Bit', toBool(r.runElevated)),\n    P('p24','NVarChar', nz(r.automationPriority), 32),\n\n    P('p25','NVarChar', nz(r.botLabel), 255),\n    P('p26','Bit', toBool(r.misfireScheduleConfig)),\n    P('p27','Int', toIntOrNull(r.numOfRunAsUsersToUse)),\n    P('p28','Bit', toBool(r.handleUnexpectedPopups)),\n    P('p29','NVarChar', nz(r.ownedBy), 50),\n    P('p30','Bit', toBool(r.hideBotAgentUi)),\n\n    // JSON blobs -> NVARCHAR(MAX). No length property for MAX.\n    P('p31','NVarChar', jsonify(r.deviceIds)),\n    P('p32','NVarChar', jsonify(r.weeklyRecurrence)),\n    P('p33','NVarChar', jsonify(r.dailyRecurrence)),\n    P('p34','NVarChar', jsonify(r.repeatOccurrence)),\n    P('p35','NVarChar', jsonify(r.runAsUserIds)),\n    P('p36','NVarChar', jsonify(r.botInput)),\n    P('p37','NVarChar', jsonify(r.poolId)),\n    P('p38','NVarChar', jsonify(r.resiliency)),\n  ];\n\n  node.send({ topic: sql, params });\n}\n\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 120,
        "wires": [
            [
                "1eebf1e44baec087"
            ]
        ]
    },
    {
        "id": "1eebf1e44baec087",
        "type": "MSSQL",
        "z": "3bdea1b6503b06dc",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "params",
        "paramsOptType": "msg",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1120,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "05fee524f45fb7cc",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 400,
        "wires": [
            [
                "6322cd2861ef269e"
            ]
        ]
    },
    {
        "id": "6322cd2861ef269e",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 300,
        "y": 400,
        "wires": [
            [
                "89e51fe15e331e59"
            ]
        ]
    },
    {
        "id": "89e51fe15e331e59",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get Users",
        "func": "const TOKEN = msg.payload.token;          // JWT generated earlier\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/usermanagement/users/list\";\n\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"requestId\",\n        \"operator\": \"eq\",\n        \"value\": \"e131e8da-fdef-4f89-a340-a11462e7d0ba\"\n      }\n    ],\n    \"sort\": [\n      {}\n    ]\n  }\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 400,
        "wires": [
            [
                "feb1456c1d4d111e"
            ]
        ]
    },
    {
        "id": "feb1456c1d4d111e",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 710,
        "y": 400,
        "wires": [
            [
                "95c4a808a7008b81"
            ]
        ]
    },
    {
        "id": "95c4a808a7008b81",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Parse Users",
        "func": "// Node-RED Function: upsert aa.watchdog_cr_users from a JSON array.\n// Emits ONE message per user with a fully inlined T-SQL IF EXISTS/UPDATE/INSERT.\n// Target: SQL Server (Jupiter). No parameters, no Mustache.\n//\n// Input: msg.payload = [ { id, username, principalId, email, ... , roles: [{name:...}], licenseFeatures: [...] }, ... ]\n// Output: array of messages to MSSQL node; each msg has { topic, query } containing T-SQL.\n\nconst arr = Array.isArray(msg.payload) ? msg.payload : [];\nif (arr.length === 0) return null;\n\nconst nowIso = new Date().toISOString(); // UTC literal for first_seen_utc / last_seen_utc\n\n// escape T-SQL string literal and clamp length\nfunction esc(v, maxLen) {\n    let s = (v == null ? '' : String(v));\n    if (maxLen && s.length > maxLen) s = s.slice(0, maxLen);\n    return s.replace(/'/g, \"''\");\n}\n\n// boolean -> 0/1\nfunction b(v) { return v ? 1 : 0; }\n\n// flatten roles and license features\nfunction rolesCsv(roles) {\n    if (!Array.isArray(roles)) return '';\n    return roles.map(r => (r && r.name) ? String(r.name) : '').filter(Boolean).join(', ');\n}\nfunction licCsv(features) {\n    if (!Array.isArray(features)) return '';\n    return features.map(x => String(x)).filter(Boolean).join(', ');\n}\n\nconst out = [];\n\nfor (const u of arr) {\n    const principal_id  = esc(u.principalId ?? u.id, 64);\n    const user_id       = esc(u.id, 64);\n    const username      = esc(u.username, 256);\n    const email         = esc(u.email, 256);\n    const first_name    = esc(u.firstName, 128);\n    const last_name     = esc(u.lastName, 128);\n    const domain        = esc(u.domain, 128);\n    const description   = esc(u.description, 4000);\n    const version       = Number.isFinite(u.version) ? u.version : null;\n\n    const disabled               = b(u.disabled);\n    const enable_auto_login      = b(u.enableAutoLogin);\n    const multiple_login_allowed = b(u.multipleLoginAllowed);\n    const email_verified         = b(u.emailVerified);\n    const password_set           = b(u.passwordSet);\n\n    const created_by    = esc(u.createdBy, 64);\n    const updated_by    = esc(u.updatedBy, 64);\n\n    // date strings come in as ISO UTC; we’ll insert as literals\n    const created_on_utc = u.createdOn ? esc(u.createdOn, 64) : null;\n    const updated_on_utc = u.updatedOn ? esc(u.updatedOn, 64) : null;\n    const last_login_utc = u.lastLoginTime ? esc(u.lastLoginTime, 64) : null;\n\n    const roles_csv  = esc(rolesCsv(u.roles), 2000);\n    const roles_json = esc(JSON.stringify(u.roles || []), 0); // nvarchar(max), no clamp\n    const lic_csv    = esc(licCsv(u.licenseFeatures), 2000);\n\n    // build T-SQL upsert; use server time for updates, client ISO for inserts (both UTC)\n    const sql = `\nIF EXISTS (SELECT 1 FROM aa.watchdog_cr_users WITH (UPDLOCK, HOLDLOCK) WHERE principal_id='${principal_id}')\nBEGIN\n    UPDATE aa.watchdog_cr_users\n       SET user_id                = '${user_id}',\n           username               = '${username}',\n           email                  = '${email}',\n           first_name             = '${first_name}',\n           last_name              = '${last_name}',\n           domain                 = '${domain}',\n           description            = N'${description}',\n           version                = ${version === null ? 'NULL' : version},\n           disabled               = ${disabled},\n           enable_auto_login      = ${enable_auto_login},\n           multiple_login_allowed = ${multiple_login_allowed},\n           email_verified         = ${email_verified},\n           password_set           = ${password_set},\n           created_by             = '${created_by}',\n           created_on_utc         = ${created_on_utc ? `'${created_on_utc}'` : 'NULL'},\n           updated_by             = '${updated_by}',\n           updated_on_utc         = ${updated_on_utc ? `'${updated_on_utc}'` : 'NULL'},\n           last_login_utc         = ${last_login_utc ? `'${last_login_utc}'` : 'NULL'},\n           roles_csv              = N'${roles_csv}',\n           roles_json             = N'${roles_json}',\n           license_features_csv   = N'${lic_csv}',\n           last_seen_utc          = SYSUTCDATETIME(),\n           counter                = counter + 1;\nEND\nELSE\nBEGIN\n    INSERT INTO aa.watchdog_cr_users (\n        principal_id, user_id, username, email, first_name, last_name, domain, description, version,\n        disabled, enable_auto_login, multiple_login_allowed, email_verified, password_set,\n        created_by, created_on_utc, updated_by, updated_on_utc, last_login_utc,\n        roles_csv, roles_json, license_features_csv,\n        first_seen_utc, last_seen_utc, counter\n    ) VALUES (\n        '${principal_id}', '${user_id}', '${username}', '${email}', '${first_name}', '${last_name}', '${domain}', N'${description}', ${version === null ? 'NULL' : version},\n        ${disabled}, ${enable_auto_login}, ${multiple_login_allowed}, ${email_verified}, ${password_set},\n        '${created_by}', ${created_on_utc ? `'${created_on_utc}'` : 'NULL'}, '${updated_by}', ${updated_on_utc ? `'${updated_on_utc}'` : 'NULL'}, ${last_login_utc ? `'${last_login_utc}'` : 'NULL'},\n        N'${roles_csv}', N'${roles_json}', N'${lic_csv}',\n        '${nowIso}', '${nowIso}', 1\n    );\nEND\n`.trim();\n\n    out.push({ topic: sql, query: sql, user: { principalId: u.principalId ?? u.id, username: u.username } });\n}\n\n// Emit one message per user (Node-RED will send an array as multiple msgs)\nreturn [out];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "1ce8a30904a38588",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 1040,
        "wires": [
            [
                "3baca6fe9eb25808"
            ]
        ]
    },
    {
        "id": "3baca6fe9eb25808",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 300,
        "y": 1040,
        "wires": [
            [
                "8cfa5c289fef94d4"
            ]
        ]
    },
    {
        "id": "8cfa5c289fef94d4",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get checked out ",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/repository/workspaces/public/files/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"botStatus\",\n        \"operator\": \"eq\",\n        \"value\": \"CHECKED_OUT\"\n      }\n    ],\n    \"sort\": [\n      {}\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 1040,
        "wires": [
            [
                "32622ff3a23f4037"
            ]
        ]
    },
    {
        "id": "32622ff3a23f4037",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 750,
        "y": 1040,
        "wires": [
            [
                "e29efcb4a218cf9a"
            ]
        ]
    },
    {
        "id": "e29efcb4a218cf9a",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 1040,
        "wires": []
    },
    {
        "id": "2e53cd846a4a966b",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 480,
        "wires": [
            [
                "ff586b2f596c5933"
            ]
        ]
    },
    {
        "id": "ff586b2f596c5933",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 300,
        "y": 480,
        "wires": [
            [
                "4abd5941e602efe0"
            ]
        ]
    },
    {
        "id": "4abd5941e602efe0",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get Activity",
        "func": "const TOKEN = msg.payload.token;          // JWT generated earlier\n\n// msg.url = \"https://inspired-1.my.automationanywhere.digital/v1/audit/messages/list\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\n\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n    filter: {\n        \"operator\": \"eq\",\n        \"field\": \"deploymentId\",\n        \"value\": \"509ce0dd-2966-42c0-a0d2-00d7b495c08a\"\n    },\n    sort: [],\n    page: {\n        offset: 0, \n        length: 1000 \n    }\n};\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 480,
        "wires": [
            [
                "9bb359fad28b7eff"
            ]
        ]
    },
    {
        "id": "9bb359fad28b7eff",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 710,
        "y": 480,
        "wires": [
            [
                "f560504a27ace7dd"
            ]
        ]
    },
    {
        "id": "f560504a27ace7dd",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 480,
        "wires": []
    },
    {
        "id": "5c0f47aee04baf88",
        "type": "http in",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "url": "/wd_deploy_bot_test",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1180,
        "wires": [
            [
                "7c810ea6654b2e33",
                "885f9d309b766dcd"
            ]
        ]
    },
    {
        "id": "7c810ea6654b2e33",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 13",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 1160,
        "wires": []
    },
    {
        "id": "885f9d309b766dcd",
        "type": "http response",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 510,
        "y": 1220,
        "wires": []
    },
    {
        "id": "ed78ba4308cbf0f6",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 90,
        "y": 1400,
        "wires": [
            [
                "4b3d89870e0792ee"
            ]
        ]
    },
    {
        "id": "4b3d89870e0792ee",
        "type": "subflow:2ef09639923d028e",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 310,
        "y": 1400,
        "wires": [
            [
                "51533db120115c2b"
            ]
        ]
    },
    {
        "id": "06d9f54ffe8f0dff",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get Pools",
        "func": "// FN: build_devices_request\nconst TOKEN = msg.payload.token;\nif (!TOKEN) { node.error(\"Missing msg.payload.token\"); return null; }\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/devices/list\";\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\n// Optional: bump page length if your tenant supports it\nmsg.payload = {\n  page: { offset: 0, length: 1000 }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 1400,
        "wires": [
            [
                "ee985a504f93c309"
            ]
        ]
    },
    {
        "id": "ee985a504f93c309",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 670,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "1d9bba7efacde727",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 18",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 1460,
        "wires": []
    },
    {
        "id": "7c61966826dc7c03",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "function 3",
        "func": "// FN: filter_devices_by_pool\nconst TARGET = \"RDS_PRODUCTION\";\n\nconst body = msg.payload || {};\nconst list = Array.isArray(body.list) ? body.list : [];\nconst filtered = list.filter(d => (d.poolName || \"\").trim().toLowerCase() === TARGET.toLowerCase());\n\n// Preserve paging if present; replace list with filtered results\nmsg.payload = {\n  page: body.page || null,\n  list: filtered\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "51533db120115c2b",
        "type": "function",
        "z": "3bdea1b6503b06dc",
        "name": "Get RDS Devices",
        "func": "// FN: build_devices_request_RDS\nconst TOKEN = msg.payload.token;\nif (!TOKEN) { node.error(\"Missing msg.payload.token\"); return null; }\n\n// === Build POST request for /v2/devices/list ===\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/devices/list\";\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\n// === Filter: deviceName contains '-RDS-' ===\nmsg.payload = {\n  filter: {},\n  sort: [],\n  page: {\n    offset: 0,\n    length: 1000\n  }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 1460,
        "wires": [
            [
                "f5242cf8be6126ec"
            ]
        ]
    },
    {
        "id": "f5242cf8be6126ec",
        "type": "http request",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 730,
        "y": 1460,
        "wires": [
            [
                "1d9bba7efacde727"
            ]
        ]
    },
    {
        "id": "9a69ec91a312a8e5",
        "type": "http in",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "url": "/important",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 1720,
        "wires": [
            [
                "3aeda528d60a2c4c"
            ]
        ]
    },
    {
        "id": "3aeda528d60a2c4c",
        "type": "template",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en-GB\">\n\n<head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <title>Phishing Simulation – Next Steps</title>\n    <style>\n        :root {\n            --bg: #0f172a;\n            --card: #111827;\n            --text: #e5e7eb;\n            --muted: #9ca3af;\n            --brand: #2563eb;\n            --brand-700: #1d4ed8;\n            --warn: #f59e0b;\n            --danger: #ef4444;\n            --ok: #22c55e;\n            --border: #1f2937;\n        }\n\n        * {\n            box-sizing: border-box\n        }\n\n        body {\n            margin: 0;\n            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;\n            background: radial-gradient(1200px 800px at 70% -10%, rgba(37, 99, 235, 0.15), transparent 60%), var(--bg);\n            color: var(--text);\n            line-height: 1.6;\n            display: grid;\n            min-height: 100svh;\n            place-items: center;\n            padding: 2rem;\n        }\n\n        width:100%;\n        max-width:720px;\n        background:linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0)),\n        var(--card);\n        border:1px solid var(--border);\n        border-radius:16px;\n        padding:2rem;\n        box-shadow:0 20px 50px rgba(0, 0, 0, 0.35),\n        0 0 0 1px rgba(255, 255, 255, 0.03) inset;\n        }\n\n        header {\n            display: flex;\n            gap: 1rem;\n            align-items: center;\n            margin-bottom: 1rem;\n        }\n\n        .badge {\n            width: 52px;\n            height: 52px;\n            display: grid;\n            place-items: center;\n            border-radius: 12px;\n            background: linear-gradient(145deg, rgba(245, 158, 11, 0.25), rgba(239, 68, 68, 0.25));\n            border: 1px solid rgba(245, 158, 11, 0.35);\n            position: relative;\n            overflow: hidden;\n        }\n\n        .badge .icon {\n            font-size: 1.6rem;\n            line-height: 1;\n            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));\n            animation: pulse 2.2s ease-in-out infinite;\n        }\n\n        @keyframes pulse {\n\n            0%,\n            100% {\n                transform: scale(1);\n                opacity: 1\n            }\n\n            50% {\n                transform: scale(1.08);\n                opacity: 0.9\n            }\n        }\n\n        h1 {\n            margin: 0;\n            font-size: 1.6rem;\n            letter-spacing: 0.2px;\n        }\n\n        .subtle {\n            color: var(--muted);\n            margin: 0.15rem 0 0.75rem 0;\n        }\n\n        .alert {\n            border: 1px solid rgba(239, 68, 68, 0.35);\n            background: linear-gradient(180deg, rgba(239, 68, 68, 0.10), rgba(239, 68, 68, 0.05));\n            color: #fecaca;\n            padding: 0.9rem 1rem;\n            border-radius: 10px;\n            margin: 1rem 0 1.25rem 0;\n        }\n\n        .grid {\n            display: grid;\n            gap: 1rem;\n            grid-template-columns: 1fr;\n        }\n\n        @media (min-width:700px) {\n            .grid {\n                grid-template-columns: 1.2fr .8fr\n            }\n        }\n\n        .panel {\n            border: 1px solid var(--border);\n            border-radius: 12px;\n            background: rgba(255, 255, 255, 0.02);\n            padding: 1rem 1.1rem;\n        }\n\n        .panel h2 {\n            font-size: 1.05rem;\n            margin: 0 0 .4rem 0;\n        }\n\n        ul {\n            margin: .25rem 0 0 1.1rem;\n            padding: 0\n        }\n\n        li {\n            margin: .35rem 0\n        }\n\n        .cta {\n            display: flex;\n            flex-wrap: wrap;\n            gap: .6rem;\n            margin-top: 1.1rem\n        }\n\n        .btn {\n            appearance: none;\n            border: none;\n            cursor: pointer;\n            background: var(--brand);\n            color: white;\n            font-weight: 600;\n            padding: .8rem 1rem;\n            border-radius: 10px;\n            text-decoration: none;\n            display: inline-flex;\n            align-items: center;\n            gap: .5rem;\n            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);\n            transition: transform .08s ease, background .2s ease, box-shadow .2s ease;\n        }\n\n        .btn:hover {\n            background: var(--brand-700);\n            transform: translateY(-1px)\n        }\n\n        .meta {\n            margin-top: 1rem;\n            font-size: .95rem;\n            color: var(--muted)\n        }\n\n        .tips li::marker {\n            color: var(--ok)\n        }\n\n        footer {\n            margin-top: 1.25rem;\n            color: var(--muted);\n            font-size: .9rem\n        }\n    </style>\n</head>\n\n<body>\n    <main class=\"card\" role=\"region\" aria-labelledby=\"title\">\n        <header>\n            <div class=\"badge\" aria-hidden=\"true\">\n                <div class=\"icon\">⚠️</div>\n            </div>\n            <div>\n                <h1 id=\"title\">Phishing Simulation – Action Required</h1>\n                <p class=\"subtle\">Thanks for participating in our security programme. This was a safe test designed to\n                    strengthen our defences.</p>\n            </div>\n        </header>\n\n        <div class=\"alert\" role=\"alert\" aria-live=\"polite\">\n            You clicked a link in a simulated phishing email. There’s no risk to your device or data—this was training.\n        </div>\n\n        <section class=\"grid\" aria-label=\"Next steps and information\">\n            <div class=\"panel\">\n                <h2>What happens next</h2>\n                <ul>\n                    <li><strong>Mandatory training:</strong> You’ll be enrolled on the <em>Phishing Awareness</em>\n                        course to sharpen your spotting skills.</li>\n                    <li><strong>Duration:</strong> ~2 hours, mandatory, self‑paced.</li>\n                    <li><strong>Deadline:</strong> You’ll receive your completion date shortly via email.</li>\n                    <li><strong>Delivery:</strong> Look out for an enrolment email with your unique link and\n                        instructions.</li>\n                </ul>\n                <div class=\"cta\">\n                    #\n                    🎯 Training link (coming soon)\n                    </a>\n                </div>\n            </div>\n\n            <div class=\"panel\">\n                <h2>Why this matters</h2>\n                <ul class=\"tips\">\n                    <li>Attackers rely on urgency and curiosity—pausing for a moment is powerful.</li>\n                    <li>Hover over links and check the sender before clicking.</li>\n                    <li>When in doubt, <strong>report the email</strong> using the “Report Phishing” button in Outlook.\n                    </li>\n                </ul>\n                <div class=\"meta\">Completing the course improves our organisation’s security posture and protects\n                    colleagues and customers.</div>\n            </div>\n        </section>\n\n        <footer>\n            Building a strong security culture is a team effort—thanks for doing your part. You’ll hear from us shortly\n            with the training details.\n        </footer>\n    </main>\n</body>\n\n</html>",
        "output": "str",
        "x": 420,
        "y": 1720,
        "wires": [
            [
                "e54e0c7c2e5e0ac8"
            ]
        ]
    },
    {
        "id": "e54e0c7c2e5e0ac8",
        "type": "http response",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 570,
        "y": 1720,
        "wires": []
    },
    {
        "id": "74cdf10dd00b07d5",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 1820,
        "wires": [
            [
                "2dc8959e0c916c4f"
            ]
        ]
    },
    {
        "id": "2dc8959e0c916c4f",
        "type": "MSSQL",
        "z": "3bdea1b6503b06dc",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "select top 3 *\r\n\r\nfrom aa.SugarApiQueue_Items",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 450,
        "y": 1860,
        "wires": [
            [
                "99e187e92115fcd4"
            ]
        ]
    },
    {
        "id": "99e187e92115fcd4",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 34",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 530,
        "y": 1980,
        "wires": []
    },
    {
        "id": "43c71a04452201cd",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 47",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 520,
        "y": 2340,
        "wires": []
    },
    {
        "id": "ae302b5fac4895c7",
        "type": "inject",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "x": 140,
        "y": 1580,
        "wires": [
            [
                "b8f4777387cb78e0"
            ]
        ]
    },
    {
        "id": "b8f4777387cb78e0",
        "type": "subflow:c4217fb89f6015dc",
        "z": "3bdea1b6503b06dc",
        "name": "",
        "x": 320,
        "y": 1580,
        "wires": [
            [
                "d715ec3ea672d470"
            ]
        ]
    },
    {
        "id": "d715ec3ea672d470",
        "type": "debug",
        "z": "3bdea1b6503b06dc",
        "name": "debug 48",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 480,
        "y": 1580,
        "wires": []
    },
    {
        "id": "a9261162fe5dd454",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "Calculate Superseded",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "WITH processes AS (\r\n    SELECT \r\n        p.bot_id, \r\n        MAX(p.id) AS last_process\r\n    FROM aa.process_logs AS p\r\n    WHERE p.type = 'L'\r\n    GROUP BY p.bot_id\r\n),\r\nactions AS (\r\n    SELECT \r\n        a.process_id, \r\n        p.bot_id, \r\n        MAX(a.date_time) AS last_action\r\n    FROM aa.action_logs AS a\r\n    INNER JOIN processes AS p \r\n        ON p.last_process = a.process_id\r\n    GROUP BY a.process_id, p.bot_id\r\n),\r\nbot_latest AS (\r\n    SELECT\r\n        p.bot_id,\r\n        p.last_process,\r\n        MAX(ac.last_action) AS last_action\r\n    FROM processes p\r\n    LEFT JOIN actions ac ON p.bot_id = ac.bot_id\r\n    GROUP BY p.bot_id, p.last_process\r\n),\r\nalerts_to_resolve AS (\r\n    SELECT \r\n        n.id,\r\n        n.breach_type,\r\n        -- Determine which rule matched\r\n        CASE \r\n            WHEN n.breach_type = 'ACTION_STALLED'\r\n                 AND bl.last_action IS NOT NULL\r\n                 AND bl.last_action > n.breach_started\r\n                THEN 1\r\n            ELSE 0\r\n        END AS resolved_by_action,\r\n        CASE \r\n            WHEN n.breach_type IN ('RUNTIME_EXCEEDED', 'CRITICAL_MISSED')\r\n                 AND bl.last_process > n.process_id\r\n                THEN 1\r\n            ELSE 0\r\n        END AS resolved_by_deployment,\r\n        CASE\r\n            WHEN n.breach_type = 'UNCLEAN_EXIT'\r\n                 AND EXISTS (\r\n                     SELECT 1\r\n                     FROM aa.watchdog_notifications n2\r\n                     WHERE n2.bot_id = n.bot_id\r\n                       AND n2.process_id = n.process_id\r\n                       AND n2.breach_type = 'CRITICAL_MISSED'\r\n                       AND n2.resolved_at IS NULL\r\n                 )\r\n            THEN 1 ELSE 0 END AS resolved_by_critical,\r\n        -- Add general superseded rule for any older process\r\n        CASE\r\n            WHEN bl.last_process > n.process_id\r\n                THEN 1\r\n            ELSE 0\r\n        END AS resolved_by_newer_process\r\n    FROM aa.watchdog_notifications n\r\n    LEFT JOIN bot_latest bl ON n.bot_id = bl.bot_id\r\n    WHERE\r\n        (\r\n            (\r\n                n.breach_type = 'ACTION_STALLED'\r\n                AND bl.last_action IS NOT NULL\r\n                AND bl.last_action > n.breach_started\r\n            )\r\n            OR\r\n            (\r\n                n.breach_type IN ('RUNTIME_EXCEEDED', 'CRITICAL_MISSED')\r\n                AND bl.last_process > n.process_id\r\n            )\r\n            OR (\r\n                n.breach_type = 'UNCLEAN_EXIT'\r\n                AND EXISTS (\r\n                    SELECT 1\r\n                    FROM aa.watchdog_notifications n2\r\n                    WHERE n2.bot_id = n.bot_id\r\n                      AND n2.process_id = n.process_id\r\n                      AND n2.breach_type = 'CRITICAL_MISSED'\r\n                      AND n2.resolved_at IS NULL\r\n                )\r\n            )\r\n            OR (\r\n                -- General rule: any notification for older process should be superseded\r\n                bl.last_process > n.process_id\r\n            )\r\n        )\r\n        AND ISNULL(n.superseded, 0) <> 1\r\n)\r\nUPDATE n\r\nSET \r\n    superseded = 1,\r\n    resolved_user = 'watchdog',\r\n    resolved_at = GETDATE(),\r\n    resolved_category = 'SUPERSEDED',\r\n    notes = CASE\r\n        WHEN ar.resolved_by_action = 1\r\n            THEN 'Issue resolved by recent action log activity'\r\n        WHEN ar.resolved_by_deployment = 1\r\n            THEN 'Issue resolved by latest deployment'\r\n        WHEN ar.resolved_by_critical = 1\r\n            THEN 'Superseded: escalated to CRITICAL_MISSED alert'\r\n        WHEN ar.resolved_by_newer_process = 1\r\n            THEN 'Superseded: newer process deployed'\r\n        ELSE n.notes -- fallback; should not happen\r\n    END\r\nFROM aa.watchdog_notifications n\r\nINNER JOIN alerts_to_resolve ar\r\n    ON n.id = ar.id;",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 660,
        "y": 160,
        "wires": [
            [
                "3f5318ef7c87cbf6"
            ]
        ]
    },
    {
        "id": "3f5318ef7c87cbf6",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "Get Current Breaches",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "WITH last_action_by_process AS (\r\n  SELECT\r\n    b.id AS bot_id,\r\n    a.process_id,\r\n    MAX(a.date_time) AS last_action\r\n  FROM aa.action_logs AS a\r\n  INNER JOIN aa.process_logs AS p\r\n    ON p.id = a.process_id\r\n   AND p.type = 'L'\r\n  INNER JOIN aa.bots AS b\r\n    ON b.id = p.bot_id\r\n   AND b.deleted = 0\r\n  GROUP BY\r\n    b.id,\r\n    a.process_id\r\n),\r\n\r\nprocess_with_timestamps AS (\r\n  SELECT\r\n    b.id AS bot_id,\r\n    p.id AS process_id,\r\n    v.max_ts AS last_action_time,\r\n    p.status,\r\n    p.start_time\r\n  FROM aa.process_logs AS p\r\n  INNER JOIN aa.bots AS b\r\n    ON b.id = p.bot_id\r\n   AND b.deleted = 0\r\n   AND p.type = 'L'\r\n   AND ISNULL(p.status,'') != 'par'\r\n  LEFT JOIN last_action_by_process AS la\r\n    ON la.bot_id     = b.id\r\n   AND la.process_id = p.id\r\n  CROSS APPLY (\r\n    SELECT MAX(ts) AS max_ts\r\n    FROM ( VALUES\r\n      (p.start_time),\r\n      (p.end_time),\r\n      (la.last_action)\r\n    ) AS T(ts)\r\n  ) AS v\r\n),\r\n\r\nranked_per_bot AS (\r\n  SELECT\r\n    bot_id,\r\n    process_id,\r\n    CAST(last_action_time AS DATETIME) as last_action_time,\r\n    status,\r\n    start_time,\r\n    ROW_NUMBER() OVER (\r\n      PARTITION BY bot_id\r\n      ORDER BY process_id DESC\r\n    ) AS rn\r\n  FROM process_with_timestamps\r\n),\r\n\r\nthreshold_checks AS (\r\n  SELECT\r\n    rb.bot_id,\r\n    rb.process_id AS latest_process_id,\r\n    rb.last_action_time,\r\n    b.bot_name_calculated as 'bot_name',\r\n    rb.start_time,\r\n    rb.status,\r\n    b.receives_notifications,\r\n    b.notification_minutes_trigger,\r\n    b.expected_runtime_minutes,\r\n    b.expected_frequency_hours,\r\n    b.hours_until_critical,\r\n    DATEDIFF(MINUTE, rb.start_time, rb.last_action_time) AS elapsed_minutes,\r\n    DATEDIFF(MINUTE, rb.last_action_time, GETDATE()) AS minutes_since_last_action,\r\n\r\n    CASE\r\n      WHEN DATEDIFF(HOUR, rb.last_action_time, GETDATE()) > b.hours_until_critical\r\n        THEN 'CRITICAL_MISSED'\r\n      WHEN rb.status IS NULL\r\n       AND DATEDIFF(MINUTE, rb.start_time, GETDATE()) > b.expected_runtime_minutes\r\n        THEN 'CHECK-RUNTIME_EXCEEDED'\r\n      WHEN rb.status IS NULL\r\n       AND DATEDIFF(MINUTE, rb.last_action_time, GETDATE()) > b.notification_minutes_trigger\r\n        THEN 'CHECK-ACTION_STALLED'\r\n      WHEN rb.status IS NOT NULL\r\n       AND DATEDIFF(HOUR, rb.start_time, GETDATE()) > b.expected_frequency_hours\r\n        THEN 'MISSED_DEPLOYMENT'\r\n      ELSE 'OK'\r\n    END AS breach_status,\r\n\r\n    CONCAT('TRIGGERED BY: ',\r\n      CASE\r\n        WHEN DATEDIFF(HOUR, rb.last_action_time, GETDATE()) > b.hours_until_critical\r\n          THEN CONCAT('Last action was ', DATEDIFF(HOUR, rb.last_action_time, GETDATE()), 'h ago (threshold ', b.hours_until_critical, 'h)')\r\n        WHEN rb.status IS NULL AND DATEDIFF(MINUTE, rb.start_time, GETDATE()) > b.expected_runtime_minutes\r\n          THEN CONCAT('Process started ', DATEDIFF(MINUTE, rb.start_time, GETDATE()), 'm ago (allowed ', b.expected_runtime_minutes, 'm)')\r\n        WHEN rb.status IS NULL AND DATEDIFF(MINUTE, rb.last_action_time, GETDATE()) > b.notification_minutes_trigger\r\n          THEN CONCAT('Last action ', DATEDIFF(MINUTE, rb.last_action_time, GETDATE()), 'm ago (notify after ', b.notification_minutes_trigger, 'm)')\r\n        WHEN rb.status IS NOT NULL AND DATEDIFF(HOUR, rb.start_time, GETDATE()) > b.expected_frequency_hours\r\n          THEN CONCAT('Last run completed; started ', DATEDIFF(HOUR, rb.start_time, GETDATE()), 'h ago (expected every ', b.expected_frequency_hours, 'h)')\r\n        ELSE 'All within expected thresholds'\r\n      END\r\n    ) AS breach_reason,\r\n\r\n    CASE\r\n      WHEN DATEDIFF(HOUR, rb.last_action_time, GETDATE()) > b.hours_until_critical\r\n        THEN CAST(DATEADD(HOUR, b.hours_until_critical, rb.last_action_time) AS datetime)\r\n      WHEN rb.status IS NULL\r\n       AND DATEDIFF(MINUTE, rb.start_time, GETDATE()) > b.expected_runtime_minutes\r\n        THEN CAST(DATEADD(MINUTE, b.expected_runtime_minutes, rb.start_time) AS datetime)\r\n      WHEN rb.status IS NULL\r\n       AND DATEDIFF(MINUTE, rb.last_action_time, GETDATE()) > b.notification_minutes_trigger\r\n        THEN CAST(DATEADD(MINUTE, b.notification_minutes_trigger, rb.last_action_time) AS datetime)\r\n      WHEN rb.status IS NOT NULL\r\n       AND DATEDIFF(HOUR, rb.start_time, GETDATE()) > b.expected_frequency_hours\r\n        THEN CAST(DATEADD(HOUR, b.expected_frequency_hours, rb.start_time) AS datetime)\r\n      ELSE CAST(NULL AS datetime)\r\n    END AS breach_started\r\n\r\n  FROM ranked_per_bot AS rb\r\n  JOIN aa.bots AS b ON b.id = rb.bot_id\r\n  WHERE rb.rn = 1 AND b.receives_notifications = 1\r\n),\r\n\r\npriority_mapping AS (\r\n  SELECT breach_type, priority_level FROM (VALUES\r\n    ('CRITICAL_MISSED', 1),\r\n    ('UNCLEAN_EXIT', 2), \r\n    ('MISSED_DEPLOYMENT', 3),\r\n    ('RUNTIME_EXCEEDED', 4),\r\n    ('ACTION_STALLED', 5)\r\n  ) AS p(breach_type, priority_level)\r\n)\r\n\r\nSELECT c.*, wn.id AS existing_notification_id, wn.breach_type AS existing_breach\r\nFROM threshold_checks AS c\r\nLEFT JOIN aa.watchdog_notifications AS wn \r\n  ON wn.process_id = c.latest_process_id\r\n  AND ISNULL(wn.resolved_at, '') = ''\r\n  AND ISNULL(wn.superseded, 0) = 0\r\nLEFT JOIN priority_mapping pm_current \r\n  ON REPLACE(c.breach_status, 'CHECK-', '') = pm_current.breach_type\r\nLEFT JOIN priority_mapping pm_existing \r\n  ON wn.breach_type = pm_existing.breach_type\r\nWHERE \r\n  c.breach_status != 'OK'\r\n  AND NOT EXISTS (\r\n    SELECT 1 FROM aa.watchdog_notifications AS prev\r\n    WHERE prev.process_id = c.latest_process_id\r\n      AND prev.breach_type = REPLACE(c.breach_status, 'CHECK-', '')\r\n      AND prev.resolved_at IS NOT NULL\r\n      AND c.breach_started <= prev.resolved_at\r\n  )\r\n  AND (\r\n    wn.id IS NULL\r\n    OR (\r\n      wn.breach_type != 'CRITICAL_MISSED'\r\n      AND (\r\n        pm_current.priority_level <= pm_existing.priority_level\r\n        AND (\r\n          REPLACE(c.breach_status, 'CHECK-', '') != wn.breach_type\r\n          OR (\r\n            REPLACE(c.breach_status, 'CHECK-', '') = wn.breach_type\r\n            AND c.breach_status LIKE 'CHECK-%'\r\n          )\r\n        )\r\n      )\r\n    )\r\n  )\r\n",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 880,
        "y": 160,
        "wires": [
            [
                "f9c8d65238c76426"
            ]
        ]
    },
    {
        "id": "f9c8d65238c76426",
        "type": "change",
        "z": "cfcf0d8f65cecaa7",
        "name": "Capture Breaches",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "breaches",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1100,
        "y": 160,
        "wires": [
            [
                "ec605ca6b6e9a61f"
            ]
        ]
    },
    {
        "id": "ec605ca6b6e9a61f",
        "type": "function",
        "z": "cfcf0d8f65cecaa7",
        "name": "Prepare SQL",
        "func": "function formatDate(dateValue) {\n    if (!dateValue) return null;\n    let d = new Date(dateValue);\n    return d.toISOString().replace('T', ' ').substring(0, 19);\n}\n\nfunction escapeString(str) {\n    return (str || '').replace(/'/g, \"''\");\n}\n\nfor (let i = 0; i < msg.breaches.length; i++) {\n    let breach = msg.breaches[i];\n\n    // Assign variables for readability\n    let bot_id = breach.bot_id;\n    let latest_process_id = breach.latest_process_id;\n    let last_action_time = breach.last_action_time;\n    let bot_name = breach.bot_name;\n    let start_time = breach.start_time;\n    let status = breach.status;\n    let receives_notifications = breach.receives_notifications;\n    let notification_minutes_trigger = breach.notification_minutes_trigger;\n    let expected_runtime_minutes = breach.expected_runtime_minutes;\n    let expected_frequency_hours = breach.expected_frequency_hours;\n    let hours_until_critical = breach.hours_until_critical;\n    let elapsed_minutes = breach.elapsed_minutes;\n    let minutes_since_last_action = breach.minutes_since_last_action;\n    let breach_status = breach.breach_status;\n    let breach_reason = breach.breach_reason;\n    let existing_breach = breach.existing_breach;\n    let existing_notification_id = breach.existing_notification_id\n    let breach_started = breach.breach_started;\n\n    // Format dates for SQL\n    let sql_start_time = formatDate(start_time);\n    let sql_breach_started = formatDate(breach_started);\n\n    // Escape string values for SQL\n    let sql_breach_reason = escapeString(breach_reason);\n    let sql_existing_breach = escapeString(existing_breach);\n\n    // Check if alert is new or escallation\n    let isNew\n    if (existing_breach === null) {\n        isNew = true\n    } else {\n        isNew = false\n    }\n\n\n    let needsCheck = false;\n    if (breach_status && breach_status.startsWith('CHECK-')) {\n        needsCheck = true;\n        breach_status = breach_status.substring(6); // removes the 'CHECK_' prefix\n    }\n\n\n    let sql\n    if (isNew){ \n        sql = `\n            INSERT INTO aa.watchdog_notifications (\n                bot_id,\n                process_id,\n                process_started,\n                breach_type,\n                breach_started,\n                notes\n            ) VALUES (\n                ${Number(bot_id)},\n                ${Number(latest_process_id)},\n                '${sql_start_time}',\n                '${breach_status}',\n                '${sql_breach_started}',\n                '${sql_breach_reason}'\n            )\n        `;\n    } else {\n        sql = `\n            UPDATE aa.watchdog_notifications\n            SET breach_type = '${breach_status}',\n                breach_started = '${sql_breach_started}',\n                notes = '${breach_status} upgraded from ${sql_existing_breach}'\n            WHERE id = ${existing_notification_id}\n        `;\n    }\n\n\n\n\n\n\n    node.send({ \"sql\":sql, \"isNew\": isNew, \"needsCheck\": needsCheck, \"existing_breach\": existing_breach, \"this_breach\": breach_status, \"bot_name\": bot_name, alertStatus: \"active\" });\n}\n\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 160,
        "wires": [
            [
                "a4ba76561ea93f34",
                "3be1ce7681c0d01e"
            ]
        ]
    },
    {
        "id": "a4ba76561ea93f34",
        "type": "debug",
        "z": "cfcf0d8f65cecaa7",
        "name": "debug 11",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1490,
        "y": 80,
        "wires": []
    },
    {
        "id": "3be1ce7681c0d01e",
        "type": "delay",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1500,
        "y": 160,
        "wires": [
            [
                "84fec56a01c070af"
            ]
        ]
    },
    {
        "id": "84fec56a01c070af",
        "type": "switch",
        "z": "cfcf0d8f65cecaa7",
        "name": "NeedsCheck",
        "property": "needsCheck",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1680,
        "y": 160,
        "wires": [
            [
                "28679fc47e986142"
            ],
            [
                "a56048953ae88af0"
            ]
        ]
    },
    {
        "id": "28679fc47e986142",
        "type": "function",
        "z": "cfcf0d8f65cecaa7",
        "name": "Prepare new-token request",
        "func": "const USERNAME = \"botrunner25\";\nconst PASSWORD = \"Welcome@2021\";\nmsg.url = `https://inspired-1.my.automationanywhere.digital/v2/authentication`\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\" };\nmsg.payload = { username: USERNAME, password: PASSWORD, multiLogin: true };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2070,
        "y": 40,
        "wires": [
            [
                "b4a820ede67fd11c"
            ]
        ]
    },
    {
        "id": "a56048953ae88af0",
        "type": "delay",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2600,
        "y": 160,
        "wires": [
            [
                "3ecc2d61216d1cd0"
            ]
        ]
    },
    {
        "id": "b4a820ede67fd11c",
        "type": "http request",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2300,
        "y": 40,
        "wires": [
            [
                "f8df0c31af4e671d"
            ]
        ]
    },
    {
        "id": "de4d98039d114691",
        "type": "function",
        "z": "cfcf0d8f65cecaa7",
        "name": "Analyse against live CR",
        "func": "let running = msg.running_bots?.list || [];\nlet activeBotNames = new Set(running.map(bot => bot.fileName));\nmsg.test = activeBotNames\n// Check if msg.bot_name is in the set\nif (activeBotNames.has(msg.bot_name)) {\n    // bot is running\n    if (msg.isNew) {\n        // New notification - still insert it to track the issue\n        return msg;\n    } else {\n        if (msg.alertStatus === \"nonactive\"){\n            return null;\n        }\n        if (msg.this_breach == msg.existing_breach){\n            // Existing notification and bot still running - no action needed\n            return null;\n        } else {\n            return msg;\n        }\n    }\n} else {\n    if (msg.alertStatus === \"active\"){\n        // bot is not running - upgrade to UNCLEAN_EXIT\n        msg.sql = msg.sql.replace(msg.this_breach, 'UNCLEAN_EXIT');\n    } else {\n        // bot is no longer triggering alerts, and is not currently running\n        msg.sql = `UPDATE aa.watchdog_notifications SET superseded = 1, resolved_at = getdate(), resolved_category = 'SUPERSEDED', notes = 'Process eventually ended cleanly' WHERE id = ${msg.id};`\n    }\n    return msg;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3130,
        "y": 40,
        "wires": [
            [
                "a56048953ae88af0",
                "80dd02264c39e494"
            ]
        ]
    },
    {
        "id": "3ecc2d61216d1cd0",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "sql",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 2810,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "f8df0c31af4e671d",
        "type": "function",
        "z": "cfcf0d8f65cecaa7",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2510,
        "y": 40,
        "wires": [
            [
                "14fce65c7936323f"
            ]
        ]
    },
    {
        "id": "da2f68af793b2cf0",
        "type": "change",
        "z": "cfcf0d8f65cecaa7",
        "name": "Store Running Bots",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "running_bots",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2880,
        "y": 40,
        "wires": [
            [
                "de4d98039d114691"
            ]
        ]
    },
    {
        "id": "14fce65c7936323f",
        "type": "http request",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2700,
        "y": 40,
        "wires": [
            [
                "da2f68af793b2cf0"
            ]
        ]
    },
    {
        "id": "a0b7b55f1381e353",
        "type": "inject",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "120",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 110,
        "y": 160,
        "wires": [
            [
                "d9273b05d8788b3d"
            ]
        ]
    },
    {
        "id": "3286e6e5b3ad92ec",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "Heartbeat",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "UPDATE aa.heartbeat\r\nSET heartbeat_timestamp = getdate()\r\nWHERE heartbeat_name = 'watchdog'",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 780,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "fd1baf7902c03d26",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "Check for stalled/excessive entries",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT wn.id, b.bot_name_calculated as 'bot_name'\r\nFROM aa.watchdog_notifications wn\r\nINNER JOIN aa.bots as b ON b.id = wn.bot_id\r\nWHERE resolved_at IS NULL\r\nAND superseded = 0\r\nAND breach_type IN ('RUNTIME_EXCEEDED', 'ACTION_STALLED')",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 940,
        "y": 220,
        "wires": [
            [
                "bdcbc65a7bcee850"
            ]
        ]
    },
    {
        "id": "bdcbc65a7bcee850",
        "type": "function",
        "z": "cfcf0d8f65cecaa7",
        "name": "Parse/split SQL results",
        "func": "// Get the entries from the incoming message payload\nconst entries = msg.payload;\n\n// Loop over each entry in the array\nfor (let i = 0; i < entries.length; i++) {\n    const entry = entries[i];\n    // Create a new message for each entry\n    let newMsg = {\n\n            id: entry.id,\n            bot_name: entry.bot_name,\n            alertStatus: \"nonactive\",\n            needsCheck: true,\n            isNew: false\n\n    };\n    // Send the new message\n    node.send(newMsg);\n}\n\n// Return null so the original message isn't passed on\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 220,
        "wires": [
            [
                "3be1ce7681c0d01e"
            ]
        ]
    },
    {
        "id": "016c595e18f54198",
        "type": "delay",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 620,
        "y": 80,
        "wires": [
            [
                "3286e6e5b3ad92ec"
            ]
        ]
    },
    {
        "id": "ed5e80c9f99902de",
        "type": "delay",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 620,
        "y": 220,
        "wires": [
            [
                "fd1baf7902c03d26"
            ]
        ]
    },
    {
        "id": "5451d619f8d42f21",
        "type": "inject",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 700,
        "y": 280,
        "wires": [
            [
                "fd1baf7902c03d26"
            ]
        ]
    },
    {
        "id": "80dd02264c39e494",
        "type": "MSSQL",
        "z": "cfcf0d8f65cecaa7",
        "mssqlCN": "4159b2383138607d",
        "name": "Delete Clean Ends",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "DELETE FROM aa.watchdog_notifications\r\nWHERE id in (\r\nSELECT w.id\r\nFROM aa.watchdog_notifications as w\r\nINNER JOIN aa.process_logs as p on p.id = w.process_id\r\ninner join aa.bots as b on b.id = p.bot_id\r\nWHERE w.breach_type = 'UNCLEAN_EXIT'\r\nAND p.status = 'Pass'\r\n)",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 3390,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "74a5bcaf4e6f8008",
        "type": "inject",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 3180,
        "y": 100,
        "wires": [
            [
                "80dd02264c39e494"
            ]
        ]
    },
    {
        "id": "d9273b05d8788b3d",
        "type": "subflow:c4217fb89f6015dc",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "x": 280,
        "y": 160,
        "wires": [
            [
                "1020601fcf5be673"
            ]
        ]
    },
    {
        "id": "1020601fcf5be673",
        "type": "switch",
        "z": "cfcf0d8f65cecaa7",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 385,
        "y": 160,
        "wires": [
            [
                "016c595e18f54198",
                "a9261162fe5dd454",
                "ed5e80c9f99902de"
            ]
        ],
        "l": false
    },
    {
        "id": "7028c4e28a4f7512",
        "type": "inject",
        "z": "238bdd166ab1d860",
        "name": "Nodered Heartbeat 1 minute interval",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 210,
        "y": 120,
        "wires": [
            [
                "50d41774880ac647"
            ]
        ]
    },
    {
        "id": "61c8de354ebc9fa8",
        "type": "MSSQL",
        "z": "238bdd166ab1d860",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 880,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "e509a227dae781f4",
        "type": "http in",
        "z": "238bdd166ab1d860",
        "name": "",
        "url": "/check_heartbeats",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 280,
        "wires": [
            [
                "db24c547853a3112",
                "59d74c9774b9a1dd"
            ]
        ]
    },
    {
        "id": "db24c547853a3112",
        "type": "MSSQL",
        "z": "238bdd166ab1d860",
        "mssqlCN": "4159b2383138607d",
        "name": "Run Query",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT\r\n    id,\r\n    heartbeat_name,\r\n    heartbeat_timestamp,\r\n    heartbeat_expected_interval_minutes,\r\n    heartbeat_notified_time,\r\n    heartbeat_notification_interval_minutes,\r\n\theartbeat_notification_recipient,\r\n    CAST(\r\n      'A heartbeat failure has been detected for ' \r\n      + heartbeat_name \r\n      + '. Last heartbeat was registered ' \r\n      + CAST(DATEDIFF(MINUTE, heartbeat_timestamp, GETUTCDATE()) AS VARCHAR(10)) \r\n      + ' minutes ago, having an expected frequency of ' \r\n      + CAST(heartbeat_expected_interval_minutes AS VARCHAR(10)) \r\n      + ' minutes. Another notification will be issued at ' \r\n      + CONVERT(VARCHAR(19), DATEADD(\r\n          MINUTE, \r\n          heartbeat_notification_interval_minutes, \r\n          GETDATE()\r\n        ), 120)\r\n      + ' if the issue is not resolved.'\r\n    AS VARCHAR(MAX)) AS NotificationMessage\r\nFROM aa.heartbeat\r\nWHERE enabled = 1\r\n  -- heartbeat interval breached and at least 5 minutes beyond that breach (all in UTC)\r\n  AND DATEADD(\r\n        MINUTE,\r\n        heartbeat_expected_interval_minutes + 5,\r\n        heartbeat_timestamp\r\n      ) < GETUTCDATE()\r\n  -- never notified, or last notification (in UTC) outside the suppression window\r\n  AND (\r\n       heartbeat_notified_time IS NULL\r\n    OR DATEADD(\r\n          MINUTE,\r\n          heartbeat_notification_interval_minutes,\r\n          heartbeat_notified_time\r\n       ) < GETUTCDATE()\r\n  );\r\n",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 410,
        "y": 280,
        "wires": [
            [
                "521c03fec35dc2b8"
            ]
        ]
    },
    {
        "id": "521c03fec35dc2b8",
        "type": "http response",
        "z": "238bdd166ab1d860",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 590,
        "y": 280,
        "wires": []
    },
    {
        "id": "fac5cd1681d12c2a",
        "type": "comment",
        "z": "238bdd166ab1d860",
        "name": "Add a timestamp to Jupiter at 1 minute intervals",
        "info": "",
        "x": 220,
        "y": 60,
        "wires": []
    },
    {
        "id": "59d74c9774b9a1dd",
        "type": "debug",
        "z": "238bdd166ab1d860",
        "name": "debug 15",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 370,
        "y": 360,
        "wires": []
    },
    {
        "id": "50d41774880ac647",
        "type": "exec",
        "z": "238bdd166ab1d860",
        "command": "hostname",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": true,
        "oldrc": false,
        "name": "",
        "x": 480,
        "y": 120,
        "wires": [
            [
                "905e469f0c294318"
            ],
            [],
            []
        ]
    },
    {
        "id": "905e469f0c294318",
        "type": "function",
        "z": "238bdd166ab1d860",
        "name": "Construct SQL",
        "func": "const hostname = msg.payload.trim()\nconst sql = `\nMERGE aa.heartbeat AS target\nUSING (SELECT 'nodered_${hostname}' AS heartbeat_name) AS source\nON target.heartbeat_name = source.heartbeat_name\nWHEN MATCHED THEN\n    UPDATE SET heartbeat_timestamp = GETUTCDATE()\nWHEN NOT MATCHED THEN\n    INSERT (heartbeat_name, heartbeat_timestamp)\n    VALUES (source.heartbeat_name, GETUTCDATE());\n`\nmsg.topic = sql\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 120,
        "wires": [
            [
                "61c8de354ebc9fa8"
            ]
        ]
    },
    {
        "id": "58380e6af3e558da",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 1190,
        "y": 460,
        "wires": [
            [
                "73719f9d3658725e"
            ]
        ]
    },
    {
        "id": "73719f9d3658725e",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 460,
        "wires": [
            [
                "6536ab879fba6b70"
            ]
        ]
    },
    {
        "id": "6536ab879fba6b70",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1610,
        "y": 460,
        "wires": [
            [
                "ccdd0fdedd084531"
            ]
        ]
    },
    {
        "id": "f41fd83898615296",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "bot_name",
                "pt": "msg",
                "to": "payload.bot_name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runner_username",
                "pt": "msg",
                "to": "payload.username",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 990,
        "y": 460,
        "wires": [
            [
                "58380e6af3e558da"
            ]
        ]
    },
    {
        "id": "dd91b594be817d52",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "check_if_bot_is_running",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 460,
        "wires": [
            [
                "b640808c08b610b0"
            ]
        ]
    },
    {
        "id": "ccdd0fdedd084531",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Build Response JSON",
        "func": "// Ensure bot_name, runner_username, and payload.list are present\nif (\n    !msg.bot_name ||\n    !msg.runner_username ||\n    !msg.payload ||\n    !Array.isArray(msg.payload.list)\n) {\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: false,\n            device_name: \"\",\n            user_name: \"\",\n            type: \"\",\n            bot_name: msg.bot_name\n        }\n    };\n    msg.DEBUG = 1;\n    return msg;\n}\n\n// Prepare for case‐insensitive comparison\nconst botNameLower    = msg.bot_name.toLowerCase();\nconst runnerUserLower = msg.runner_username.toLowerCase();\n\n// Find all entries with the same filename but NOT the current username\nconst otherUserMatches = msg.payload.list.filter(item =>\n    item.fileName &&\n    item.fileName.toLowerCase() === botNameLower &&\n    item.userName &&\n    item.userName.toLowerCase() !== runnerUserLower\n);\n\nif (otherUserMatches.length > 0) {\n    // Found another user running it\n    const firstMatch = otherUserMatches[0];\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: true,\n            device_name: firstMatch.deviceName || \"\",\n            user_name: firstMatch.userName || \"\",\n            type: firstMatch.type || \"\",\n            bot_name: msg.bot_name\n        }\n    };\n    msg.DEBUG = 3;\n} else {\n    // No one else is running it (could still be current user!)\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: false,\n            device_name: \"\",\n            user_name: \"\",\n            type: \"\",\n            bot_name: msg.bot_name\n        }\n    };\n    msg.DEBUG = 2;\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1840,
        "y": 460,
        "wires": [
            [
                "9491ae2c9c8ffd7b",
                "d52dbdff62338856"
            ]
        ]
    },
    {
        "id": "9491ae2c9c8ffd7b",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 2120,
        "y": 460,
        "wires": []
    },
    {
        "id": "b640808c08b610b0",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "Help Parameter?",
        "property": "payload.help",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 510,
        "y": 460,
        "wires": [
            [
                "8f10d11b7d748899"
            ],
            [
                "f5fe6ea665987314"
            ]
        ]
    },
    {
        "id": "8f10d11b7d748899",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Help Response",
        "func": "msg.payload = {\n    \"status\": \"successful\",\n    \"response\": {\n        \"input\": \"bot_name (short bot name)\",\n        \"output\": \"bot_running (true/false) | device_name (what device the bot is running on) | user_name (the user account the bot is running under) | type (deployment type, scheduled etc)\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 400,
        "wires": [
            [
                "96f02207ac66a78e"
            ]
        ]
    },
    {
        "id": "96f02207ac66a78e",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 960,
        "y": 400,
        "wires": []
    },
    {
        "id": "f5fe6ea665987314",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "bot_name parameter?",
        "property": "payload.bot_name",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 460,
        "wires": [
            [
                "f41fd83898615296"
            ],
            [
                "211d9e8b67e26c9d"
            ]
        ]
    },
    {
        "id": "211d9e8b67e26c9d",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Error Response",
        "func": "msg.payload = {\n    \"status\": \"error\",\n    \"response\": {\n        \"error_reason\": \"You must specify 'bot_name'. Pass in 'help' parameter for information on inputs / outputs\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 520,
        "wires": [
            [
                "9ee3ba089903cc7d"
            ]
        ]
    },
    {
        "id": "9ee3ba089903cc7d",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1160,
        "y": 520,
        "wires": []
    },
    {
        "id": "607318d89917fd35",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "/aa_get_token",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 220,
        "wires": [
            [
                "5b59fcc5c14157c1"
            ]
        ]
    },
    {
        "id": "5b59fcc5c14157c1",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "Help Parameter?",
        "property": "payload.help",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 430,
        "y": 220,
        "wires": [
            [
                "04bc8de4a4a96471"
            ],
            [
                "403eacf8dd97741f"
            ]
        ]
    },
    {
        "id": "04bc8de4a4a96471",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Help Response",
        "func": "msg.payload = {\n    \"status\": \"successful\",\n    \"response\": {\n        \"input\": \"environment\",\n        \"output\": \"Must be either: 'live', 'uat', or 'dev'\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 180,
        "wires": [
            [
                "4da264269c587774"
            ]
        ]
    },
    {
        "id": "4da264269c587774",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1240,
        "y": 180,
        "wires": []
    },
    {
        "id": "ba70c7b2a260b16e",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 790,
        "y": 280,
        "wires": [
            [
                "151fbf1b64e24741"
            ]
        ]
    },
    {
        "id": "403eacf8dd97741f",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "property": "payload.environment",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "empty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 610,
        "y": 280,
        "wires": [
            [
                "cfe74bf6f2706010"
            ],
            [
                "cfe74bf6f2706010"
            ],
            [
                "ba70c7b2a260b16e"
            ]
        ]
    },
    {
        "id": "cfe74bf6f2706010",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Error Response",
        "func": "msg.payload = {\n    \"status\": \"error\",\n    \"response\": {\n        \"error_reason\": \"'environment' parameter is mandatory and must be either: 'live', 'uat', or 'dev'\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 240,
        "wires": [
            [
                "4da264269c587774"
            ]
        ]
    },
    {
        "id": "151fbf1b64e24741",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Successful Response",
        "func": "const TOKEN = msg.payload.token\nmsg.payload = {\n    \"status\": \"successful\",\n    \"response\": {\n        \"token\": TOKEN\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1020,
        "y": 280,
        "wires": [
            [
                "4da264269c587774"
            ]
        ]
    },
    {
        "id": "9e409e053c2f8660",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "deploy_inboxAutomation",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 680,
        "wires": [
            [
                "6b2670b4308040c1"
            ]
        ]
    },
    {
        "id": "6cc9909079b54109",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "Is bot running?",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "localhost:1880/endpoint/check_if_bot_is_running?bot_name=TEST",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 700,
        "y": 680,
        "wires": [
            [
                "443e4d62c216c648"
            ]
        ]
    },
    {
        "id": "443e4d62c216c648",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "Bot Running?",
        "property": "payload.response.bot_running",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 900,
        "y": 680,
        "wires": [
            [
                "a1466526a9af1e10"
            ],
            [
                "6b2670b4308040c1"
            ]
        ]
    },
    {
        "id": "6b2670b4308040c1",
        "type": "delay",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 480,
        "y": 680,
        "wires": [
            [
                "6cc9909079b54109"
            ]
        ]
    },
    {
        "id": "a1466526a9af1e10",
        "type": "MSSQL",
        "z": "a90cc5d82d9a1021",
        "mssqlCN": "4159b2383138607d",
        "name": "Check for outstanding emails",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT\r\n\te.EmailID,\r\n\te.TicketID,\r\n\te.CreatedDate,\r\n\te.Sender,\r\n\te.Inbox,\r\n\tDATEDIFF(MINUTE, e.CreatedDate, GETDATE()) AS MinutesSinceCreated\r\nFROM\r\n\taa_dev.emails AS e\r\nWHERE\r\n\tQmpProcessed = 1",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1140,
        "y": 680,
        "wires": [
            [
                "c87fc1527bc95aba"
            ]
        ]
    },
    {
        "id": "c87fc1527bc95aba",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Check Oustanding Emails Analysis",
        "func": "const emails = msg.payload\nlet toProcess = emails.length\n\nemails.forEach(function(email) {\n    if (email.MinutesSinceCreated > 60){\n        let alert = `\nInbox Automation Stale Email Alert!\n\nEmail ID: ${email.EmailID}\nTicket ID: ${email.TicketID}\nInbox: ${email.Inbox}\nSender: ${email.Sender}\nMinutes: ${email.MinutesSinceCreated}\n`\n        node.send({\"type\": \"alert\", \"payload\": alert})\n    }\n});\n\nmsg.toProcess = toProcess\nif (toProcess === 0){\n    msg.type = \"exit\"\n    msg.reset = true\n} else {\n    msg.type = \"process\"\n}\n \n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1440,
        "y": 680,
        "wires": [
            [
                "834a3f85767b3152"
            ]
        ]
    },
    {
        "id": "834a3f85767b3152",
        "type": "switch",
        "z": "a90cc5d82d9a1021",
        "name": "Action To Take",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "process",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "alert",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "exit",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1700,
        "y": 680,
        "wires": [
            [
                "281565f0d1bb23c8"
            ],
            [],
            [
                "6e044722c13b5c99"
            ]
        ]
    },
    {
        "id": "6e044722c13b5c99",
        "type": "link out",
        "z": "a90cc5d82d9a1021",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "c3997f44da9d973a"
        ],
        "x": 1835,
        "y": 760,
        "wires": []
    },
    {
        "id": "c3997f44da9d973a",
        "type": "link in",
        "z": "a90cc5d82d9a1021",
        "name": "link in 1",
        "links": [
            "6e044722c13b5c99"
        ],
        "x": 345,
        "y": 740,
        "wires": [
            [
                "6b2670b4308040c1"
            ]
        ]
    },
    {
        "id": "6ed9535970154b29",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "function 12",
        "func": "const TOKEN = msg.token\nmsg.url = 'https://inspired-1.my.automationanywhere.digital/v3/automations/deploy'\nmsg.method = \"POST\"\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"fileId\": 252923,\n  \"automationName\": \"AUTO DEPLOYED VIA API - Inbox Automation\",\n  \"runAsUserIds\": [\n    429\n  ],\n  \"overrideDefaultDevice\": false,\n  \"numOfRunAsUsersToUse\": 1,\n  \"automationPriority\": \"PRIORITY_HIGH\"\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2350,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "680a2eb6977c9fb5",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 2150,
        "y": 620,
        "wires": [
            [
                "6ed9535970154b29"
            ]
        ]
    },
    {
        "id": "281565f0d1bb23c8",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1930,
        "y": 620,
        "wires": [
            [
                "680a2eb6977c9fb5"
            ]
        ]
    },
    {
        "id": "ae374891fc804039",
        "type": "file",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 2260,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "d52dbdff62338856",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "create filename",
        "func": "// Adjust this root path as needed\nconst root = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Logs\\\\Node-Red\\\\check_process_is_running\";\n\n// Get the current date and time\nconst now = new Date();\nconst year = now.getFullYear();\nconst monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n];\nconst month = monthNames[now.getMonth()];\nconst day = String(now.getDate()).padStart(2, '0');\n\n// Create a Windows-safe timestamp (e.g. 2025-08-07_15-27-59-123)\nconst ts = now.toISOString()\n    .replace(/:/g, '-')       // Replace colon with dash\n    .replace(/\\..+/, '')      // Remove milliseconds from the ISO string (we'll add them back manually)\n    .replace('T', '_');       // Replace T with _\n\nconst ms = String(now.getMilliseconds()).padStart(3, '0');\nconst filename = `${ts}-${ms}__${msg.bot_name}.json`;\n\n// Build the full file path\nconst path = `${root}\\\\${year}\\\\${month}\\\\${day}\\\\${filename}`;\n\n// Set up for Write File node\nmsg.filename = path;\n\n// The file contents are in msg.payload already\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2100,
        "y": 520,
        "wires": [
            [
                "ae374891fc804039"
            ]
        ]
    },
    {
        "id": "285337b2a6d8463f",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "wd_check_if_bot_is_running",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 960,
        "wires": [
            [
                "d280e8f3dc64b391"
            ]
        ]
    },
    {
        "id": "d280e8f3dc64b391",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "bot_name",
                "pt": "msg",
                "to": "payload.bot_name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runner_username",
                "pt": "msg",
                "to": "payload.username",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 960,
        "wires": [
            [
                "0e5636554f2e867c"
            ]
        ]
    },
    {
        "id": "0e5636554f2e867c",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 690,
        "y": 960,
        "wires": [
            [
                "3c0b81ffc60d2c89"
            ]
        ]
    },
    {
        "id": "3c0b81ffc60d2c89",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 960,
        "wires": [
            [
                "5d17843ff0263d9b"
            ]
        ]
    },
    {
        "id": "5d17843ff0263d9b",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1110,
        "y": 960,
        "wires": [
            [
                "19707988b4b38e71",
                "7be77b254d80aa3e"
            ]
        ]
    },
    {
        "id": "19707988b4b38e71",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Build Response JSON",
        "func": "// Simplified: ignore device & username comparisons.\n// Still outputs a new payload with: { status: \"successful\", response: { ... } }\n\nif (!msg.bot_name || !msg.payload || !Array.isArray(msg.payload.list)) {\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: false,\n            device_name: \"\",\n            user_name: \"\",\n            type: \"\",\n            bot_name: msg.bot_name || \"\",\n            bot_id: msg.fileId || \"\"\n        }\n    };\n    msg.DEBUG = 1;\n    return msg;\n}\n\nconst botNameLower = String(msg.bot_name).toLowerCase();\n\n// Status values that indicate a run has finished or is not active\nconst TERMINAL = new Set([\n  \"COMPLETED\", \"SUCCESS\", \"SUCCESSFUL\",\n  \"FAILED\", \"ERROR\", \"STOPPED\", \"CANCELLED\",\n  \"ABORTED\", \"TERMINATED\"\n]);\n\n// Find any active entry for this bot name\nconst matches = msg.payload.list.filter(item => {\n    if (!item || typeof item.fileName !== \"string\") return false;\n\n    const nameMatch = item.fileName.toLowerCase() === botNameLower;\n\n    // Empty/absent endDateTime => still active\n    const stillActive = !(typeof item.endDateTime === \"string\" && item.endDateTime.trim().length > 0);\n\n    // If status is present, require it not to be terminal\n    const status = String(item.status || \"\").toUpperCase();\n    const notTerminal = !TERMINAL.has(status);\n\n    return nameMatch && stillActive && notTerminal;\n});\n\nif (matches.length > 0) {\n    const first = matches[0]; // we don't compare by username/device, just surface them if you want\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: true,\n            device_name: first.deviceName || \"\",\n            user_name: first.userName || \"\",\n            type: first.type || \"\",\n            bot_name: msg.bot_name,\n            bot_id: first.fileId\n        }\n    };\n    msg.DEBUG = 3;\n} else {\n    msg.payload = {\n        status: \"successful\",\n        response: {\n            bot_running: false,\n            device_name: \"\",\n            user_name: \"\",\n            type: \"\",\n            bot_name: msg.bot_name,\n            bot_id: msg.fileId\n        }\n    };\n    msg.DEBUG = 2;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 960,
        "wires": [
            [
                "49f12f668c05d4f5"
            ]
        ]
    },
    {
        "id": "49f12f668c05d4f5",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1560,
        "y": 960,
        "wires": []
    },
    {
        "id": "bc11c3d306e174f6",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "/getId",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 840,
        "wires": [
            [
                "856198a23113c8a7"
            ]
        ]
    },
    {
        "id": "999a64f868ad1c7d",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 610,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "856198a23113c8a7",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "taskName",
                "pt": "msg",
                "to": "payload.taskName",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 370,
        "y": 840,
        "wires": [
            [
                "999a64f868ad1c7d"
            ]
        ]
    },
    {
        "id": "53f0b01633bdab6f",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "/wd_deploy_bot",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1020,
        "wires": [
            [
                "5938289da10593cb"
            ]
        ]
    },
    {
        "id": "5938289da10593cb",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "move",
                "p": "payload.fileId",
                "pt": "msg",
                "to": "fileId",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.description",
                "pt": "msg",
                "to": "description",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 1020,
        "wires": [
            [
                "1e39d99b059c338b"
            ]
        ]
    },
    {
        "id": "1e39d99b059c338b",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 650,
        "y": 1020,
        "wires": [
            [
                "22b4bcf438670e5f"
            ]
        ]
    },
    {
        "id": "22b4bcf438670e5f",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Deploy To RDS",
        "func": "// Node-RED Function: Deploy bot (hardcoded values)\n\n// JWT token already in msg.payload.token\nconst TOKEN = msg.payload.token;\nconst description = msg.description;\nconst fileId = msg.fileId;\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/automations/deploy\";\n\nmsg.headers = {\n    \"Accept\": \"application/json\",\n    \"Content-Type\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\n// Hardcoded deployment details\nmsg.payload = {\n    fileId: fileId,   // Bot fileId\n    automationName: description,\n    runAsUserIds: [623,624,625,626,627,569,514,600,571,517,594,595,596,597,598,599],   // IDs for RDS unattended runners\n    overrideDefaultDevice: true,\n    numOfRunAsUsersToUse: 1,         // Ensures CR only picks ONE available runner\n    automationPriority: \"PRIORITY_MEDIUM\",\n    poolIds: [24]                   // Device pool ID containing those 3 runners\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 1020,
        "wires": [
            [
                "6c578a35783fae85"
            ]
        ]
    },
    {
        "id": "6c578a35783fae85",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1050,
        "y": 1020,
        "wires": [
            [
                "f4d6c6ce4ccf07c8"
            ]
        ]
    },
    {
        "id": "f4d6c6ce4ccf07c8",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1210,
        "y": 1020,
        "wires": []
    },
    {
        "id": "ce6732e149c6d3c0",
        "type": "inject",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 230,
        "y": 280,
        "wires": [
            [
                "5b59fcc5c14157c1"
            ]
        ]
    },
    {
        "id": "51a2c11ff261e21d",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "/get_checked_out",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1140,
        "wires": [
            [
                "9d07fe203081da91"
            ]
        ]
    },
    {
        "id": "9d07fe203081da91",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 450,
        "y": 1140,
        "wires": [
            [
                "8d61dacdacf68b8a"
            ]
        ]
    },
    {
        "id": "8d61dacdacf68b8a",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Get checked out ",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/repository/workspaces/public/files/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"botStatus\",\n        \"operator\": \"eq\",\n        \"value\": \"CHECKED_OUT\"\n      }\n    ],\n    \"sort\": [\n      {}\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 1140,
        "wires": [
            [
                "f2f2d529f5eabfb1"
            ]
        ]
    },
    {
        "id": "f2f2d529f5eabfb1",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 900,
        "y": 1140,
        "wires": [
            [
                "60939d44b93e2bc1"
            ]
        ]
    },
    {
        "id": "60939d44b93e2bc1",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1070,
        "y": 1140,
        "wires": []
    },
    {
        "id": "8554f31ece196ff1",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "/deploy_meter_matching_bot",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 1260,
        "wires": [
            [
                "aebc4945404c6db2",
                "7205680424f4b01a"
            ]
        ]
    },
    {
        "id": "aebc4945404c6db2",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "move",
                "p": "payload.jsonFile",
                "pt": "msg",
                "to": "jsonFile",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 1260,
        "wires": [
            [
                "0a9eb4dadd1d00fe"
            ]
        ]
    },
    {
        "id": "0a9eb4dadd1d00fe",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 730,
        "y": 1260,
        "wires": [
            [
                "8758eaeb3568b7fd"
            ]
        ]
    },
    {
        "id": "8758eaeb3568b7fd",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Deploy To RDS",
        "func": "// Node-RED Function: Deploy bot with typed botInput (A360 v3)\n\n// Token\nconst TOKEN = String(msg.payload.token);\n\n//JSON File\nconst jsonFilePath = String(msg.jsonFile)\nconst jsonFile = jsonFilePath.split(\"\\\\\").pop();\n\n// IDs as strings\nconst fileId = String(330633);\n\nconst runAsUserIds = [623,624,625,626,627,569,514,600,571,517,594,595,596,597,598,599].map(String);\nconst poolIds = [\"24\"];\nconst automationName = `MeterMatching - ${jsonFile}`\n\n// Build botInput exactly as per docs\nconst botInput = {\n    strFileToProcess: { type: \"STRING\", string: jsonFilePath},\n};\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/automations/deploy\";\nmsg.headers = {\n  \"Accept\": \"application/json\",\n  \"Content-Type\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  fileId,\n  automationName: automationName,\n  runAsUserIds,\n  overrideDefaultDevice: true,\n  numOfRunAsUsersToUse: 1,\n  automationPriority: \"PRIORITY_MEDIUM\",\n  poolIds,\n  botInput\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 1260,
        "wires": [
            [
                "eebba1640b8467bb"
            ]
        ]
    },
    {
        "id": "eebba1640b8467bb",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1170,
        "y": 1260,
        "wires": [
            [
                "d8f436c64ef332b1",
                "08bc305fef2f3d59"
            ]
        ]
    },
    {
        "id": "0843d483dcd3d9c3",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1580,
        "y": 1260,
        "wires": []
    },
    {
        "id": "de0fa41bb5d5f1d3",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1580,
        "y": 1320,
        "wires": []
    },
    {
        "id": "7205680424f4b01a",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 14",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 460,
        "y": 1380,
        "wires": []
    },
    {
        "id": "d8f436c64ef332b1",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Check Response",
        "func": "// Expecting msg.payload to contain JSON from the HTTP response\nlet payload = msg.payload;\nlet out = { status: \"\", message: \"\" };\n\nif (payload && payload.deploymentId) {\n    // GOOD response\n    out.status = \"successful\";\n    out.message = payload.deploymentId;\n} else {\n    // BAD response\n    out.status = \"error\";\n    // Prefer \"message\" field if present, else fallback\n    out.message = (payload && payload.message)\n        ? payload.message\n        : \"Unknown error or invalid response\";\n}\n\nmsg.payload = out;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1370,
        "y": 1260,
        "wires": [
            [
                "0843d483dcd3d9c3",
                "de0fa41bb5d5f1d3"
            ]
        ]
    },
    {
        "id": "08bc305fef2f3d59",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 17",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1340,
        "y": 1320,
        "wires": []
    },
    {
        "id": "7be77b254d80aa3e",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 42",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1300,
        "y": 860,
        "wires": []
    },
    {
        "id": "b198264b1cf35433",
        "type": "http in",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "url": "get_deployment_id",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 1580,
        "wires": [
            [
                "991420fc98c97529"
            ]
        ]
    },
    {
        "id": "991420fc98c97529",
        "type": "change",
        "z": "a90cc5d82d9a1021",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "bot_name",
                "pt": "msg",
                "to": "payload.bot_name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runner_username",
                "pt": "msg",
                "to": "payload.username",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 430,
        "y": 1580,
        "wires": [
            [
                "2e4515846f07e22e"
            ]
        ]
    },
    {
        "id": "2e4515846f07e22e",
        "type": "subflow:2ef09639923d028e",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "x": 630,
        "y": 1580,
        "wires": [
            [
                "3a8721eed2f2ace9"
            ]
        ]
    },
    {
        "id": "3a8721eed2f2ace9",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 1580,
        "wires": [
            [
                "79d445e6e2ab56c5"
            ]
        ]
    },
    {
        "id": "79d445e6e2ab56c5",
        "type": "http request",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1050,
        "y": 1580,
        "wires": [
            [
                "3e2a6bc3170a3e79",
                "956627a4d5f90b59"
            ]
        ]
    },
    {
        "id": "3e2a6bc3170a3e79",
        "type": "function",
        "z": "a90cc5d82d9a1021",
        "name": "function 19",
        "func": "// Inputs required:\n//   msg.username   -> e.g. \"botrunner24\"\n//   msg.bot_name   -> e.g. \"CastleWaterA360_api_v2\"\n//   msg.payload    -> object or JSON string with shape { list: [...] }\n\nfunction asObject(p) {\n    if (p == null) return null;\n    if (typeof p === \"string\") {\n        try { return JSON.parse(p); } catch (e) { return null; }\n    }\n    if (typeof p === \"object\") return p;\n    return null;\n}\n\nconst data = asObject(msg.payload);\nif (!data || !Array.isArray(data.list)) {\n    node.warn(\"payload.list missing or invalid\");\n    msg.payload = \"unknown\";\n    return msg;\n}\n\nif (typeof msg.username !== \"string\" || typeof msg.bot_name !== \"string\") {\n    node.warn(\"msg.username or msg.bot_name missing or invalid\");\n    msg.payload = \"unknown\";\n    return msg;\n}\n\nconst hit = data.list.find(item =>\n    item &&\n    item.userName === msg.username &&\n    item.fileName === msg.bot_name\n);\n\nmsg.payload = hit && typeof hit.deploymentId === \"string\" ? hit.deploymentId : \"unknown\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 1580,
        "wires": [
            [
                "cae2c0130c95128c",
                "a9f44549edb9f00b"
            ]
        ]
    },
    {
        "id": "cae2c0130c95128c",
        "type": "http response",
        "z": "a90cc5d82d9a1021",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 1580,
        "wires": []
    },
    {
        "id": "a9f44549edb9f00b",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 43",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1310,
        "y": 1700,
        "wires": []
    },
    {
        "id": "956627a4d5f90b59",
        "type": "debug",
        "z": "a90cc5d82d9a1021",
        "name": "debug 44",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 1700,
        "wires": []
    },
    {
        "id": "7525534bb2484ae3",
        "type": "inject",
        "z": "1dc165ed61e2f895",
        "name": "6am",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 06 * * 1,2,3,4,5",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 240,
        "wires": [
            [
                "918954ba57647e57"
            ]
        ]
    },
    {
        "id": "ed309e59113c89d6",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Question of the day",
        "func": "// Node-RED Function: Build Gemini request for \"Question of the Day\"\n// Output: msg configured for an HTTP Request node\n\n// 0) Config and safety\nconst API_KEY =\n    env.get(\"GEMINI_API_KEY\") ||\n    flow.get(\"GEMINI_API_KEY\") ||\n    global.get(\"GEMINI_API_KEY\") ||\n    \"AIzaSyCJVACtxOoPosYfZtBR5h7djADsphFwnOw\"; // fallback (not recommended for prod)\n\n\nif (!API_KEY) {\n  node.error(\"GEMINI_API_KEY is missing. Set it in env, flow, or global context.\");\n  return null;\n}\n\n// 1) Time window\nconst nowUtc = new Date();\nconst twentyHoursAgoUtc = new Date(nowUtc.getTime() - 20 * 60 * 60 * 1000);\n\n// 2) Topic rotation to avoid repetition\n// You can reorder or edit this list as you like.\nconst TOPICS = [\n  \"world politics\",\n  \"UK news\",\n  \"economy and markets\",\n  \"technology\",\n  \"sports\",\n  \"entertainment and culture\",\n  \"medicine and health\",\n  \"environment and climate\",\n  \"crime and law\",\n  \"archaeology and history\",\n  \"business and industry\"\n];\n\n// Simple round robin across runs\nlet idx = flow.get(\"qod_topic_idx\") || 0;\nconst theme = TOPICS[idx % TOPICS.length];\nflow.set(\"qod_topic_idx\", (idx + 1) % TOPICS.length);\n\n// 3) Optional memory of the last produced topic\nconst lastTopic = flow.get(\"qod_last_topic\") || \"\";\n\n// 4) Prompt with topical constraints and JSON-only output\nconst prompt = `\nYou are a news-to-quiz generator focused today on ${theme}.\n\nTask:\n1) Pick a real major-news story published within the LAST 20 HOURS.\n2) Write a concise 1–3 line summary as \"news_snippet\".\n3) Create a related question about a past event, historical fact, or prior milestone linked to that story.\n4) Provide exactly four plausible multiple-choice answers.\n5) Ensure \"the_answer\" EXACTLY matches one of answer1..answer4.\n6) Output ONLY a single JSON object with these keys and nothing else:\n{\"news_snippet\":\"...\", \"question\":\"...\", \"answer1\":\"...\", \"answer2\":\"...\", \"answer3\":\"...\", \"answer4\":\"...\", \"the_answer\":\"...\"}\n\nRecency window (UTC):\n- now: ${nowUtc.toISOString()}\n- earliest allowed: ${twentyHoursAgoUtc.toISOString()}\n\nTopic diversity requirement:\n- Avoid astronomy, physics, and space exploration unless they dominate global headlines today.\n- Prefer ${theme}. If ${theme} is weak, choose from: world politics, economy, sports, entertainment, technology, medicine, environment, business, UK news, crime and law, archaeology and history.\n- Do not repeat the previous topic: \"${lastTopic}\" if avoidable.\n\nStyle constraints:\n- \"news_snippet\" must be 1–3 short lines, max about 280 characters total.\n- The question must clearly connect to the news but ask about the past.\n- Avoid opinion or unverifiable claims.\n- Do NOT include explanations, sources, or extra text outside the JSON.\n`;\n\n// 5) Gemini endpoint and HTTP Request\nconst url = \"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent\";\n\nmsg.method = \"POST\";\nmsg.url = url;\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"X-goog-api-key\": API_KEY\n};\n\nmsg.payload = {\n  contents: [{ parts: [{ text: prompt }] }],\n  generationConfig: {\n    temperature: 0.8,     // a bit creative, still stable\n    topK: 40,\n    topP: 0.95,\n    maxOutputTokens: 400,\n    response_mime_type: \"application/json\"\n  }\n};\n\n// 6) Pass theme for downstream logging and dedupe\n// After a successful response, set flow.set(\"qod_last_topic\", theme) in the node that parses the reply.\nmsg.quiz_meta = {\n  theme,\n  window_start_utc: twentyHoursAgoUtc.toISOString(),\n  window_end_utc: nowUtc.toISOString()\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 240,
        "wires": [
            [
                "10fc9cd7a74b8568"
            ]
        ]
    },
    {
        "id": "10fc9cd7a74b8568",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 240,
        "wires": [
            [
                "f7bc1d0d3a0c13bd"
            ]
        ]
    },
    {
        "id": "f7bc1d0d3a0c13bd",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Parse Response",
        "func": "// Node-RED Function: Build SQL INSERT for aa.bot_developers_qotd\n\n// Step 1: Extract the Gemini response text\nlet rawText;\ntry {\n    rawText = msg.payload.candidates[0].content.parts[0].text;\n} catch (e) {\n    node.error(\"Unexpected response format from Gemini\", msg);\n    return null;\n}\n\n// Step 2: Parse the JSON string (Gemini wrapped inside [ ... ])\nlet data;\ntry {\n    data = JSON.parse(rawText);\n} catch (e) {\n    node.error(\"Failed to parse Gemini text as JSON\", msg);\n    return null;\n}\n\n// Handle if Gemini returns an array of objects\nif (Array.isArray(data)) {\n    data = data[0];\n}\n\n// Step 3: Build the INSERT statement\n// Ensure single quotes inside text are doubled up for SQL safety\nfunction esc(val) {\n    if (val === null || val === undefined) return \"NULL\";\n    return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\n\n// Date only (YYYY-MM-DD)\nconst today = new Date().toISOString().split(\"T\")[0];\n\nconst sql = `\nINSERT INTO aa_dev.q_process\n(qotd_date, news_snippet, question, answer1, answer2, answer3, answer4, the_answer)\nVALUES\n(${esc(today)}, ${esc(data.news_snippet)}, ${esc(data.question)},\n ${esc(data.answer1)}, ${esc(data.answer2)}, ${esc(data.answer3)}, ${esc(data.answer4)},\n ${esc(data.the_answer)});\n`;\n\n// Step 4: Set SQL into msg for next node (ODBC / MSSQL execution)\nmsg.topic = sql;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 240,
        "wires": [
            [
                "ef3b70a0aed2cab0"
            ]
        ]
    },
    {
        "id": "ef3b70a0aed2cab0",
        "type": "MSSQL",
        "z": "1dc165ed61e2f895",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1340,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "c6048045c5dbb65f",
        "type": "inject",
        "z": "1dc165ed61e2f895",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 480,
        "wires": [
            [
                "f279b72b02a97370"
            ]
        ]
    },
    {
        "id": "c2f2d2db4922b9de",
        "type": "subflow:2ef09639923d028e",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 590,
        "y": 480,
        "wires": [
            [
                "e92b707bbe551a66"
            ]
        ]
    },
    {
        "id": "e92b707bbe551a66",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Get Scheduled",
        "func": "// Node-RED Function  :  list scheduled activity but exclude owner 632\n\nconst TOKEN = msg.payload.token;          // JWT generated earlier\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v1/schedule/automations/list\";\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\n// ‘owner’ in the Schedule API is the user who created the schedule → field = createdBy\n// Use operator \"ne\" (not-equal) to exclude ID 632\nmsg.payload = {\n    filter:{\n    // \"operator\": \"eq\",\n    // \"field\": \"ownedBy\",\n    // \"value\": \"632\"\n  },\n    sort: [],\n    page: {\n      offset: 0, \n      length: 1000 \n      }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 480,
        "wires": [
            [
                "f8f8c25678bbb722"
            ]
        ]
    },
    {
        "id": "f8f8c25678bbb722",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1000,
        "y": 480,
        "wires": [
            [
                "0a3831406712b8a7"
            ]
        ]
    },
    {
        "id": "0a3831406712b8a7",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "function 18",
        "func": "/**\n * Input: msg.payload.list = Array of schedule objects\n * Output: multiple messages to MSSQL node:\n *   1) TRUNCATE TABLE\n *   2..N) INSERT with named params @p1..@p38 and params as [{name,type,value,length?},...]\n */\n\nfunction nz(v) { return (v === undefined || v === null) ? null : v; }\nfunction toBool(v) {\n  if (typeof v === \"boolean\") return v;\n  if (v === 1 || v === \"1\" || v === \"true\" || v === \"TRUE\") return true;\n  if (v === 0 || v === \"0\" || v === \"false\" || v === \"FALSE\") return false;\n  return v ? true : false;\n}\nfunction toIntOrNull(v) {\n  if (v === \"\" || v === undefined || v === null) return null;\n  const n = parseInt(v, 10);\n  return Number.isFinite(n) ? n : null;\n}\nfunction toDateOrNull(v) { return (!v || v === \"\") ? null : v; }            // 'YYYY-MM-DD'\nfunction toDtoOrNull(v) { return (!v || v === \"\") ? null : v; }             // ISO w/ Z or offset\nfunction toGuidOrNull(v){ return (!v || v === \"\") ? null : v; }\nfunction jsonify(v) {\n  if (v === undefined || v === null) return null;\n  try { return JSON.stringify(v); } catch(e) { return null; }\n}\n\n// Expect array at msg.payload.list\nconst rows = (msg && msg.payload && Array.isArray(msg.payload.list)) ? msg.payload.list : [];\nif (rows.length === 0) {\n  node.warn(\"watchdog: msg.payload.list is empty or missing; nothing to insert.\");\n  return null;\n}\n\n// 1) TRUNCATE\nnode.send({ topic: \"TRUNCATE TABLE aa.watchdog_schedule_data;\", params: [], action: \"in_progress\" });\n\n// half second delay to allow the truncate\nsetTimeout(() => {\n  node.send({\n    topic: \"INSERT INTO aa.watchdog_schedule_data (col) VALUES (?);\",\n    params: [msg.payload]\n  });\n}, 500);\n\n// 2) INSERT with named params\nconst sql = `\nINSERT INTO aa.watchdog_schedule_data (\n  id, name, fileId, status,\n  description, rdpEnabled, scheduleType, timeZone,\n  startDate, endDate, startTime, repeatEnabled,\n  zonedNextRunDateTime, createdBy, createdOn, updatedBy, updatedOn, tenantId,\n  fileName, filePath, tenantUuid, overrideDefaultDevice, runElevated, automationPriority,\n  botLabel, misfireScheduleConfig, numOfRunAsUsersToUse, handleUnexpectedPopups, ownedBy, hideBotAgentUi,\n  deviceIds, weeklyRecurrence, dailyRecurrence, repeatOccurrence, runAsUserIds, botInput, poolId, resiliency\n) VALUES (\n  @p1,@p2,@p3,@p4,\n  @p5,@p6,@p7,@p8,\n  @p9,@p10,@p11,@p12,\n  @p13,@p14,@p15,@p16,@p17,@p18,\n  @p19,@p20,@p21,@p22,@p23,@p24,\n  @p25,@p26,@p27,@p28,@p29,@p30,\n  @p31,@p32,@p33,@p34,@p35,@p36,@p37,@p38\n);`.replace(/\\s+/g,\" \").trim();\n\n// helper to build a parameter object; mssql-plus expects {name,type,value[,length]}\nfunction P(name, type, value, length) {\n  const p = { name, type, value };\n  if (length !== undefined) p.length = length;\n  return p;\n}\n\n// For each row, send one INSERT\nfor (const r of rows) {\n  const params = [\n    // NVARCHARs\n    P('p1','NVarChar', nz(r.id), 50),\n    P('p2','NVarChar', nz(r.name), 255),\n    P('p3','NVarChar', nz(r.fileId), 50),\n    P('p4','NVarChar', nz(r.status), 32),\n\n    P('p5','NVarChar', nz(r.description), 4000),\n    P('p6','Bit',       toBool(r.rdpEnabled)),\n    P('p7','NVarChar', nz(r.scheduleType), 32),\n    P('p8','NVarChar', nz(r.timeZone), 100),\n\n    // Dates / times\n    P('p9','Date',            toDateOrNull(r.startDate)),\n    P('p10','Date',           toDateOrNull(r.endDate)),\n    P('p11','VarChar',        nz(r.startTime), 5),          // 'HH:mm'\n    P('p12','Bit',            toBool(r.repeatEnabled)),\n\n    P('p13','DateTimeOffset', toDtoOrNull(r.zonedNextRunDateTime)),\n    P('p14','NVarChar',       nz(r.createdBy), 50),\n    P('p15','DateTimeOffset', toDtoOrNull(r.createdOn)),\n    P('p16','NVarChar',       nz(r.updatedBy), 50),\n    P('p17','DateTimeOffset', toDtoOrNull(r.updatedOn)),\n    P('p18','NVarChar',       nz(r.tenantId), 50),\n\n    P('p19','NVarChar', nz(r.fileName), 255),\n    P('p20','NVarChar', nz(r.filePath), 1024),\n    P('p21','UniqueIdentifier', toGuidOrNull(r.tenantUuid)),\n    P('p22','Bit', toBool(r.overrideDefaultDevice)),\n    P('p23','Bit', toBool(r.runElevated)),\n    P('p24','NVarChar', nz(r.automationPriority), 32),\n\n    P('p25','NVarChar', nz(r.botLabel), 255),\n    P('p26','Bit', toBool(r.misfireScheduleConfig)),\n    P('p27','Int', toIntOrNull(r.numOfRunAsUsersToUse)),\n    P('p28','Bit', toBool(r.handleUnexpectedPopups)),\n    P('p29','NVarChar', nz(r.ownedBy), 50),\n    P('p30','Bit', toBool(r.hideBotAgentUi)),\n\n    // JSON blobs -> NVARCHAR(MAX). No length property for MAX.\n    P('p31','NVarChar', jsonify(r.deviceIds)),\n    P('p32','NVarChar', jsonify(r.weeklyRecurrence)),\n    P('p33','NVarChar', jsonify(r.dailyRecurrence)),\n    P('p34','NVarChar', jsonify(r.repeatOccurrence)),\n    P('p35','NVarChar', jsonify(r.runAsUserIds)),\n    P('p36','NVarChar', jsonify(r.botInput)),\n    P('p37','NVarChar', jsonify(r.poolId)),\n    P('p38','NVarChar', jsonify(r.resiliency)),\n  ];\n\n  node.send({ topic: sql, params, action: \"in_progress\" });\n}\n\nreturn {\"action\": \"complete\"};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 480,
        "wires": [
            [
                "678a71173f403dca"
            ]
        ]
    },
    {
        "id": "466c890d7562559e",
        "type": "inject",
        "z": "1dc165ed61e2f895",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 130,
        "y": 600,
        "wires": [
            [
                "227e226d5e62e5fb"
            ]
        ]
    },
    {
        "id": "24b95ff362579bbc",
        "type": "subflow:2ef09639923d028e",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 630,
        "y": 600,
        "wires": [
            [
                "69ac994f74110ac8"
            ]
        ]
    },
    {
        "id": "69ac994f74110ac8",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Get Users",
        "func": "const TOKEN = msg.payload.token;          // JWT generated earlier\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/usermanagement/users/list\";\n\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  filter: {},           // no filter => all users (paged)\n  sort: [],             // e.g. [{ field: \"username\", order: \"ASC\" }]\n  page: { offset: 0, length: 1000 }\n};\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 830,
        "y": 600,
        "wires": [
            [
                "b5f65867d76e5c2c"
            ]
        ]
    },
    {
        "id": "b5f65867d76e5c2c",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1010,
        "y": 600,
        "wires": [
            [
                "5a76f926b0e106a2"
            ]
        ]
    },
    {
        "id": "5a76f926b0e106a2",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Parse Users",
        "func": "// Node-RED Function: rebuild aa.watchdog_cr_users from msg.payload.list\n// Input: msg.payload.list = [ {...}, {...}, ... ]\n// Output: array of INSERT statements, plus a TRUNCATE as first\n\nconst list = (msg.payload && Array.isArray(msg.payload.list)) ? msg.payload.list : [];\nif (list.length === 0) return null;\n\n// escape T-SQL string literal and clamp length\nfunction esc(v, maxLen) {\n    let s = (v == null ? '' : String(v));\n    if (maxLen && s.length > maxLen) s = s.slice(0, maxLen);\n    return s.replace(/'/g, \"''\");\n}\nfunction b(v) { return v ? 1 : 0; }\nfunction rolesCsv(roles) {\n    if (!Array.isArray(roles)) return '';\n    return roles.map(r => (r && r.name) ? String(r.name) : '').filter(Boolean).join(', ');\n}\nfunction licCsv(features) {\n    if (!Array.isArray(features)) return '';\n    return features.map(x => String(x)).filter(Boolean).join(', ');\n}\n\nconst nowIso = new Date().toISOString();\n\nconst out = [];\n\n// first TRUNCATE command\nout.push({ topic: \"TRUNCATE TABLE aa.watchdog_cr_users;\", query: \"TRUNCATE TABLE aa.watchdog_cr_users;\" });\n\nfor (const u of list) {\n    const sql = `\nINSERT INTO aa.watchdog_cr_users (\n    principal_id, user_id, username, email, first_name, last_name, domain, description, version,\n    disabled, enable_auto_login, multiple_login_allowed, email_verified, password_set,\n    created_by, created_on_utc, updated_by, updated_on_utc, last_login_utc,\n    roles_csv, roles_json, license_features_csv,\n    first_seen_utc, last_seen_utc, counter\n) VALUES (\n    '${esc(u.principalId ?? u.id, 256)}',\n    '${esc(u.id, 256)}',\n    '${esc(u.username, 256)}',\n    '${esc(u.email, 256)}',\n    '${esc(u.firstName, 128)}',\n    '${esc(u.lastName, 128)}',\n    '${esc(u.domain, 128)}',\n    N'${esc(u.description, 4000)}',\n    ${Number.isFinite(u.version) ? u.version : 'NULL'},\n    ${b(u.disabled)},\n    ${b(u.enableAutoLogin)},\n    ${b(u.multipleLoginAllowed)},\n    ${b(u.emailVerified)},\n    ${b(u.passwordSet)},\n    '${esc(u.createdBy, 64)}',\n    ${u.createdOn ? `'${esc(u.createdOn)}'` : 'NULL'},\n    '${esc(u.updatedBy, 64)}',\n    ${u.updatedOn ? `'${esc(u.updatedOn)}'` : 'NULL'},\n    ${u.lastLoginTime ? `'${esc(u.lastLoginTime)}'` : 'NULL'},\n    N'${esc(rolesCsv(u.roles), 2000)}',\n    N'${esc(JSON.stringify(u.roles || []), 0)}',\n    N'${esc(licCsv(u.licenseFeatures), 2000)}',\n    '${nowIso}',\n    '${nowIso}',\n    1\n);`.trim();\n\n    out.push({ topic: sql, query: sql });\n}\n\nreturn [out];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 600,
        "wires": [
            [
                "8c20743c4e8ac78e"
            ]
        ]
    },
    {
        "id": "951b059d5714c867",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Question Of the Day (GenAI)",
        "info": "",
        "x": 160,
        "y": 200,
        "wires": []
    },
    {
        "id": "932165eada4a2f6b",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Refresh Schedule Data",
        "info": "",
        "x": 140,
        "y": 440,
        "wires": []
    },
    {
        "id": "a2df53a38ba1c3a7",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Refresh User Data",
        "info": "",
        "x": 130,
        "y": 560,
        "wires": []
    },
    {
        "id": "f4ef54cca086aff2",
        "type": "MSSQL",
        "z": "1dc165ed61e2f895",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "params",
        "paramsOptType": "msg",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1550,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "b7aac7ac890d4165",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "/refresh_schedule",
        "url": "/refresh_schedule",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 520,
        "wires": [
            [
                "c2f2d2db4922b9de",
                "284e94189f2abbfb"
            ]
        ]
    },
    {
        "id": "07bc167977382256",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 610,
        "y": 540,
        "wires": []
    },
    {
        "id": "678a71173f403dca",
        "type": "switch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "in_progress",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "complete",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 480,
        "wires": [
            [
                "f4ef54cca086aff2"
            ],
            []
        ]
    },
    {
        "id": "284e94189f2abbfb",
        "type": "delay",
        "z": "1dc165ed61e2f895",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 460,
        "y": 540,
        "wires": [
            [
                "07bc167977382256"
            ]
        ]
    },
    {
        "id": "8c20743c4e8ac78e",
        "type": "MSSQL",
        "z": "1dc165ed61e2f895",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1440,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "66ec07a59aac8c33",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "",
        "url": "/logoff_check",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 720,
        "wires": [
            [
                "b697adc2da998ce7",
                "c96255ed1fd96108"
            ]
        ]
    },
    {
        "id": "3614622b4e1de75a",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1400,
        "y": 720,
        "wires": []
    },
    {
        "id": "8265d52c960b7d9a",
        "type": "subflow:2ef09639923d028e",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 630,
        "y": 720,
        "wires": [
            [
                "6850d9ba5b6543e1"
            ]
        ]
    },
    {
        "id": "6850d9ba5b6543e1",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 720,
        "wires": [
            [
                "4b9a9332aa1dd5bf"
            ]
        ]
    },
    {
        "id": "4b9a9332aa1dd5bf",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1050,
        "y": 720,
        "wires": [
            [
                "a4dd6731dc099d6e"
            ]
        ]
    },
    {
        "id": "a4dd6731dc099d6e",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "function 17",
        "func": "// Expects:\n//   msg.hostname  (string)\n//   msg.username  (string)\n//   msg.payload   (object like the example, with payload.list[0])\n//\n// Output:\n//   msg.payload = 'close_session' | 'end_session'\n\n\nconst p = msg.payload;\nlet shouldClose = false;\n\nconst hostname = msg.toCheckHostname?.toLowerCase();\nconst username = msg.toCheckUsername.split('.')[1]?.toLowerCase();\n\nmsg.checkedUsername = username;\nmsg.checkedHostname = hostname;\n\nif (p && Array.isArray(p.list) && p.list.length > 0) {\n    shouldClose = p.list.some(item =>\n        item.deviceName?.toLowerCase() === hostname &&\n        item.userName?.toLowerCase() === username\n    );\n}\n\n// If both conditions are true -> 'close_session', else -> 'end_session'\nmsg.payload = shouldClose ? 'close_session' : 'end_session';\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1230,
        "y": 720,
        "wires": [
            [
                "3614622b4e1de75a"
            ]
        ]
    },
    {
        "id": "8f8a60bf17532e1a",
        "type": "catch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "scope": [
            "66ec07a59aac8c33",
            "8265d52c960b7d9a",
            "6850d9ba5b6543e1",
            "4b9a9332aa1dd5bf",
            "a4dd6731dc099d6e"
        ],
        "uncaught": false,
        "x": 1550,
        "y": 720,
        "wires": [
            [
                "e8ad6f7e634d2e64"
            ]
        ]
    },
    {
        "id": "e8ad6f7e634d2e64",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "400",
        "headers": {},
        "x": 1700,
        "y": 720,
        "wires": []
    },
    {
        "id": "b697adc2da998ce7",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "Capture Params",
        "rules": [
            {
                "t": "set",
                "p": "originalPayload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.hostname",
                "pt": "msg",
                "to": "toCheckHostname",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.username",
                "pt": "msg",
                "to": "toCheckUsername",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 720,
        "wires": [
            [
                "8265d52c960b7d9a"
            ]
        ]
    },
    {
        "id": "c96255ed1fd96108",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "originalPayload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "fa96b87236c98513",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Check required RDS Logout action",
        "info": "",
        "x": 180,
        "y": 680,
        "wires": []
    },
    {
        "id": "c008e982b31aefd0",
        "type": "catch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "scope": [
            "f4ef54cca086aff2"
        ],
        "uncaught": false,
        "x": 1720,
        "y": 480,
        "wires": [
            [
                "6a5358b4eb1826f3"
            ]
        ]
    },
    {
        "id": "6a5358b4eb1826f3",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "create filename",
        "func": "// Adjust this root path as needed\nconst root = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Logs\\\\Node-Red\\\\watchdog\\\\insert_errors\";\n\n// Get the current date and time\nconst now = new Date();\nconst year = now.getFullYear();\nconst monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n];\nconst month = monthNames[now.getMonth()];\nconst day = String(now.getDate()).padStart(2, '0');\n\n// Create a Windows-safe timestamp (e.g. 2025-08-07_15-27-59-123)\nconst ts = now.toISOString()\n    .replace(/:/g, '-')       // Replace colon with dash\n    .replace(/\\..+/, '')      // Remove milliseconds from the ISO string (we'll add them back manually)\n    .replace('T', '_');       // Replace T with _\n\nconst ms = String(now.getMilliseconds()).padStart(3, '0');\nconst filename = `${ts}-${ms}__${msg.bot_name}.json`;\n\n// Build the full file path\nconst path = `${root}\\\\${year}\\\\${month}\\\\${day}\\\\${filename}`;\n\n// Set up for Write File node\nmsg.filename = path;\n\n// The file contents are in msg.payload already\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1890,
        "y": 480,
        "wires": [
            [
                "8b2755fd2ef2cdaa"
            ]
        ]
    },
    {
        "id": "8b2755fd2ef2cdaa",
        "type": "file",
        "z": "1dc165ed61e2f895",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 2050,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "3a77ac89e4785bd3",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Validate Email Address",
        "info": "",
        "x": 140,
        "y": 880,
        "wires": []
    },
    {
        "id": "97af96674df10f6d",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "",
        "url": "/check_email_address",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 920,
        "wires": [
            [
                "0afe410cd1422150"
            ]
        ]
    },
    {
        "id": "e9d0859cba3b9b7b",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1020,
        "y": 960,
        "wires": [
            [
                "a91006681d899745"
            ]
        ]
    },
    {
        "id": "a91006681d899745",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1210,
        "y": 960,
        "wires": [
            [
                "d7e9dea61bcd399e"
            ]
        ]
    },
    {
        "id": "d7e9dea61bcd399e",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Query Email address",
        "func": "// Input: msg.payload.email and msg.access_token\n\nconst email = (msg.email || \"\").trim();\nif (!email) {\n    node.error(\"No email given\", msg);\n    return null;\n}\nmsg.method = \"GET\"\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.payload.access_token\n};\n\n// Direct lookup in Graph\nmsg.url = \"https://graph.microsoft.com/v1.0/users/\" + encodeURIComponent(email);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1420,
        "y": 960,
        "wires": [
            [
                "e2c5a54461e521b8"
            ]
        ]
    },
    {
        "id": "e2c5a54461e521b8",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1630,
        "y": 960,
        "wires": [
            [
                "0d1c76648fb8d548"
            ]
        ]
    },
    {
        "id": "0afe410cd1422150",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "Store Email",
        "rules": [
            {
                "t": "move",
                "p": "payload.email",
                "pt": "msg",
                "to": "email",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 920,
        "wires": [
            [
                "77a058a9a746c4e6"
            ]
        ]
    },
    {
        "id": "77a058a9a746c4e6",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Validate Input",
        "func": "// Node-RED Function: Validate Email Format and Set Status on msg\n\nlet email = msg.email\n\n// Simple regex for email validation\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\nmsg.email = email; // store the email for reference\n\nif (!email) {\n    msg.payload.status = \"error\";\n    msg.payload.status_reason = \"Missing email address\";\n} else if (!emailRegex.test(email)) {\n    msg.payload.status = \"error\";\n    msg.payload.status_reason = \"Invalid email format\";\n} else {\n    msg.payload.status = \"successful\";\n    msg.payload.status_reason = \"Valid email address\";\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 920,
        "wires": [
            [
                "b8f40ba3a238f553"
            ]
        ]
    },
    {
        "id": "b8f40ba3a238f553",
        "type": "switch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "error",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "successful",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 830,
        "y": 920,
        "wires": [
            [
                "faf4cb8641572cab"
            ],
            [
                "e9d0859cba3b9b7b"
            ]
        ]
    },
    {
        "id": "faf4cb8641572cab",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 970,
        "y": 880,
        "wires": []
    },
    {
        "id": "0d1c76648fb8d548",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Create Response",
        "func": "// === Node-RED Function: Normalize Graph API Email Validation Response ===\n\n// Keep original msg reference if needed later\nconst email = msg.email || (msg.payload && msg.payload.mail) || null;\n\n// Initialize output\nlet result = {\n    status: \"\",\n    status_reason: \"\"\n};\n\n// Handle missing payloads safely\nif (!msg.payload) {\n    result.status = \"error\";\n    result.status_reason = \"No payload received\";\n} \n// Graph API errors usually contain a payload.error object\nelse if (msg.payload.error) {\n    result.status = \"error\";\n    const code = msg.payload.error.code || \"UnknownError\";\n    const message = msg.payload.error.message || \"No message provided\";\n    result.status_reason = `${code}: ${message}`;\n}\n// HTTP-level errors without payload.error\nelse if (msg.statusCode && msg.statusCode !== 200) {\n    result.status = \"error\";\n    result.status_reason = `HTTP ${msg.statusCode}`;\n}\n// Successful lookup\nelse if (msg.statusCode === 200 && msg.payload.mail) {\n    result.status = \"success\";\n    result.status_reason = `Valid email (${msg.payload.mail})`;\n}\n// Unexpected successful response (no email field)\nelse if (msg.statusCode === 200) {\n    result.status = \"error\";\n    result.status_reason = \"Response received but no email address found\";\n}\n// Catch-all\nelse {\n    result.status = \"error\";\n    result.status_reason = \"Unrecognized response format\";\n}\n\n// Return structured payload\nmsg.payload = result;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1830,
        "y": 960,
        "wires": [
            [
                "fc4b6e42d81d6954"
            ]
        ]
    },
    {
        "id": "fc4b6e42d81d6954",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 2010,
        "y": 960,
        "wires": []
    },
    {
        "id": "7dfa45b93fd07ffc",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "",
        "url": "/test",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 100,
        "wires": [
            [
                "1914ad26de2dfe7d"
            ]
        ]
    },
    {
        "id": "d5e0392a7c8accf2",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 560,
        "y": 100,
        "wires": []
    },
    {
        "id": "1914ad26de2dfe7d",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "ok",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 100,
        "wires": [
            [
                "d5e0392a7c8accf2"
            ]
        ]
    },
    {
        "id": "c141263a966fd805",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "Test Endpoint",
        "info": "",
        "x": 110,
        "y": 60,
        "wires": []
    },
    {
        "id": "c532f0b6415a2253",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "",
        "url": "/graph_token",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1080,
        "wires": [
            [
                "aa85d9b404ff434b"
            ]
        ]
    },
    {
        "id": "27677a2207608d4c",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1080,
        "wires": [
            [
                "dab791e409c6292b"
            ]
        ]
    },
    {
        "id": "aa85d9b404ff434b",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "req",
                "pt": "msg",
                "to": "original_req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 1080,
        "wires": [
            [
                "27677a2207608d4c"
            ]
        ]
    },
    {
        "id": "dab791e409c6292b",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 830,
        "y": 1080,
        "wires": [
            [
                "e0c847dc0b32e438"
            ]
        ]
    },
    {
        "id": "e0c847dc0b32e438",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.access_token",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1020,
        "y": 1080,
        "wires": [
            [
                "cc1f3f1a255e48ce"
            ]
        ]
    },
    {
        "id": "cc1f3f1a255e48ce",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1190,
        "y": 1080,
        "wires": []
    },
    {
        "id": "50466eb9e29fc642",
        "type": "comment",
        "z": "1dc165ed61e2f895",
        "name": "ECOES CSS Message (Reverse order)",
        "info": "",
        "x": 210,
        "y": 1300,
        "wires": []
    },
    {
        "id": "7fc8d538061fcdfc",
        "type": "http in",
        "z": "1dc165ed61e2f895",
        "name": "",
        "url": "/ecoes_css",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1360,
        "wires": [
            [
                "74cebdbe2356746c"
            ]
        ]
    },
    {
        "id": "74cebdbe2356746c",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "req",
                "pt": "msg",
                "to": "original_req",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "msg.payload.ParameterSets[0].Parameters[0].Value",
                "pt": "msg",
                "to": "mpan",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 1360,
        "wires": [
            [
                "059bb0c83e2be7a0"
            ]
        ]
    },
    {
        "id": "059bb0c83e2be7a0",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "Prepare ECOES CSS Call",
        "func": "// Inputs:\n//   msg.mpan : string (required)\n//\n// Output for HTTP Request node:\n//   msg.url, msg.method, msg.headers, msg.payload\n\nconst API_URL  = \"https://www.ecoes.co.uk/WebServices/Service/ECOESAPI.svc/RESTful/JSON/GetCSSMessages\";\nconst AUTH_KEY = \"52NT-WHHB-D78H-LJSK\";\n\n// Basic validation\nif (!msg || typeof msg.mpan !== \"string\" || msg.mpan.trim() === \"\") {\n    node.error(\"Missing or empty msg.mpan\", msg);\n    return null;\n}\n\nconst mpan = msg.mpan.trim();\n\n// Build request payload exactly like the Python version\nconst payload = {\n    Authentication: { Key: AUTH_KEY },\n    ParameterSets: [\n        {\n            Parameters: [\n                { Key: \"mpan\", Value: mpan }\n            ]\n        }\n    ]\n};\n\n// Prepare msg for HTTP Request node\nmsg.url = API_URL;\nmsg.method = \"POST\";\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n};\nmsg.payload = payload;\n\n// optional trace fields (helpful downstream)\nmsg.ecoes = msg.ecoes || {};\nmsg.ecoes.request = {\n    url: API_URL,\n    mpan\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 1360,
        "wires": [
            [
                "8d5e01f4f0f01ff0"
            ]
        ]
    },
    {
        "id": "8d5e01f4f0f01ff0",
        "type": "http request",
        "z": "1dc165ed61e2f895",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 850,
        "y": 1360,
        "wires": [
            [
                "957981cfc28724ec"
            ]
        ]
    },
    {
        "id": "957981cfc28724ec",
        "type": "function",
        "z": "1dc165ed61e2f895",
        "name": "function 20",
        "func": "// Ensure payload structure exists\nif (!msg.payload || !Array.isArray(msg.payload.Results) || !msg.payload.Results[0] || !Array.isArray(msg.payload.Results[0].Messages)) {\n    node.error(\"Payload structure is invalid or missing Results[0].Messages\", msg);\n    return null;\n}\n\nconst messages = msg.payload.Results[0].Messages;\n\n// helper to extract and parse the event_date\nfunction parseEventDate(message) {\n    try {\n        const eventObj = (message.MessageDetails || []).find(d => d.Key === \"event_date\");\n        if (!eventObj || !eventObj.Value) return null;\n\n        // format dd/mm/yyyy hh:mm:ss.SSS\n        const [datePart, timePart] = eventObj.Value.split(\" \");\n        const [day, month, year] = datePart.split(\"/\").map(Number);\n\n        // handle optional milliseconds\n        const [time, msPart] = timePart.split(\".\");\n        const [hour, minute, second] = time.split(\":\").map(Number);\n        const milliseconds = msPart ? Number(msPart) : 0;\n\n        // construct valid Date object (UTC)\n        return new Date(Date.UTC(year, month - 1, day, hour, minute, second, milliseconds));\n    } catch (err) {\n        node.warn(\"Failed to parse event_date: \" + err.message);\n        return null;\n    }\n}\n\n// sort descending (latest first)\nmessages.sort((a, b) => {\n    const dateA = parseEventDate(a);\n    const dateB = parseEventDate(b);\n\n    if (!dateA && !dateB) return 0;\n    if (!dateA) return 1;\n    if (!dateB) return -1;\n\n    // compare timestamps\n    return dateB.getTime() - dateA.getTime();\n});\n\nmsg.payload.Results[0].Messages = messages;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 1360,
        "wires": [
            [
                "b07837d372ac4c1e"
            ]
        ]
    },
    {
        "id": "b07837d372ac4c1e",
        "type": "change",
        "z": "1dc165ed61e2f895",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1260,
        "y": 1360,
        "wires": [
            [
                "5e6491291a389548"
            ]
        ]
    },
    {
        "id": "5e6491291a389548",
        "type": "http response",
        "z": "1dc165ed61e2f895",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1450,
        "y": 1360,
        "wires": []
    },
    {
        "id": "cb5d35d00a78e3a5",
        "type": "MSSQL",
        "z": "1dc165ed61e2f895",
        "mssqlCN": "4159b2383138607d",
        "name": "Sync",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SET IDENTITY_INSERT aa.bot_developers_qotd_answers ON;\r\n\r\nINSERT INTO aa.bot_developers_qotd_answers\r\n(id, question_id, username, selected_answer,\r\nanswered_at, selected_answer_text, answered_correctly, answer_status)\r\nSELECT d.id, d.question_id, d.username, d.selected_answer,\r\nd.answered_at, d.selected_answer_text, d.answered_correctly, d.answer_status\r\nFROM aa_dev.q_process_a AS d\r\nLEFT JOIN aa.bot_developers_qotd_answers AS a\r\nON a.id = d.id\r\nWHERE a.id IS NULL;\r\n\r\nSET IDENTITY_INSERT aa.bot_developers_qotd_answers OFF;",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 510,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "faee40273b24e88e",
        "type": "delay",
        "z": "1dc165ed61e2f895",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 520,
        "y": 240,
        "wires": [
            [
                "ed309e59113c89d6"
            ]
        ]
    },
    {
        "id": "918954ba57647e57",
        "type": "subflow:c4217fb89f6015dc",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 270,
        "y": 240,
        "wires": [
            [
                "533c9d5f5e64522a"
            ]
        ]
    },
    {
        "id": "533c9d5f5e64522a",
        "type": "switch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 385,
        "y": 240,
        "wires": [
            [
                "faee40273b24e88e",
                "cb5d35d00a78e3a5"
            ]
        ],
        "l": false
    },
    {
        "id": "f279b72b02a97370",
        "type": "subflow:c4217fb89f6015dc",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 270,
        "y": 480,
        "wires": [
            [
                "93ece5d5be42eee9"
            ]
        ]
    },
    {
        "id": "93ece5d5be42eee9",
        "type": "switch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 395,
        "y": 480,
        "wires": [
            [
                "c2f2d2db4922b9de"
            ]
        ],
        "l": false
    },
    {
        "id": "227e226d5e62e5fb",
        "type": "subflow:c4217fb89f6015dc",
        "z": "1dc165ed61e2f895",
        "name": "",
        "x": 310,
        "y": 600,
        "wires": [
            [
                "a8081811d0ec291d"
            ]
        ]
    },
    {
        "id": "a8081811d0ec291d",
        "type": "switch",
        "z": "1dc165ed61e2f895",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 435,
        "y": 600,
        "wires": [
            [
                "24b95ff362579bbc"
            ]
        ],
        "l": false
    },
    {
        "id": "inject_test",
        "type": "inject",
        "z": "token_validation_flow",
        "name": "Test Token Validation",
        "props": [
            {
                "p": "token",
                "v": "YOUR_JWT_TOKEN_HERE",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 100,
        "wires": [
            [
                "token_validation_request"
            ]
        ]
    },
    {
        "id": "token_validation_request",
        "type": "function",
        "z": "token_validation_flow",
        "name": "Token Validation Request",
        "func": "// Node-RED Function: Test Authentication Token Validity\n// This function tests if an authentication token for Control Room API is still valid\n// Returns: msg.tokenValid (boolean) - true if valid, false if invalid\n// Usage: Place this function after the authentication node in your flow\n\n// Configuration\nconst BASE_URL = \"https://inspired-1.my.automationanywhere.digital\";\nconst TEST_ENDPOINT = `${BASE_URL}/v1/globalvalues/details/list`;\n\n// Function to build the token validation request\nfunction buildTokenValidationRequest() {\n    // Use a simple, lightweight API call to test token validity\n    // The global values list endpoint is ideal as it requires authentication but returns minimal data\n    const requestBody = {\n        \"sort\": [{\n            \"field\": \"name\",\n            \"direction\": \"asc\"\n        }],\n        \"filter\": {},\n        \"fields\": [],\n        \"page\": {\n            \"length\": 1,  // Request only 1 record to minimize response size\n            \"offset\": 0\n        }\n    };\n\n    return {\n        url: TEST_ENDPOINT,\n        method: \"POST\",\n        headers: {\n            'Content-Type': 'application/json',\n            'X-Authorization': msg.token\n        },\n        body: JSON.stringify(requestBody)\n    };\n}\n\n// Check if authentication token is available\nif (!msg.token) {\n    node.error(\"Authentication token (msg.token) is required for validation.\", msg);\n    msg.tokenValid = false;\n    msg.validationError = \"No token provided\";\n    return msg;\n}\n\n// Log the validation attempt\nnode.log(\"Testing authentication token validity...\");\n\n// Build the validation request\nconst validationRequest = buildTokenValidationRequest();\n\n// Configure the HTTP request\nmsg.url = validationRequest.url;\nmsg.method = validationRequest.method;\nmsg.headers = validationRequest.headers;\nmsg.payload = validationRequest.body;\n\n// Store original token for reference\nmsg.originalToken = msg.token;\n\n// Add metadata for tracking\nmsg.validationMetadata = {\n    testTimestamp: new Date().toISOString(),\n    endpoint: TEST_ENDPOINT,\n    purpose: \"token_validation\"\n};\n\n// The response will be processed by the next node in the flow\n// Expected response processing:\n// - Status 200: Token is valid (msg.tokenValid = true)\n// - Status 401/403: Token is invalid or expired (msg.tokenValid = false)\n// - Other status: Network/API error (msg.tokenValid = false, check msg.validationError)\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 100,
        "wires": [
            [
                "http_request"
            ]
        ]
    },
    {
        "id": "http_request",
        "type": "http request",
        "z": "token_validation_flow",
        "name": "API Call",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 580,
        "y": 100,
        "wires": [
            [
                "token_validation_response"
            ]
        ]
    },
    {
        "id": "token_validation_response",
        "type": "function",
        "z": "token_validation_flow",
        "name": "Token Validation Response",
        "func": "// Node-RED Function: Process Token Validation Response\n// This function processes the HTTP response from the token validation API call\n// Sets: msg.tokenValid (boolean) - true if valid, false if invalid\n// Usage: Place this function after the HTTP request node in your token validation flow\n\n// Log the response details for debugging\nnode.log(`Token validation response received. Status: ${msg.statusCode}`);\n\n// Initialize validation result\nlet tokenValid = false;\nlet validationError = null;\n\n// Process the HTTP response\nswitch (msg.statusCode) {\n    case 200:\n        // Success - token is valid\n        tokenValid = true;\n        node.log(\"✅ Authentication token is VALID\");\n        break;\n        \n    case 401:\n        // Unauthorized - token is invalid or expired\n        tokenValid = false;\n        validationError = \"Token is invalid or expired (401 Unauthorized)\";\n        node.log(\"❌ Authentication token is INVALID - 401 Unauthorized\");\n        break;\n        \n    case 403:\n        // Forbidden - token may be valid but lacks permissions\n        tokenValid = false;\n        validationError = \"Token lacks required permissions (403 Forbidden)\";\n        node.log(\"❌ Authentication token is INVALID - 403 Forbidden\");\n        break;\n        \n    case 404:\n        // Not Found - endpoint may not exist or token is invalid\n        tokenValid = false;\n        validationError = \"API endpoint not found (404) - check URL or token\";\n        node.log(\"❌ Authentication token validation failed - 404 Not Found\");\n        break;\n        \n    case 500:\n    case 502:\n    case 503:\n    case 504:\n        // Server errors - token validity uncertain\n        tokenValid = false;\n        validationError = `API server error (${msg.statusCode}) - token validity uncertain`;\n        node.log(`⚠️ API server error during token validation - ${msg.statusCode}`);\n        break;\n        \n    default:\n        // Other status codes - treat as invalid\n        tokenValid = false;\n        validationError = `Unexpected response status (${msg.statusCode})`;\n        node.log(`❌ Unexpected response during token validation - ${msg.statusCode}`);\n        break;\n}\n\n// Set the validation result\nmsg.tokenValid = tokenValid;\n\n// Set error details if validation failed\nif (!tokenValid && validationError) {\n    msg.validationError = validationError;\n}\n\n// Add response details to metadata\nif (msg.validationMetadata) {\n    msg.validationMetadata.responseStatus = msg.statusCode;\n    msg.validationMetadata.responseTimestamp = new Date().toISOString();\n    msg.validationMetadata.validationResult = tokenValid;\n    \n    if (validationError) {\n        msg.validationMetadata.error = validationError;\n    }\n}\n\n// Preserve the original response payload for debugging if needed\nmsg.originalResponse = {\n    statusCode: msg.statusCode,\n    payload: msg.payload,\n    headers: msg.headers\n};\n\n// Log final result\nconst resultMessage = tokenValid ? \n    \"Token validation PASSED ✅\" : \n    `Token validation FAILED ❌ - ${validationError || 'Unknown error'}`;\n    \nnode.log(resultMessage);\n\n// Return the message with validation results\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 100,
        "wires": [
            [
                "debug_result"
            ]
        ]
    },
    {
        "id": "debug_result",
        "type": "debug",
        "z": "token_validation_flow",
        "name": "Token Validation Result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "{\n   \"tokenValid\": tokenValid,\n   \"validationError\": validationError,\n   \"validationMetadata\": validationMetadata\n}",
        "targetType": "jsonata",
        "statusVal": "",
        "statusType": "auto",
        "x": 1070,
        "y": 100,
        "wires": []
    },
    {
        "id": "93890ae4b5326ac4",
        "type": "function",
        "z": "36cc116f1f3383e8",
        "name": "Pagination Controller",
        "func": "const TOKEN = msg.payload.token;\nconst BASE_URL = msg.baseUrl || \"https://inspired-1.my.automationanywhere.digital\";\n\n// Initialize pagination state on first run\nif (!global.get(\"botsPaginationState\")) {\n    const initialState = {\n        offset: 0,\n        pageSize: 1000,\n        allResults: [],\n        totalRecords: 0,\n        currentPage: 1,\n        isComplete: false,\n        environment: msg.environment,\n        baseUrl: BASE_URL,\n        token: TOKEN,\n        startTime: new Date().toISOString()\n    };\n    \n    global.set(\"botsPaginationState\", initialState);\n    node.status({fill:\"blue\", shape:\"ring\", text:\"Starting collection...\"});\n}\n\nconst state = global.get(\"botsPaginationState\");\n\n// If collection is complete, return final results\nif (state.isComplete) {\n    const finalResults = {\n        environment: state.environment,\n        totalRecords: state.totalRecords,\n        recordsCollected: state.allResults.length,\n        data: state.allResults,\n        collectionComplete: true,\n        startTime: state.startTime,\n        endTime: new Date().toISOString(),\n        duration: new Date() - new Date(state.startTime)\n    };\n    \n    node.status({fill:\"green\", shape:\"dot\", text:`Complete: ${finalResults.recordsCollected} records`});\n    \n    // Clean up global state\n    global.set(\"botsPaginationState\", null);\n    \n    msg.payload = finalResults;\n    return [null, msg]; // Send to final output\n}\n\n// Prepare API request for current page\nmsg.url = `${BASE_URL}/v3/activity/list`;\nmsg.method = \"POST\";\nmsg.headers = { \n    \"Content-Type\": \"application/json\", \n    \"accept\": \"application/json\", \n    \"X-Authorization\": TOKEN \n};\n\nmsg.payload = {\n    \"filter\": {\n        \"operator\": \"and\",\n        \"operands\": [],  // No filters - get ALL bots\n        \"sort\": [\n            {\n                \"field\": \"startDateTime\",\n                \"direction\": \"desc\"\n            }\n        ]\n    },\n    \"page\": {\n        \"offset\": state.offset,\n        \"length\": state.pageSize\n    }\n};\n\nnode.status({\n    fill: \"blue\", \n    shape: \"dot\", \n    text: `Page ${state.currentPage} (${state.offset})`\n});\n\n// Store current state for next iteration\nmsg.paginationState = state;\n\nreturn [msg, null]; // Send to HTTP request",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 60,
        "wires": [
            [
                "2c55d8c13b7dc1ad"
            ],
            [
                "7e85384318df0f1c"
            ]
        ]
    },
    {
        "id": "2c55d8c13b7dc1ad",
        "type": "http request",
        "z": "36cc116f1f3383e8",
        "name": "Fetch Bot Data",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 860,
        "y": 60,
        "wires": [
            [
                "c78e70e81e16dd7c"
            ]
        ]
    },
    {
        "id": "c78e70e81e16dd7c",
        "type": "function",
        "z": "36cc116f1f3383e8",
        "name": "Process API Response",
        "func": "// Handle API response and manage pagination\nif (!msg.payload || !msg.payload.list) {\n    node.error(\"Invalid API response\", msg);\n    node.status({fill:\"red\", shape:\"dot\", text:\"API Error\"});\n    return null;\n}\n\nconst state = global.get(\"botsPaginationState\");\nif (!state) {\n    node.error(\"Pagination state lost\", msg);\n    return null;\n}\n\n// Add current page results to collection\nconst currentPageData = msg.payload.list || [];\nstate.allResults = state.allResults.concat(currentPageData);\n\n// Set total from first response\nif (state.totalRecords === 0 && msg.payload.page && msg.payload.page.total) {\n    state.totalRecords = msg.payload.page.total;\n}\n\n// Update progress\nconst currentCount = state.allResults.length;\nconst totalRecords = state.totalRecords;\nconst progress = totalRecords > 0 ? Math.round((currentCount / totalRecords) * 100) : 0;\n\nnode.status({\n    fill: \"blue\", \n    shape: \"ring\", \n    text: `${currentCount}/${totalRecords} (${progress}%)`\n});\n\n// Log progress\nnode.warn(`Page ${state.currentPage}: +${currentPageData.length} records. Total: ${currentCount}/${totalRecords} (${progress}%)`);\n\n// Check if we have all records\nconst hasMorePages = currentCount < totalRecords && currentPageData.length === state.pageSize;\n\nif (hasMorePages) {\n    // Prepare for next page\n    state.offset += state.pageSize;\n    state.currentPage += 1;\n    \n    // Update global state\n    global.set(\"botsPaginationState\", state);\n    \n    // Small delay to prevent API overload\n    setTimeout(() => {\n        // Create a new message to loop back\n        const nextMsg = {\n            payload: { token: state.token },\n            environment: state.environment,\n            baseUrl: state.baseUrl\n        };\n        node.send(nextMsg);\n    }, 100);\n    \n    return null; // Don't send anything immediately\n} else {\n    // Collection complete\n    state.isComplete = true;\n    global.set(\"botsPaginationState\", state);\n    \n    node.warn(`🎉 Collection complete! Total records: ${currentCount}`);\n    \n    // Send back for final processing\n    const finalMsg = {\n        payload: { token: state.token },\n        environment: state.environment,\n        baseUrl: state.baseUrl\n    };\n    \n    return finalMsg;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 60,
        "wires": [
            [
                "93890ae4b5326ac4"
            ]
        ]
    },
    {
        "id": "7e85384318df0f1c",
        "type": "debug",
        "z": "36cc116f1f3383e8",
        "name": "Final Results (All 30K+ Bots)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 140,
        "wires": []
    },
    {
        "id": "468379c973503a68",
        "type": "inject",
        "z": "36cc116f1f3383e8",
        "name": "Start All Bots Collection",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "f1935b4907380145",
        "type": "inject",
        "z": "36cc116f1f3383e8",
        "name": "🔄 Reset State (if stuck)",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 150,
        "y": 140,
        "wires": [
            [
                "37ee30e4db6eae8e"
            ]
        ]
    },
    {
        "id": "37ee30e4db6eae8e",
        "type": "function",
        "z": "36cc116f1f3383e8",
        "name": "Clear Global State",
        "func": "global.set(\"botsPaginationState\", null);\nnode.status({fill:\"yellow\", shape:\"dot\", text:\"State cleared\"});\nmsg.payload = \"Pagination state has been reset\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 140,
        "wires": [
            [
                "92672e6268277f36"
            ]
        ]
    },
    {
        "id": "92672e6268277f36",
        "type": "debug",
        "z": "36cc116f1f3383e8",
        "name": "Reset Confirmation",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 140,
        "wires": []
    },
    {
        "id": "535c09e1cbd5f2f2",
        "type": "inject",
        "z": "885f4ac2cb49a2c1",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 140,
        "wires": [
            [
                "4f4421d6bae9f94d"
            ]
        ]
    },
    {
        "id": "4f4421d6bae9f94d",
        "type": "MSSQL",
        "z": "885f4ac2cb49a2c1",
        "mssqlCN": "4159b2383138607d",
        "name": "Get Bots",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT [id], [bot_name], [date_added], [added_by], [deleted], [expected_frequency_hours], [hours_until_critical], [receives_notifications] as 'notifications_turned_on', [notification_minutes_trigger], [aa_bot_id], [expected_runtime_minutes], [roi_type], [bot_name_calculated], [auto_deleted]\r\nFROM aa.bots as b\r\nWHERE b.deleted = 0",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 410,
        "y": 140,
        "wires": [
            [
                "30b5c474d3c943df",
                "5ba919d6c16bf36a"
            ]
        ]
    },
    {
        "id": "30b5c474d3c943df",
        "type": "debug",
        "z": "885f4ac2cb49a2c1",
        "name": "debug 31",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 570,
        "y": 160,
        "wires": []
    },
    {
        "id": "38cff0a979cbc454",
        "type": "http in",
        "z": "885f4ac2cb49a2c1",
        "name": "",
        "url": "/get_bots",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 280,
        "y": 200,
        "wires": [
            [
                "4f4421d6bae9f94d"
            ]
        ]
    },
    {
        "id": "5ba919d6c16bf36a",
        "type": "http response",
        "z": "885f4ac2cb49a2c1",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 670,
        "y": 220,
        "wires": []
    },
    {
        "id": "ac30f03a73f74376",
        "type": "function",
        "z": "e295b550a1e2af80",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 80,
        "wires": [
            [
                "ef2be190cea7234e"
            ]
        ]
    },
    {
        "id": "ef2be190cea7234e",
        "type": "http request",
        "z": "e295b550a1e2af80",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1290,
        "y": 80,
        "wires": [
            [
                "6bc6118e96e35967"
            ]
        ]
    },
    {
        "id": "85b7f9bd922deb58",
        "type": "function",
        "z": "e295b550a1e2af80",
        "name": "create subfolder",
        "func": "// Configuration\nconst sharedMailbox = msg.email;\nconst newFolderName = msg.folder; // change this to your desired subfolder name\n\n// Build the HTTP request\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.payload.access_token,\n    \"Content-Type\": \"application/json\"\n};\n\n// Endpoint: POST to the childFolders of the Inbox\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/Inbox/childFolders`;\nmsg.method = \"POST\";\n\n// Body: specify the displayName of the new folder\nmsg.payload = {\n    \"displayName\": newFolderName\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2000,
        "y": 80,
        "wires": [
            [
                "276fe43905266566"
            ]
        ]
    },
    {
        "id": "276fe43905266566",
        "type": "http request",
        "z": "e295b550a1e2af80",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2230,
        "y": 80,
        "wires": [
            [
                "ae0eeee52a7ad9ea"
            ]
        ]
    },
    {
        "id": "08f8ae2c33302143",
        "type": "http in",
        "z": "e295b550a1e2af80",
        "name": "",
        "url": "/create_inbox_folder",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 100,
        "wires": [
            [
                "560d430cd92376bc"
            ]
        ]
    },
    {
        "id": "560d430cd92376bc",
        "type": "change",
        "z": "e295b550a1e2af80",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload.email",
                "pt": "msg",
                "to": "email",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.folder",
                "pt": "msg",
                "to": "folder",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 100,
        "wires": [
            [
                "c8259ce50c0fa0a5"
            ]
        ]
    },
    {
        "id": "c8259ce50c0fa0a5",
        "type": "function",
        "z": "e295b550a1e2af80",
        "name": "function 14",
        "func": "// Validate required inputs\nconst requiredFields = [\"email\", \"folder\"];\nlet missingFields = [];\n\nfor (const field of requiredFields) {\n    if (\n        msg[field] === undefined ||\n        msg[field] === null ||\n        (typeof msg[field] === \"string\" && msg[field].trim() === \"\")\n    ) {\n        missingFields.push(field);\n    }\n}\n\nif (missingFields.length > 0) {\n    msg.payload = {\n        status: \"error\",\n        status_message: `Missing required inputs: ${missingFields.join(\", \")}`\n    };\n    msg.input_valid = false;\n} else {\n    msg.input_valid = true;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 100,
        "wires": [
            [
                "c867625b55549c3f"
            ]
        ]
    },
    {
        "id": "c867625b55549c3f",
        "type": "switch",
        "z": "e295b550a1e2af80",
        "name": "Has Valid Inputs",
        "property": "input_valid",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 840,
        "y": 100,
        "wires": [
            [
                "ac30f03a73f74376"
            ],
            [
                "dc9ec48a3c3e6676"
            ]
        ]
    },
    {
        "id": "307ff1a2ae21dcfb",
        "type": "http response",
        "z": "e295b550a1e2af80",
        "name": "Missing Inputs",
        "statusCode": "400",
        "headers": {},
        "x": 1120,
        "y": 140,
        "wires": []
    },
    {
        "id": "47822ae3970a18d8",
        "type": "switch",
        "z": "e295b550a1e2af80",
        "name": "Token Successful",
        "property": "token_successful",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1750,
        "y": 80,
        "wires": [
            [
                "85b7f9bd922deb58"
            ],
            [
                "e2817b9091d429db"
            ]
        ]
    },
    {
        "id": "6bc6118e96e35967",
        "type": "function",
        "z": "e295b550a1e2af80",
        "name": "Check Token Response",
        "func": "if (msg.statusCode === 200){\n    msg.token_successful = true\n} else {\n    msg.token_successful = false\n    msg.payload = {\n        \"status\": \"error\",\n        \"status_reason\": msg.payload.error_description\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1510,
        "y": 80,
        "wires": [
            [
                "47822ae3970a18d8"
            ]
        ]
    },
    {
        "id": "7b256b0519345c11",
        "type": "http response",
        "z": "e295b550a1e2af80",
        "name": "Missing Token",
        "statusCode": "400",
        "headers": {},
        "x": 2060,
        "y": 140,
        "wires": []
    },
    {
        "id": "e2817b9091d429db",
        "type": "change",
        "z": "e295b550a1e2af80",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1935,
        "y": 140,
        "wires": [
            [
                "7b256b0519345c11"
            ]
        ],
        "l": false
    },
    {
        "id": "dc9ec48a3c3e6676",
        "type": "change",
        "z": "e295b550a1e2af80",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 995,
        "y": 140,
        "wires": [
            [
                "307ff1a2ae21dcfb"
            ]
        ],
        "l": false
    },
    {
        "id": "ae0eeee52a7ad9ea",
        "type": "function",
        "z": "e295b550a1e2af80",
        "name": "Check Outcome",
        "func": "// Default outputs\nmsg.folder_created = false;\n\n// Safely parse payload if it's a string\nif (typeof msg.payload === \"string\") {\n    try {\n        msg.payload = JSON.parse(msg.payload);\n    } catch (e) {\n        msg.statusCode = 500;\n        msg.payload = {\n            status: \"error\",\n            status_reason: \"Invalid JSON payload received.\"\n        };\n        return msg;\n    }\n}\n\n// Check for error payload\nif (msg.payload.error) {\n    const errCode = msg.payload.error.code || \"UnknownError\";\n    const errMsg = msg.payload.error.message || \"An unknown error occurred.\";\n\n    msg.statusCode = 400;\n    msg.payload = {\n        status: \"error\",\n        status_reason: `${errCode}: ${errMsg}`\n    };\n    msg.folder_created = false;\n\n} else if (msg.payload.displayName && msg.email && msg.folder) {\n    // Success case\n    msg.statusCode = 200;\n    msg.payload = {\n        status: \"successful\",\n        status_reason: `Successfully created a subfolder called '${msg.folder}' in the mailbox for '${msg.email}'`\n    };\n    msg.folder_created = true;\n\n} else {\n    // Unexpected structure\n    msg.statusCode = 500;\n    msg.payload = {\n        status: \"error\",\n        status_reason: \"Unexpected response format.\"\n    };\n    msg.folder_created = false;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2420,
        "y": 80,
        "wires": [
            [
                "00af097faf014d4f"
            ]
        ]
    },
    {
        "id": "00af097faf014d4f",
        "type": "switch",
        "z": "e295b550a1e2af80",
        "name": "Folder Created",
        "property": "folder_created",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2620,
        "y": 80,
        "wires": [
            [
                "b53a9387da9afc48"
            ],
            [
                "e174c5b8e78dd4ff"
            ]
        ]
    },
    {
        "id": "e174c5b8e78dd4ff",
        "type": "change",
        "z": "e295b550a1e2af80",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2765,
        "y": 120,
        "wires": [
            [
                "b2ba2b4ae6f67263"
            ]
        ],
        "l": false
    },
    {
        "id": "b2ba2b4ae6f67263",
        "type": "http response",
        "z": "e295b550a1e2af80",
        "name": "Final Respose (Error)",
        "statusCode": "400",
        "headers": {},
        "x": 2910,
        "y": 120,
        "wires": []
    },
    {
        "id": "b53a9387da9afc48",
        "type": "change",
        "z": "e295b550a1e2af80",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "original_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2765,
        "y": 40,
        "wires": [
            [
                "8b5cf84a3e034b4c"
            ]
        ],
        "l": false
    },
    {
        "id": "8b5cf84a3e034b4c",
        "type": "http response",
        "z": "e295b550a1e2af80",
        "name": "Final Respose (Success)",
        "statusCode": "200",
        "headers": {},
        "x": 2920,
        "y": 40,
        "wires": []
    },
    {
        "id": "3e6627ceba829d68",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 120,
        "wires": [
            [
                "afeef76e124e6b1b"
            ]
        ]
    },
    {
        "id": "afeef76e124e6b1b",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 120,
        "wires": [
            [
                "59b8610c86c0d06a"
            ]
        ]
    },
    {
        "id": "59b8610c86c0d06a",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 590,
        "y": 120,
        "wires": [
            [
                "2cc588a3133416fe"
            ]
        ]
    },
    {
        "id": "2cc588a3133416fe",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Query Inboxes",
        "func": "// Replace 'RPA_Disconnections' with the actual email address if needed, e.g., rpa_disconnections@inspiredenergy.co.uk.com\nconst sharedMailbox = 'ebills@inspiredenergy.co.uk';\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.payload.access_token\n};\n// msg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/Inbox/messages?$count=true`;\n// msg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/AAMkADgzMTFmNjBiLWM3OTctNGE5OS1hNDRiLWM5NTVhNTZjMTZjZAAuAAAAAAD7z-Lko01kQrz-pG5zfbXKAQCitUY3BjuiQq0YQcJNuoNsAAE1RlmSAAA=/childFolders`;\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/AAMkADgzMTFmNjBiLWM3OTctNGE5OS1hNDRiLWM5NTVhNTZjMTZjZAAuAAAAAAD7z-Lko01kQrz-pG5zfbXKAQCitUY3BjuiQq0YQcJNuoNsAAE1RlmSAAA=/messages?$count=true`;\nmsg.method = \"GET\";\nmsg.payload = null; // GET request, no body\nreturn msg;\n\n\n`\nRegent Gas\nAAMkADgzMTFmNjBiLWM3OTctNGE5OS1hNDRiLWM5NTVhNTZjMTZjZAAuAAAAAAD7z-Lko01kQrz-pG5zfbXKAQCitUY3BjuiQq0YQcJNuoNsAAE1RlmSAAA=\n\nN Power\nAAMkADgzMTFmNjBiLWM3OTctNGE5OS1hNDRiLWM5NTVhNTZjMTZjZAAuAAAAAAD7z-Lko01kQrz-pG5zfbXKAQCitUY3BjuiQq0YQcJNuoNsAAE1RlmRAAA=\n\nEDF\nAAMkADgzMTFmNjBiLWM3OTctNGE5OS1hNDRiLWM5NTVhNTZjMTZjZAAuAAAAAAD7z-Lko01kQrz-pG5zfbXKAQCitUY3BjuiQq0YQcJNuoNsAAE1RlmQAAA=\n`",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 120,
        "wires": [
            [
                "afc8a1d3d1d28dd1"
            ]
        ]
    },
    {
        "id": "afc8a1d3d1d28dd1",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1090,
        "y": 120,
        "wires": [
            [
                "34ad70d591315a24"
            ]
        ]
    },
    {
        "id": "34ad70d591315a24",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 24",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1280,
        "y": 120,
        "wires": []
    },
    {
        "id": "36cfa03b661f08f3",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 260,
        "wires": [
            [
                "755561877f7302f8"
            ]
        ]
    },
    {
        "id": "755561877f7302f8",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 260,
        "wires": [
            [
                "0b511d9ac4857cc1"
            ]
        ]
    },
    {
        "id": "0b511d9ac4857cc1",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 560,
        "y": 260,
        "wires": [
            [
                "4946337adf5639d2"
            ]
        ]
    },
    {
        "id": "4946337adf5639d2",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Query Email address",
        "func": "// Input: msg.payload.email and msg.access_token\n\n// const email = (msg.payload.email || \"\").trim();\nconst email = 'jane.hong@inspiredenergy.co.uk'\nif (!email) {\n    node.error(\"No email given\", msg);\n    return null;\n}\nmsg.method = \"GET\"\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.payload.access_token\n};\n\n// Direct lookup in Graph\nmsg.url = \"https://graph.microsoft.com/v1.0/users/\" + encodeURIComponent(email);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 260,
        "wires": [
            [
                "6d5e9c45a6de7c38"
            ]
        ]
    },
    {
        "id": "6d5e9c45a6de7c38",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 980,
        "y": 260,
        "wires": [
            [
                "6c88c20a7ae7ee1f"
            ]
        ]
    },
    {
        "id": "e5bf4daebc248eab",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1360,
        "y": 260,
        "wires": []
    },
    {
        "id": "0c2e4c216479c6f0",
        "type": "http in",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "url": "/test-graph",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 320,
        "wires": [
            [
                "755561877f7302f8"
            ]
        ]
    },
    {
        "id": "6c88c20a7ae7ee1f",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "function 2",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 260,
        "wires": [
            [
                "e5bf4daebc248eab"
            ]
        ]
    },
    {
        "id": "start",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "Trigger manually",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "access_token",
                "v": "eyJ0eXAiOiJKV1QiLCJub25jZSI6InBtUzJKUXJja0E4RUFhdER4R1hEeE5sY0JTSGhjUF9Sc0ZUVVNJYllwdzgiLCJhbGciOiJSUzI1NiIsIng1dCI6IkhTMjNiN0RvN1RjYVUxUm9MSHdwSXEyNFZZZyIsImtpZCI6IkhTMjNiN0RvN1RjYVUxUm9MSHdwSXEyNFZZZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mOGQ2OTY4OC1kZTM5LTQ1MzYtOTYxYy1kYjg3ZmI5YzhmMjAvIiwiaWF0IjoxNzYwNjkzMDE5LCJuYmYiOjE3NjA2OTMwMTksImV4cCI6MTc2MDY5NjkxOSwiYWlvIjoiazJKZ1lHRDhiTlo2YmVQcCtjc0xjdTF2YjVEU0JnQT0iLCJhcHBfZGlzcGxheW5hbWUiOiJBQS0zNjAtT0FVVEggLSBMaXZlIiwiYXBwaWQiOiIxZDM3YzY4ZC03OWMyLTQyNjctOTY1OS1lNjcwMjc5M2MyZjUiLCJhcHBpZGFjciI6IjEiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mOGQ2OTY4OC1kZTM5LTQ1MzYtOTYxYy1kYjg3ZmI5YzhmMjAvIiwiaWR0eXAiOiJhcHAiLCJvaWQiOiJjZjA2YTVlNS1lZjYxLTQzODUtYmJkMi1jODI5NTRiYTFkODIiLCJyaCI6IjEuQVRBQWlKYlctRG5lTmtXV0hOdUgtNXlQSUFNQUFBQUFBQUFBd0FBQUFBQUFBQUJEQVFBd0FBLiIsInJvbGVzIjpbIlVzZXIuUmVhZEJhc2ljLkFsbCIsIk1haWwuUmVhZFdyaXRlIiwiTWFpbC5TZW5kIl0sInN1YiI6ImNmMDZhNWU1LWVmNjEtNDM4NS1iYmQyLWM4Mjk1NGJhMWQ4MiIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJFVSIsInRpZCI6ImY4ZDY5Njg4LWRlMzktNDUzNi05NjFjLWRiODdmYjljOGYyMCIsInV0aSI6IlJ4akd4M0RmbkVDU1pZSjhLa0JJQUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjA5OTdhMWQwLTBkMWQtNGFjYi1iNDA4LWQ1Y2E3MzEyMWU5MCJdLCJ4bXNfYWNkIjoxNzE2MzY5Njk2LCJ4bXNfYWN0X2ZjdCI6IjMgOSIsInhtc19mdGQiOiJPcUo0UG5sMndXMTZJMlpCUDJCM3JvNE5rUEFPUjAzZEUtaFpSZDB2YjkwQlpYVnliM0JsZDJWemRDMWtjMjF6IiwieG1zX2lkcmVsIjoiNyAxNCIsInhtc19yZCI6IjAuNDJMbFlCSmlOQkFTNFdBWEVvaWJ1R2lpajEyWTJ3eXBqSWQ3dDB3LUN4VGxGQkk0dFd4SnZHUzl2dHVXRF81bG14eW43Z1dLY2dnSk1ETkF3QUVvRFFBIiwieG1zX3N1Yl9mY3QiOiI5IDMiLCJ4bXNfdGNkdCI6MTUwNDc5NzMxNiwieG1zX3RudF9mY3QiOiIzIDQifQ.DrrzcljmLqHp1kupdNhx1W_D9SZSZ6RxH9sCXSgBqls7MVv45UQui5qYOhkl7aV-fzQdn1JiLdZpecFOPYb8oQwL6qwLgie6QfGhWIjpEwaPGHkUcvfNTq1VjIps2hQvccZtirMEebPnO0zUqsv0XoHY30n5mahER38krbsmDD64EFI0xPc0Fzsdquo9pp9EFcP4L9iXQaqocxi44ovuzVoxg-ljQaFYtgyF6EjGkSstRzKjQL48-WRA1XKoRz8iypXEzs5MGVPNa1ATS6VgSxwPktGCsLrag3uRwsIGoXzBmZtN0N0Es4GiaRPqChTrmJtfQDdaiEJ0thCxx-Hq6w",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "x": 200,
        "y": 500,
        "wires": [
            [
                "build_list"
            ]
        ]
    },
    {
        "id": "build_list",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Build Graph GET latest from Inbox",
        "func": "// Build Graph GET latest from Inbox\nconst token = (msg.payload && msg.payload.access_token) || msg.access_token;\nif (!token) {\n    node.error(\"Missing access_token on msg.payload.access_token or msg.access_token\", msg);\n    return null;\n}\n\nconst sharedMailbox = \"bpi_reporting@inspiredenergy.co.uk\";\n\n// Save auth separately so it survives the HTTP node\nmsg.graphAuth = \"Bearer \" + token;\n\nmsg.headers = { Authorization: msg.graphAuth };\nmsg.method = \"GET\";\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/Inbox/messages?$top=1&$orderby=receivedDateTime desc&$select=id,subject,receivedDateTime,from`;\nmsg.payload = null;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 500,
        "wires": [
            [
                "http_list"
            ]
        ]
    },
    {
        "id": "http_list",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "HTTP GET messages",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "persist": false,
        "authType": "",
        "senderr": false,
        "x": 800,
        "y": 500,
        "wires": [
            [
                "build_forward",
                "a199cd3b6a8c035d"
            ]
        ]
    },
    {
        "id": "build_forward",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Build Graph POST forward",
        "func": "// Build Graph POST forward\nif (!msg.payload || !Array.isArray(msg.payload.value) || msg.payload.value.length === 0) {\n    node.warn(\"No messages found in Inbox\");\n    return null;\n}\n\nconst message = msg.payload.value[0];\nconst messageId = message.id;\n\nconst sharedMailbox = \"bpiautomation@inspiredenergy.co.uk\";\nconst forwardTo = \"stuart.ramsay@inspiredenergy.co.uk\";\n\n// Rebuild headers using saved auth\nconst auth = msg.graphAuth || (msg.access_token ? \"Bearer \" + msg.access_token : null) || ((msg.payload && msg.payload.access_token) ? \"Bearer \" + msg.payload.access_token : null);\n\nif (!auth) {\n    node.error(\"Missing auth token for forward call\", msg);\n    return null;\n}\n\nmsg.headers = {\n    Authorization: auth,\n    \"Content-Type\": \"application/json\"\n};\n\nmsg.method = \"POST\";\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/messages/${messageId}/forward`;\nmsg.payload = {\n    comment: \"Test forward from Node-RED\",\n    toRecipients: [\n        { emailAddress: { address: forwardTo } }\n    ]\n};\n\nmsg.originalMessage = {\n    id: messageId,\n    subject: message.subject,\n    receivedDateTime: message.receivedDateTime,\n    from: message.from\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 580,
        "wires": [
            [
                "http_forward",
                "dbg_built"
            ]
        ]
    },
    {
        "id": "http_forward",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "HTTP POST forward",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "persist": false,
        "authType": "",
        "senderr": false,
        "x": 800,
        "y": 580,
        "wires": [
            [
                "dbg_result"
            ]
        ]
    },
    {
        "id": "dbg_built",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "Inspect forward payload",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 640,
        "wires": []
    },
    {
        "id": "dbg_result",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "Forward result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 580,
        "wires": []
    },
    {
        "id": "a199cd3b6a8c035d",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 21",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 500,
        "wires": []
    },
    {
        "id": "6becd20858483dd7",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 420,
        "y": 880,
        "wires": [
            [
                "7bb92d3f113fc515"
            ]
        ]
    },
    {
        "id": "7bb92d3f113fc515",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 940,
        "wires": [
            [
                "29ae7517655e1ff5"
            ]
        ]
    },
    {
        "id": "29ae7517655e1ff5",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 890,
        "y": 940,
        "wires": [
            [
                "9f83382ce3270f93",
                "51827fdfdade6e6a",
                "12c7dcd146eb2da8"
            ]
        ]
    },
    {
        "id": "9f83382ce3270f93",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Foward Email",
        "func": "\n\nconst message = \"TEST\"\nconst messageId = msg.messageId;\n\nconst sharedMailbox = msg.mailbox;\nconst forwardTo = msg.forwardTo;\n\n// Rebuild headers using saved auth\nconst auth = msg.graphAuth || (msg.access_token ? \"Bearer \" + msg.access_token : null) || ((msg.payload && msg.payload.access_token) ? \"Bearer \" + msg.payload.access_token : null);\n\nif (!auth) {\n    node.error(\"Missing auth token for forward call\", msg);\n    return null;\n}\n\nmsg.headers = {\n    Authorization: auth,\n    \"Content-Type\": \"application/json\"\n};\n\nmsg.method = \"POST\";\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/messages/${messageId}/forward`;\nmsg.payload = {\n    comment: msg.body,\n    toRecipients: [\n        { emailAddress: { address: forwardTo } }\n    ]\n};\n\nmsg.originalMessage = {\n    id: messageId,\n    subject: message.subject,\n    receivedDateTime: message.receivedDateTime,\n    from: message.from\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 940,
        "wires": [
            [
                "4565addf7eec162e",
                "ef7faed783a76a65",
                "eacf1cebc93acf7d"
            ]
        ]
    },
    {
        "id": "4565addf7eec162e",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1310,
        "y": 940,
        "wires": [
            [
                "d4e47009ad329da6",
                "2a7f0ca3620c3510",
                "3dae28287be26080"
            ]
        ]
    },
    {
        "id": "f5afa21b1e1076c6",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 20",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1720,
        "y": 880,
        "wires": []
    },
    {
        "id": "e99570242ed5d488",
        "type": "http in",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "url": "/forward_email",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 940,
        "wires": [
            [
                "464852180caff957",
                "d2876ce07db684e8",
                "55045d59d3d67739"
            ]
        ]
    },
    {
        "id": "464852180caff957",
        "type": "change",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload.messageId",
                "pt": "msg",
                "to": "messageId",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.mailbox",
                "pt": "msg",
                "to": "mailbox",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.forwardTo",
                "pt": "msg",
                "to": "forwardTo",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "req",
                "pt": "msg",
                "to": "incoming_req",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "res",
                "pt": "msg",
                "to": "incoming_res",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.body",
                "pt": "msg",
                "to": "body",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 940,
        "wires": [
            [
                "7bb92d3f113fc515"
            ]
        ]
    },
    {
        "id": "1505cf4bc063d1f3",
        "type": "http response",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1710,
        "y": 940,
        "wires": []
    },
    {
        "id": "d2876ce07db684e8",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 22",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 360,
        "y": 800,
        "wires": []
    },
    {
        "id": "d4e47009ad329da6",
        "type": "change",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "incoming_req",
                "pt": "msg",
                "to": "req",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "incoming_res",
                "pt": "msg",
                "to": "res",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "statusCode",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1500,
        "y": 940,
        "wires": [
            [
                "1505cf4bc063d1f3",
                "f5afa21b1e1076c6",
                "d9bb239aa3a2c047"
            ]
        ]
    },
    {
        "id": "51827fdfdade6e6a",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 23",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1080,
        "y": 880,
        "wires": []
    },
    {
        "id": "2a7f0ca3620c3510",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 25",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1480,
        "y": 880,
        "wires": []
    },
    {
        "id": "ef7faed783a76a65",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 26",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1300,
        "y": 880,
        "wires": []
    },
    {
        "id": "55045d59d3d67739",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Write Log",
        "func": "// ====================================================================\n// CONFIGURATION\n// ====================================================================\n\n// Set this to describe where in the flow this log is being written\nconst LOG_STAGE = \"ENTRY POINT\";  // <---- change this per node\n\nconst ROOT = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Automated Processes\\\\Emailed Invoice Scrape\\\\Ebills\\\\logs\\\\node-red\";\n\n// Month names for readability\nconst MONTHS = [\n    \"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\n    \"July\",\"August\",\"September\",\"October\",\"November\",\"December\"\n];\n\n// ====================================================================\n// MAIN LOGIC\n// ====================================================================\n\n// Require msg._msgid\nif (!msg || typeof msg._msgid !== \"string\" || !msg._msgid.trim()) {\n    node.error(\"Missing msg._msgid; cannot determine log filename.\", msg);\n    return null;\n}\n\nconst now = new Date();\nconst yyyy = String(now.getFullYear());\nconst mmName = MONTHS[now.getMonth()];\nconst dd = String(now.getDate()).padStart(2, \"0\");\n\n// Build the full path\nconst filename = [\n    ROOT,\n    yyyy,\n    mmName,\n    dd,\n    msg._msgid + \".log\"\n].join(\"\\\\\");\n\n// --- Safe stringify for msg ---\nfunction safeStringify(obj, space = 2) {\n    const seen = new WeakSet();\n    return JSON.stringify(obj, (key, value) => {\n        if (typeof Buffer !== \"undefined\" && Buffer.isBuffer(value)) {\n            return `<Buffer length=${value.length}>`;\n        }\n        if (typeof value === \"function\") {\n            return `<Function ${value.name || \"anonymous\"}>`;\n        }\n        if (value && typeof value === \"object\") {\n            if (seen.has(value)) return \"<Circular>\";\n            seen.add(value);\n        }\n        return value;\n    }, space);\n}\n\n// --- Build entry with clear section separator ---\nconst iso = now.toISOString();\nconst sectionHeader = `\\n\\n===== ${LOG_STAGE} =====\\n`;\nconst entryHeader = `----- ${iso} | ${msg._msgid} -----\\n`;\nconst body = safeStringify(msg, 2) + \"\\n\";\n\n// --- Prepare message for File node ---\nmsg.filename = filename;\nmsg.payload  = sectionHeader + entryHeader + body;\nmsg.append   = true;\n\n// Optional: show where it’s logging\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `log→ ${yyyy}/${mmName}/${dd}/${msg._msgid}.log (${LOG_STAGE})`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 1020,
        "wires": [
            [
                "38c52feafd4e623c"
            ]
        ]
    },
    {
        "id": "38c52feafd4e623c",
        "type": "file",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 560,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "12c7dcd146eb2da8",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Write Log",
        "func": "// ====================================================================\n// CONFIGURATION\n// ====================================================================\n\n// Set this to describe where in the flow this log is being written\nconst LOG_STAGE = \"REQUEST TOKEN\";  // <---- change this per node\n\nconst ROOT = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Automated Processes\\\\Emailed Invoice Scrape\\\\Ebills\\\\logs\\\\node-red\";\n\n// Month names for readability\nconst MONTHS = [\n    \"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\n    \"July\",\"August\",\"September\",\"October\",\"November\",\"December\"\n];\n\n// ====================================================================\n// MAIN LOGIC\n// ====================================================================\n\n// Require msg._msgid\nif (!msg || typeof msg._msgid !== \"string\" || !msg._msgid.trim()) {\n    node.error(\"Missing msg._msgid; cannot determine log filename.\", msg);\n    return null;\n}\n\nconst now = new Date();\nconst yyyy = String(now.getFullYear());\nconst mmName = MONTHS[now.getMonth()];\nconst dd = String(now.getDate()).padStart(2, \"0\");\n\n// Build the full path\nconst filename = [\n    ROOT,\n    yyyy,\n    mmName,\n    dd,\n    msg._msgid + \".log\"\n].join(\"\\\\\");\n\n// --- Safe stringify for msg ---\nfunction safeStringify(obj, space = 2) {\n    const seen = new WeakSet();\n    return JSON.stringify(obj, (key, value) => {\n        if (typeof Buffer !== \"undefined\" && Buffer.isBuffer(value)) {\n            return `<Buffer length=${value.length}>`;\n        }\n        if (typeof value === \"function\") {\n            return `<Function ${value.name || \"anonymous\"}>`;\n        }\n        if (value && typeof value === \"object\") {\n            if (seen.has(value)) return \"<Circular>\";\n            seen.add(value);\n        }\n        return value;\n    }, space);\n}\n\n// --- Build entry with clear section separator ---\nconst iso = now.toISOString();\nconst sectionHeader = `\\n\\n===== ${LOG_STAGE} =====\\n`;\nconst entryHeader = `----- ${iso} | ${msg._msgid} -----\\n`;\nconst body = safeStringify(msg, 2) + \"\\n\";\n\n// --- Prepare message for File node ---\nmsg.filename = filename;\nmsg.payload  = sectionHeader + entryHeader + body;\nmsg.append   = true;\n\n// Optional: show where it’s logging\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `log→ ${yyyy}/${mmName}/${dd}/${msg._msgid}.log (${LOG_STAGE})`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 1020,
        "wires": [
            [
                "eba1c60ab294d075"
            ]
        ]
    },
    {
        "id": "eba1c60ab294d075",
        "type": "file",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 1210,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "3dae28287be26080",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Write Log",
        "func": "// ====================================================================\n// CONFIGURATION\n// ====================================================================\n\n// Set this to describe where in the flow this log is being written\nconst LOG_STAGE = \"FORWARD RESPONSE\";  // <---- change this per node\n\nconst ROOT = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Automated Processes\\\\Emailed Invoice Scrape\\\\Ebills\\\\logs\\\\node-red\";\n\n// Month names for readability\nconst MONTHS = [\n    \"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\n    \"July\",\"August\",\"September\",\"October\",\"November\",\"December\"\n];\n\n// ====================================================================\n// MAIN LOGIC\n// ====================================================================\n\n// Require msg._msgid\nif (!msg || typeof msg._msgid !== \"string\" || !msg._msgid.trim()) {\n    node.error(\"Missing msg._msgid; cannot determine log filename.\", msg);\n    return null;\n}\n\nconst now = new Date();\nconst yyyy = String(now.getFullYear());\nconst mmName = MONTHS[now.getMonth()];\nconst dd = String(now.getDate()).padStart(2, \"0\");\n\n// Build the full path\nconst filename = [\n    ROOT,\n    yyyy,\n    mmName,\n    dd,\n    msg._msgid + \".log\"\n].join(\"\\\\\");\n\n// --- Safe stringify for msg ---\nfunction safeStringify(obj, space = 2) {\n    const seen = new WeakSet();\n    return JSON.stringify(obj, (key, value) => {\n        if (typeof Buffer !== \"undefined\" && Buffer.isBuffer(value)) {\n            return `<Buffer length=${value.length}>`;\n        }\n        if (typeof value === \"function\") {\n            return `<Function ${value.name || \"anonymous\"}>`;\n        }\n        if (value && typeof value === \"object\") {\n            if (seen.has(value)) return \"<Circular>\";\n            seen.add(value);\n        }\n        return value;\n    }, space);\n}\n\n// --- Build entry with clear section separator ---\nconst iso = now.toISOString();\nconst sectionHeader = `\\n\\n===== ${LOG_STAGE} =====\\n`;\nconst entryHeader = `----- ${iso} | ${msg._msgid} -----\\n`;\nconst body = safeStringify(msg, 2) + \"\\n\";\n\n// --- Prepare message for File node ---\nmsg.filename = filename;\nmsg.payload  = sectionHeader + entryHeader + body;\nmsg.append   = true;\n\n// Optional: show where it’s logging\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `log→ ${yyyy}/${mmName}/${dd}/${msg._msgid}.log (${LOG_STAGE})`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 1020,
        "wires": [
            [
                "a0090cd08d1393ac"
            ]
        ]
    },
    {
        "id": "a0090cd08d1393ac",
        "type": "file",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 1630,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "eacf1cebc93acf7d",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Write Log",
        "func": "// ====================================================================\n// CONFIGURATION\n// ====================================================================\n\n// Set this to describe where in the flow this log is being written\nconst LOG_STAGE = \"FORWARD REQUEST\";  // <---- change this per node\n\nconst ROOT = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Automated Processes\\\\Emailed Invoice Scrape\\\\Ebills\\\\logs\\\\node-red\";\n\n// Month names for readability\nconst MONTHS = [\n    \"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\n    \"July\",\"August\",\"September\",\"October\",\"November\",\"December\"\n];\n\n// ====================================================================\n// MAIN LOGIC\n// ====================================================================\n\n// Require msg._msgid\nif (!msg || typeof msg._msgid !== \"string\" || !msg._msgid.trim()) {\n    node.error(\"Missing msg._msgid; cannot determine log filename.\", msg);\n    return null;\n}\n\nconst now = new Date();\nconst yyyy = String(now.getFullYear());\nconst mmName = MONTHS[now.getMonth()];\nconst dd = String(now.getDate()).padStart(2, \"0\");\n\n// Build the full path\nconst filename = [\n    ROOT,\n    yyyy,\n    mmName,\n    dd,\n    msg._msgid + \".log\"\n].join(\"\\\\\");\n\n// --- Safe stringify for msg ---\nfunction safeStringify(obj, space = 2) {\n    const seen = new WeakSet();\n    return JSON.stringify(obj, (key, value) => {\n        if (typeof Buffer !== \"undefined\" && Buffer.isBuffer(value)) {\n            return `<Buffer length=${value.length}>`;\n        }\n        if (typeof value === \"function\") {\n            return `<Function ${value.name || \"anonymous\"}>`;\n        }\n        if (value && typeof value === \"object\") {\n            if (seen.has(value)) return \"<Circular>\";\n            seen.add(value);\n        }\n        return value;\n    }, space);\n}\n\n// --- Build entry with clear section separator ---\nconst iso = now.toISOString();\nconst sectionHeader = `\\n\\n===== ${LOG_STAGE} =====\\n`;\nconst entryHeader = `----- ${iso} | ${msg._msgid} -----\\n`;\nconst body = safeStringify(msg, 2) + \"\\n\";\n\n// --- Prepare message for File node ---\nmsg.filename = filename;\nmsg.payload  = sectionHeader + entryHeader + body;\nmsg.append   = true;\n\n// Optional: show where it’s logging\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `log→ ${yyyy}/${mmName}/${dd}/${msg._msgid}.log (${LOG_STAGE})`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 1100,
        "wires": [
            [
                "e3788f81510c10b1"
            ]
        ]
    },
    {
        "id": "e3788f81510c10b1",
        "type": "file",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 1450,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "d9bb239aa3a2c047",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Write Log",
        "func": "// ====================================================================\n// CONFIGURATION\n// ====================================================================\n\n// Set this to describe where in the flow this log is being written\nconst LOG_STAGE = \"END\";  // <---- change this per node\n\nconst ROOT = \"\\\\\\\\inspiredenergysolutions.local\\\\DFS\\\\Public\\\\!IES\\\\BPI\\\\Automation Team\\\\Automated Processes\\\\Emailed Invoice Scrape\\\\Ebills\\\\logs\\\\node-red\";\n\n// Month names for readability\nconst MONTHS = [\n    \"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\n    \"July\",\"August\",\"September\",\"October\",\"November\",\"December\"\n];\n\n// ====================================================================\n// MAIN LOGIC\n// ====================================================================\n\n// Require msg._msgid\nif (!msg || typeof msg._msgid !== \"string\" || !msg._msgid.trim()) {\n    node.error(\"Missing msg._msgid; cannot determine log filename.\", msg);\n    return null;\n}\n\nconst now = new Date();\nconst yyyy = String(now.getFullYear());\nconst mmName = MONTHS[now.getMonth()];\nconst dd = String(now.getDate()).padStart(2, \"0\");\n\n// Build the full path\nconst filename = [\n    ROOT,\n    yyyy,\n    mmName,\n    dd,\n    msg._msgid + \".log\"\n].join(\"\\\\\");\n\n// --- Safe stringify for msg ---\nfunction safeStringify(obj, space = 2) {\n    const seen = new WeakSet();\n    return JSON.stringify(obj, (key, value) => {\n        if (typeof Buffer !== \"undefined\" && Buffer.isBuffer(value)) {\n            return `<Buffer length=${value.length}>`;\n        }\n        if (typeof value === \"function\") {\n            return `<Function ${value.name || \"anonymous\"}>`;\n        }\n        if (value && typeof value === \"object\") {\n            if (seen.has(value)) return \"<Circular>\";\n            seen.add(value);\n        }\n        return value;\n    }, space);\n}\n\n// --- Build entry with clear section separator ---\nconst iso = now.toISOString();\nconst sectionHeader = `\\n\\n===== ${LOG_STAGE} =====\\n`;\nconst entryHeader = `----- ${iso} | ${msg._msgid} -----\\n`;\nconst body = safeStringify(msg, 2) + \"\\n\";\n\n// --- Prepare message for File node ---\nmsg.filename = filename;\nmsg.payload  = sectionHeader + entryHeader + body;\nmsg.append   = true;\n\n// Optional: show where it’s logging\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `log→ ${yyyy}/${mmName}/${dd}/${msg._msgid}.log (${LOG_STAGE})`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1800,
        "y": 1000,
        "wires": [
            [
                "22e017f9cb2a7634"
            ]
        ]
    },
    {
        "id": "22e017f9cb2a7634",
        "type": "file",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 1950,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "8e1f922838b30c33",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1440,
        "y": 500,
        "wires": [
            [
                "46bf8f7cc0671021"
            ]
        ]
    },
    {
        "id": "46bf8f7cc0671021",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1680,
        "y": 500,
        "wires": [
            [
                "699a3e04335cb074"
            ]
        ]
    },
    {
        "id": "699a3e04335cb074",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1890,
        "y": 500,
        "wires": [
            [
                "4b020e838bc2ba77"
            ]
        ]
    },
    {
        "id": "4b020e838bc2ba77",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "function 5",
        "func": "// Function: Check if a user is out of office using Microsoft Graph API\n// Base: your existing Graph API call pattern\n\nconst userEmail = 'Greg.Nowotny@systems-link.com'; // target user to check\nconst accessToken = msg.payload.access_token;\n\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + accessToken,\n    \"Content-Type\": \"application/json\"\n};\n\n// Microsoft Graph endpoint for mailbox automatic replies\nmsg.url = `https://graph.microsoft.com/v1.0/users/${userEmail}/mailboxSettings/automaticRepliesSetting`;\nmsg.method = \"GET\";\nmsg.payload = null;\n\n// For reference in later nodes\nmsg.userEmail = userEmail;\nmsg.note = \"Checks if user is currently out of office\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2060,
        "y": 500,
        "wires": [
            [
                "23ac9d65bce9ea91"
            ]
        ]
    },
    {
        "id": "e82df2796bfa0274",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 28",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2400,
        "y": 500,
        "wires": []
    },
    {
        "id": "23ac9d65bce9ea91",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2230,
        "y": 500,
        "wires": [
            [
                "e82df2796bfa0274"
            ]
        ]
    },
    {
        "id": "a6043388266e52c2",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1440,
        "y": 580,
        "wires": [
            [
                "4df0a7eb78438f8f"
            ]
        ]
    },
    {
        "id": "4df0a7eb78438f8f",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1680,
        "y": 580,
        "wires": [
            [
                "7df9ee501d2e2072"
            ]
        ]
    },
    {
        "id": "7df9ee501d2e2072",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1890,
        "y": 580,
        "wires": [
            [
                "10b80946afa607d3"
            ]
        ]
    },
    {
        "id": "10b80946afa607d3",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "function 6",
        "func": "// Inputs: msg.payload.access_token from your OAuth step\n// Target user UPN\nconst user = 'Greg.Nowotny@systems-link.com';\n\nmsg.headers = { Authorization: `Bearer ${msg.payload.access_token}` };\nmsg.method = 'GET';\nmsg.url = `https://graph.microsoft.com/v1.0/users/${encodeURIComponent(user)}/presence`;\nmsg.payload = null;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2060,
        "y": 580,
        "wires": [
            [
                "091a301def92f4ab"
            ]
        ]
    },
    {
        "id": "091a301def92f4ab",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2230,
        "y": 580,
        "wires": [
            [
                "9415772f295d9763"
            ]
        ]
    },
    {
        "id": "9415772f295d9763",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 29",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2400,
        "y": 580,
        "wires": []
    },
    {
        "id": "f9c8d8b68739752f",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1440,
        "y": 640,
        "wires": [
            [
                "c0019b65bf87590d"
            ]
        ]
    },
    {
        "id": "c0019b65bf87590d",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1680,
        "y": 640,
        "wires": [
            [
                "1aaf37d07109af14"
            ]
        ]
    },
    {
        "id": "1aaf37d07109af14",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1890,
        "y": 640,
        "wires": [
            [
                "bdcce84fae404de3",
                "9e305d1050496bbb"
            ]
        ]
    },
    {
        "id": "bdcce84fae404de3",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "function 8",
        "func": "// Inputs:\n//   msg.payload.access_token  -> Graph app token\n//   msg.targetEmail           -> user's email address (UPN)\n\nconst token = msg.payload.access_token;\n//const email = msg.targetEmail; // e.g. \"someone@inspiredenergy.co.uk\"\nconst email = 'stuart.ramsay@inspiredenergy.co.uk'\n\nif (!token) { node.error('Missing access token'); return null; }\nif (!email) { node.error('Missing target email'); return null; }\n\nmsg.headers = { Authorization: `Bearer ${token}` };\nmsg.method = 'GET';\nmsg.url = `https://graph.microsoft.com/v1.0/users/${encodeURIComponent(email)}/presence`;\nmsg.payload = null;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2060,
        "y": 640,
        "wires": [
            [
                "72a14da3eea6830a"
            ]
        ]
    },
    {
        "id": "72a14da3eea6830a",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 2230,
        "y": 640,
        "wires": [
            [
                "0ba0040dc32c3855"
            ]
        ]
    },
    {
        "id": "0ba0040dc32c3855",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 30",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2400,
        "y": 640,
        "wires": []
    },
    {
        "id": "9e305d1050496bbb",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 36",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2200,
        "y": 760,
        "wires": []
    },
    {
        "id": "0ffe1226e3d9497c",
        "type": "inject",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 180,
        "y": 740,
        "wires": [
            [
                "3d3f2aa4aca12b99"
            ]
        ]
    },
    {
        "id": "3d3f2aa4aca12b99",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "Get GraphAPI Token",
        "func": "msg.payload = {\n    client_id: \"1d37c68d-79c2-4267-9659-e6702793c2f5\",\n    scope: \"https://graph.microsoft.com/.default\",\n    client_secret: \"fpE8Q~EU-V5a5mL~rb88piaXf3Hq6a3h3C0aib8I\",\n    grant_type: \"client_credentials\"\n};\nmsg.headers = { \"Content-Type\": \"application/x-www-form-urlencoded\" };\nmsg.url = \"https://login.microsoftonline.com/f8d69688-de39-4536-961c-db87fb9c8f20/oauth2/v2.0/token\";\nmsg.method = \"POST\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 740,
        "wires": [
            [
                "82b758ad12e28877"
            ]
        ]
    },
    {
        "id": "82b758ad12e28877",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 570,
        "y": 740,
        "wires": [
            [
                "7b32a18f59e285a9"
            ]
        ]
    },
    {
        "id": "7b32a18f59e285a9",
        "type": "function",
        "z": "96f51dbb3fe375ba",
        "name": "create subfolder",
        "func": "// Configuration\nconst sharedMailbox = 'bpiautomation@inspiredenergy.co.uk';\nconst newFolderName = 'node-red-test'; // change this to your desired subfolder name\n\n// Build the HTTP request\nmsg.headers = {\n    \"Authorization\": \"Bearer \" + msg.payload.access_token,\n    \"Content-Type\": \"application/json\"\n};\n\n// Endpoint: POST to the childFolders of the Inbox\nmsg.url = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/mailFolders/Inbox/childFolders`;\nmsg.method = \"POST\";\n\n// Body: specify the displayName of the new folder\nmsg.payload = {\n    \"displayName\": newFolderName\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 740,
        "wires": [
            [
                "a2b59751ab6db474"
            ]
        ]
    },
    {
        "id": "a2b59751ab6db474",
        "type": "http request",
        "z": "96f51dbb3fe375ba",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 930,
        "y": 740,
        "wires": [
            [
                "e9741359e9b38082"
            ]
        ]
    },
    {
        "id": "e9741359e9b38082",
        "type": "debug",
        "z": "96f51dbb3fe375ba",
        "name": "debug 35",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1080,
        "y": 740,
        "wires": []
    },
    {
        "id": "3d6a3e96f973f5bc",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            },
            {
                "p": "payload.bot_name",
                "v": "performanceShareBillings",
                "vt": "str"
            },
            {
                "p": "payload.username",
                "v": "botrunner42",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 100,
        "wires": [
            [
                "7e998d2d0e94400a"
            ]
        ]
    },
    {
        "id": "7e998d2d0e94400a",
        "type": "change",
        "z": "11ae27e22bf567bd",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "bot_name",
                "pt": "msg",
                "to": "payload.bot_name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runner_username",
                "pt": "msg",
                "to": "payload.username",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 100,
        "wires": [
            [
                "45238dce05ad4b4e"
            ]
        ]
    },
    {
        "id": "45238dce05ad4b4e",
        "type": "subflow:2ef09639923d028e",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 510,
        "y": 100,
        "wires": [
            [
                "bcbacef99cb99925"
            ]
        ]
    },
    {
        "id": "bcbacef99cb99925",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 100,
        "wires": [
            [
                "24d39c1aaabb4326"
            ]
        ]
    },
    {
        "id": "24d39c1aaabb4326",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 930,
        "y": 100,
        "wires": [
            [
                "e49a7cc7358944ec"
            ]
        ]
    },
    {
        "id": "e49a7cc7358944ec",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Log to DB",
        "func": "// Builds INSERT statements for each item in msg.payload.list\n// Formats startDateTime as \"yyyy-mm-dd hh:mm:ss\" (UTC).\n// Sends one message per item with SQL in both msg.topic and msg.payload.\n\n// ---- options ----\nconst useLocalTime  = false; // set true to format in your Node-RED server's local time\nconst includeOffset = false; // set true if your SQL column is DATETIMEOFFSET and you want \" +00:00\" appended for UTC\n// -----------------\n\nconst items = (msg && msg.payload && Array.isArray(msg.payload.list)) ? msg.payload.list : [];\nif (!items.length) {\n    node.warn(\"No items found in msg.payload.list\");\n    return null;\n}\n\n// Escape single quotes for SQL string literals\nfunction esc(v) {\n    return String(v ?? \"\").replace(/'/g, \"''\");\n}\n\n// Format ISO date string to \"yyyy-mm-dd hh:mm:ss\" (UTC by default)\nfunction toSqlDateTime(str) {\n    if (!str) return \"\";\n    const d = new Date(str);\n    if (isNaN(d)) {\n        node.warn(`Invalid date encountered: ${str}`);\n        return esc(str); // fall back to original\n    }\n\n    const YY = useLocalTime ? d.getFullYear()      : d.getUTCFullYear();\n    const MM = (useLocalTime ? d.getMonth() + 1    : d.getUTCMonth() + 1).toString().padStart(2, \"0\");\n    const DD = (useLocalTime ? d.getDate()         : d.getUTCDate()).toString().padStart(2, \"0\");\n    const hh = (useLocalTime ? d.getHours()        : d.getUTCHours()).toString().padStart(2, \"0\");\n    const mm = (useLocalTime ? d.getMinutes()      : d.getUTCMinutes()).toString().padStart(2, \"0\");\n    const ss = (useLocalTime ? d.getSeconds()      : d.getUTCSeconds()).toString().padStart(2, \"0\");\n\n    let formatted = `${YY}-${MM}-${DD} ${hh}:${mm}:${ss}`;\n    if (includeOffset && !useLocalTime) formatted += \" +00:00\"; // helpful for DATETIMEOFFSET(7)\n    return formatted;\n}\n\nitems.forEach(it => {\n    const fileName       = esc(it.fileName);\n    const initiationType = esc(it.initiationType);\n    const userName       = esc(it.userName);\n\n    // format the datetime\n    const startDT = toSqlDateTime(it.startDateTime);\n    const startDateTime = esc(startDT);\n\n    const sql = `INSERT INTO aa_dev.bots_active (fileName, initiationType, startDateTime, userName) ` +\n                `VALUES ('${fileName}', '${initiationType}', '${startDateTime}', '${userName}');`;\n\n    node.send({\n        topic: sql,      // many DB nodes (e.g., mssql) use msg.topic\n        payload: sql,    // others may use msg.payload\n        item: it\n    });\n});\n\nreturn null; // all messages dispatched\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 100,
        "wires": [
            [
                "078cc479fae3a39d"
            ]
        ]
    },
    {
        "id": "078cc479fae3a39d",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1320,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "25a1ac28dadb3d8c",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "Check",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "120",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 120,
        "y": 220,
        "wires": [
            [
                "9fd91ceaa0afa128"
            ]
        ]
    },
    {
        "id": "49a2ad0f07551c49",
        "type": "subflow:2ef09639923d028e",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 550,
        "y": 220,
        "wires": [
            [
                "2fe681fff38849a1"
            ]
        ]
    },
    {
        "id": "2fe681fff38849a1",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 220,
        "wires": [
            [
                "758eb2fe2d9a7281"
            ]
        ]
    },
    {
        "id": "758eb2fe2d9a7281",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1000,
        "y": 220,
        "wires": [
            [
                "1987a55b2ba71b56"
            ]
        ]
    },
    {
        "id": "1987a55b2ba71b56",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Check for 'Messagebox'",
        "func": "// Emits one msg per stuck deploymentId (command === 'messageBox').\n// Produces a fully inlined T-SQL upsert (IF EXISTS/UPDATE/ELSE INSERT).\n// No parameters, no Mustache. Configure MSSQL node to read msg.topic (or msg.query).\n\nconst list = (msg.payload && Array.isArray(msg.payload.list)) ? msg.payload.list : [];\nconst stuck = list.filter(x => x && x.command === 'messageBox');\n\n// nothing to do\nif (stuck.length === 0) return null;\n\n// ISO UTC for INSERT literals\nconst nowIso = new Date().toISOString(); // e.g., 2025-09-14T07:41:23.351Z\n\n// helper to T-SQL-escape single quotes and clamp length (to match table DDL)\nfunction esc(val, maxLen) {\n    let s = (val == null ? '' : String(val));\n    if (maxLen && s.length > maxLen) s = s.slice(0, maxLen);\n    return s.replace(/'/g, \"''\");\n}\n\nconst out = [];\n\nfor (const r of stuck) {\n    const deployment_id = esc(r.id, 64);\n    const device_name = esc(r.deviceName, 128);\n    const user_name = esc(r.userName, 128);\n    const automation_name = esc(r.automationName, 256);\n    const status = esc(r.status, 32);\n    const command = esc(r.command, 64);\n\n    // Fully inlined UPSERT with literals\n    const sql = `\nIF EXISTS (SELECT 1 FROM aa.watchdog_msgbox_detection WITH (UPDLOCK, HOLDLOCK) WHERE deployment_id='${deployment_id}')\nBEGIN\n    UPDATE aa.watchdog_msgbox_detection\n       SET device_name     = '${device_name}',\n           user_name       = '${user_name}',\n           automation_name = '${automation_name}',\n           status          = '${status}',\n           command         = '${command}',\n           last_seen_utc   = SYSUTCDATETIME(),\n           counter         = counter + 1\n     WHERE deployment_id = '${deployment_id}';\nEND\nELSE\nBEGIN\n    INSERT INTO aa.watchdog_msgbox_detection\n        (deployment_id, device_name, user_name, automation_name, status, command,\n         first_seen_utc, last_seen_utc, counter, alerted_time)\n    VALUES\n        ('${deployment_id}', '${device_name}', '${user_name}', '${automation_name}', '${status}', '${command}',\n         '${nowIso}', '${nowIso}', 1, NULL);\nEND\n`.trim();\n\n    out.push({\n        topic: sql,   // for nodes that expect msg.topic\n        query: sql,   // for nodes that expect msg.query\n        detection: {  // optional: keep source info for downstream debug/logging\n            deploymentId: r.deploymentId,\n            deviceName: r.deviceName,\n            userName: r.userName,\n            automationName: r.automationName\n        }\n    });\n}\n\nreturn [out];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 220,
        "wires": [
            [
                "abfb9d9ac4954453"
            ]
        ]
    },
    {
        "id": "15bc7ebe06601054",
        "type": "comment",
        "z": "11ae27e22bf567bd",
        "name": "Logs running bots to aa_dev.bots_active",
        "info": "",
        "x": 190,
        "y": 60,
        "wires": []
    },
    {
        "id": "cbe66f30bd9d5683",
        "type": "comment",
        "z": "11ae27e22bf567bd",
        "name": "Checks for bots currently displaying a message box",
        "info": "",
        "x": 230,
        "y": 180,
        "wires": []
    },
    {
        "id": "abfb9d9ac4954453",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1490,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "94ef08b46a52b572",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Query",
        "func": "// Node-RED Function: build T-SQL that selects live issues, stamps alerted_time,\n// and returns rows with a human-readable alert message.\n// Target: SQL Server (DSN = Jupiter), table: aa.watchdog_msgbox_detection\n//\n// Criteria (constants):\n//   - counter >= 5\n//   - last_seen_utc within last 5 minutes\n//   - alerted_time IS NULL OR alerted_time < now - 1 hour\n//\n// Output from MSSQL node will be an array of rows; each row includes:\n//   deployment_id, device_name, user_name, automation_name, status, command,\n//   first_seen_utc, last_seen_utc, counter, alerted_time, minutes_active, alert_message\n//\n// Configure your MSSQL node to read the query from msg.topic (or msg.query).\n// Disable Mustache/templating in the MSSQL node.\n\nconst sql = `\nUPDATE t\nSET alerted_time = SYSUTCDATETIME()\nOUTPUT\n  inserted.deployment_id,\n  inserted.device_name,\n  inserted.user_name,\n  inserted.automation_name,\n  inserted.status,\n  inserted.command,\n  inserted.first_seen_utc,\n  inserted.last_seen_utc,\n  inserted.counter,\n  inserted.alerted_time,\n  DATEDIFF(MINUTE, inserted.first_seen_utc, SYSUTCDATETIME()) AS minutes_active,\n  'Deployment ' + inserted.automation_name\n      + ' has been stuck on a message box for '\n      + CAST(DATEDIFF(MINUTE, inserted.first_seen_utc, SYSUTCDATETIME()) AS varchar(10))\n      + ' minutes on device ' + inserted.device_name\n      + ' (user ' + inserted.user_name + '). '\n      + 'Please resolve! '\n      + 'https://inspired-1.my.automationanywhere.digital/#/activity/inProgress/'\n      + inserted.deployment_id + '/detail'\n      AS alert_message\nFROM aa.watchdog_msgbox_detection AS t\nWHERE\n    t.counter >= 5\n    AND t.last_seen_utc >= DATEADD(MINUTE, -5, SYSUTCDATETIME())\n    AND (\n        t.alerted_time IS NULL\n        OR t.alerted_time < DATEADD(HOUR, -1, SYSUTCDATETIME())\n    );\n`.trim();\n\nmsg.topic = sql;   // for MSSQL nodes that use msg.topic\nmsg.query = sql;   // for MSSQL nodes that use msg.query\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 280,
        "wires": [
            [
                "f3b7b3bb44adb035"
            ]
        ]
    },
    {
        "id": "f3b7b3bb44adb035",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "query",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 860,
        "y": 280,
        "wires": [
            [
                "c3f77aa1924823f9"
            ]
        ]
    },
    {
        "id": "4bdf1f6358dcd54b",
        "type": "delay",
        "z": "11ae27e22bf567bd",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 520,
        "y": 280,
        "wires": [
            [
                "94ef08b46a52b572"
            ]
        ]
    },
    {
        "id": "c3f77aa1924823f9",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Construct Teams Alert",
        "func": "const teams_url = 'https://defaultf8d69688de394536961cdb87fb9c8f.20.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ed14826a4b5b4fd0ad24ddee6377bc46/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FyRcZXuFfCI3gfF2krESDRz449xw59B8w7k5XWZxxhs';\nlet items = msg.payload;\nif (typeof items === 'string') items = JSON.parse(items);\n\nfor (const x of items) {\n  const url = `https://inspired-1.my.automationanywhere.digital/#/activity/inProgress/${x.deployment_id}/detail`;\n  node.send({\n    url: teams_url,\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    payload: {\n      deployment_id: x.deployment_id,\n      device_name: x.device_name,\n      user_name: x.user_name,\n      automation_name: x.automation_name,\n      status: x.status,\n      command: x.command,\n      first_seen_utc: x.first_seen_utc,\n      last_seen_utc: x.last_seen_utc,\n      alerted_time: x.alerted_time,\n      counter: x.counter,\n      minutes_active: x.minutes_active,\n      url\n    }\n  });\n}\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 280,
        "wires": [
            [
                "42af96e121ee3b43"
            ]
        ]
    },
    {
        "id": "cc91bbc7c3cbd239",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1530,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "42af96e121ee3b43",
        "type": "delay",
        "z": "11ae27e22bf567bd",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1340,
        "y": 280,
        "wires": [
            [
                "cc91bbc7c3cbd239"
            ]
        ]
    },
    {
        "id": "08c68768f7974734",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 440,
        "wires": [
            [
                "ead6df21fb55c572"
            ]
        ]
    },
    {
        "id": "4a8343c132a46934",
        "type": "subflow:2ef09639923d028e",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 570,
        "y": 440,
        "wires": [
            [
                "a782f3e0b98698f9"
            ]
        ]
    },
    {
        "id": "a782f3e0b98698f9",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Get Scheduled",
        "func": "const TOKEN = msg.payload.token;\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/schedule/automations/list\";\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n    sort: [],\n    page: {\n        offset: 0, \n        length: 1000 \n    }\n};\n\nmsg.targetOwnerId = 632222;  // Store for later filtering\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 440,
        "wires": [
            [
                "7cb4d47f06deff21"
            ]
        ]
    },
    {
        "id": "7cb4d47f06deff21",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 950,
        "y": 440,
        "wires": [
            [
                "7ce73453e46a2c86"
            ]
        ]
    },
    {
        "id": "7ce73453e46a2c86",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "function 10",
        "func": "// Node-RED Function: Prepare Update Requests\n\nif (!msg.payload || !msg.payload.list) {\n    node.error(\"No schedules found to update\");\n    return null;\n}\n\nconst schedules = msg.payload.list;\nconst newOwnerId = msg.newOwnerId || 632;\nconst TOKEN = msg.token\n\n// Create array of update messages\nconst updateMessages = [];\n\nschedules.forEach((schedule, index) => {\n    if (schedule.id && schedule.ownedBy !== newOwnerId.toString()) {\n        // Create update payload for each schedule\n        const updateMsg = {\n            url: \"https://inspired-1.my.automationanywhere.digital/v2/schedule/automations/changeOwner\",\n            method: \"PUT\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n                \"Accept\": \"application/json\",\n                \"X-Authorization\": TOKEN\n            },\n            payload: {\n                        \"scheduleIds\": [\n                            schedule.id\n                            ],\n                        \"userId\": \"632\",\n                        \"taskType\": \"TASK_BOT\"\n                        }\n\n        };\n        \n        updateMessages.push(updateMsg);\n    }\n});\n\nnode.log(`Preparing to update ${updateMessages.length} schedules`);\n\n// Return array of messages for parallel processing\nreturn [updateMessages];\n\n\n// msg.url = \"https://inspired-1.my.automationanywhere.digital/v2/schedule/automations/changeOwner\"\n\n// msg.payload = {\n//     \"scheduleIds\": [\n//         \"2809\"\n//         ],\n//     \"userId\": \"632\",\n//     \"taskType\":\n//     \"TASK_BOT\"\n//     }\n// method\": \"PUT\"",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 440,
        "wires": [
            [
                "77057ba94ce801c0"
            ]
        ]
    },
    {
        "id": "77057ba94ce801c0",
        "type": "delay",
        "z": "11ae27e22bf567bd",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1310,
        "y": 440,
        "wires": [
            [
                "8bbaa5063ae66553"
            ]
        ]
    },
    {
        "id": "8bbaa5063ae66553",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1490,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "a9433b0ce20852d4",
        "type": "comment",
        "z": "11ae27e22bf567bd",
        "name": "Set Schedule owner to aautomationmanager",
        "info": "",
        "x": 210,
        "y": 380,
        "wires": []
    },
    {
        "id": "0a6b83a1826a60e9",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "15",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 640,
        "wires": [
            [
                "3fd1c991fa128f4f"
            ]
        ]
    },
    {
        "id": "429e5134f373a1ed",
        "type": "subflow:2ef09639923d028e",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 960,
        "y": 640,
        "wires": [
            [
                "f47c2a09f7449dbd"
            ]
        ]
    },
    {
        "id": "f47c2a09f7449dbd",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Get Activity",
        "func": "const TOKEN = msg.payload.token\n\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\n\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n    filter: {\n        \"operator\": \"eq\",\n        \"field\": \"deploymentId\",\n        \"value\": msg.deploymentId\n    },\n    sort: [],\n    page: {\n        offset: 0, \n        length: 1000 \n    }\n};\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1170,
        "y": 640,
        "wires": [
            [
                "90ad43d51e7d8c85"
            ]
        ]
    },
    {
        "id": "90ad43d51e7d8c85",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1370,
        "y": 640,
        "wires": [
            [
                "c06fd21736d478ef"
            ]
        ]
    },
    {
        "id": "ddd0d64fd00425f7",
        "type": "debug",
        "z": "11ae27e22bf567bd",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "topic",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1980,
        "y": 640,
        "wires": []
    },
    {
        "id": "93cafe3347140af3",
        "type": "comment",
        "z": "11ae27e22bf567bd",
        "name": "Get Watchfolder Deployment Activity",
        "info": "",
        "x": 180,
        "y": 580,
        "wires": []
    },
    {
        "id": "4d7310eff8fa4e35",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "Get Awaiting Logs",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "SELECT wdl.id, wdl.deployment_id\r\nFROM aa.watchdog_watchfolder_logs as wdl\r\nWHERE wdl.deployment_successful = 1\r\nAND wdl.endDateTime IS NULL",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 530,
        "y": 640,
        "wires": [
            [
                "6232db0949fb057e"
            ]
        ]
    },
    {
        "id": "6232db0949fb057e",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Split Jobs",
        "func": "const jobs = msg.payload;\n\nfor (const job of jobs) {\n    node.send({\n        jobId: job.id,\n        deploymentId: job.deployment_id,\n        payload: {\n            environment: 'live'\n        }\n    });\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 640,
        "wires": [
            [
                "429e5134f373a1ed"
            ]
        ]
    },
    {
        "id": "c06fd21736d478ef",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Process Response",
        "func": "const id = msg.jobId;\n\nconst rec = (msg.payload && msg.payload.list && msg.payload.list[0]) || {};\nconst automationName = rec.automationName;\nconst fileName       = rec.fileName;\nconst startDateTime  = rec.startDateTime;\nconst endDateTime    = rec.endDateTime;\nconst status         = rec.status;\nconst userId         = rec.userId;\nconst fileId         = rec.fileId;\nconst deviceName     = rec.deviceName;\n\n// Helpers\nfunction esc(str) {\n    return String(str).replace(/'/g, \"''\");\n}\nfunction sqlStr(val) {\n    if (val === undefined || val === null) return \"NULL\";\n    const s = String(val).trim();\n    return s === \"\" ? \"NULL\" : `'${esc(s)}'`;\n}\nfunction sqlInt(val) {\n    if (val === undefined || val === null || val === \"\") return \"NULL\";\n    const n = Number(val);\n    return Number.isFinite(n) ? String(Math.trunc(n)) : \"NULL\";\n}\nfunction sqlDate(val) {\n    if (val === undefined || val === null || String(val).trim() === \"\") return \"NULL\";\n    const d = new Date(val);\n    if (isNaN(d.getTime())) return \"NULL\";\n    // format as YYYY-MM-DD HH:MM:SS\n    const pad = n => String(n).padStart(2, \"0\");\n    const yyyy = d.getFullYear();\n    const mm = pad(d.getMonth() + 1);\n    const dd = pad(d.getDate());\n    const hh = pad(d.getHours());\n    const mi = pad(d.getMinutes());\n    const ss = pad(d.getSeconds());\n    return `'${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}'`;\n}\n\n// Build UPDATE\nconst setClauses = [\n    `automationName = ${sqlStr(automationName)}`,\n    `fileName = ${sqlStr(fileName)}`,\n    `startDateTime = ${sqlDate(startDateTime)}`,\n    `endDateTime = ${sqlDate(endDateTime)}`,\n    `status = ${sqlStr(status)}`,\n    `userId = ${sqlInt(userId)}`,\n    `fileId = ${sqlInt(fileId)}`,\n    `deviceName = ${sqlStr(deviceName)}`\n];\n\nif (id === undefined || id === null) {\n    node.error(\"Missing msg.jobId for WHERE clause\", msg);\n    return null;\n}\n\nmsg.topic = `\nUPDATE [aa].[watchdog_watchfolder_logs]\nSET ${setClauses.join(\", \")}\nWHERE id = ${sqlInt(id)};\n`.trim();\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 640,
        "wires": [
            [
                "ad6b87aff60de59b"
            ]
        ]
    },
    {
        "id": "ad6b87aff60de59b",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1780,
        "y": 640,
        "wires": [
            [
                "ddd0d64fd00425f7"
            ]
        ]
    },
    {
        "id": "66a44b35ab7ab6f5",
        "type": "comment",
        "z": "11ae27e22bf567bd",
        "name": "Check Missing Failure Flags",
        "info": "",
        "x": 160,
        "y": 740,
        "wires": []
    },
    {
        "id": "4ddb453c5e6ef874",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            }
        ],
        "repeat": "15",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 800,
        "wires": [
            [
                "1936498f0efa887b"
            ]
        ]
    },
    {
        "id": "5977b90da331b6de",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "Set Failure Resolved Flag",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "UPDATE aa.watchdog_watchfolder_logs\r\nSET failure_resolved = 0\r\nWHERE failure_resolved IS NULL\r\nAND http_response_status >= 300",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 590,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "9fd91ceaa0afa128",
        "type": "subflow:c4217fb89f6015dc",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 270,
        "y": 220,
        "wires": [
            [
                "5b970829666222b1"
            ]
        ]
    },
    {
        "id": "5b970829666222b1",
        "type": "switch",
        "z": "11ae27e22bf567bd",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 385,
        "y": 220,
        "wires": [
            [
                "49a2ad0f07551c49",
                "4bdf1f6358dcd54b"
            ]
        ],
        "l": false
    },
    {
        "id": "ead6df21fb55c572",
        "type": "subflow:c4217fb89f6015dc",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 270,
        "y": 440,
        "wires": [
            [
                "47cf5e4b6b965305"
            ]
        ]
    },
    {
        "id": "47cf5e4b6b965305",
        "type": "switch",
        "z": "11ae27e22bf567bd",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 395,
        "y": 440,
        "wires": [
            [
                "4a8343c132a46934"
            ]
        ],
        "l": false
    },
    {
        "id": "3fd1c991fa128f4f",
        "type": "subflow:c4217fb89f6015dc",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 270,
        "y": 640,
        "wires": [
            [
                "90d329ce22c19bd4"
            ]
        ]
    },
    {
        "id": "90d329ce22c19bd4",
        "type": "switch",
        "z": "11ae27e22bf567bd",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 395,
        "y": 640,
        "wires": [
            [
                "4d7310eff8fa4e35"
            ]
        ],
        "l": false
    },
    {
        "id": "1936498f0efa887b",
        "type": "subflow:c4217fb89f6015dc",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 290,
        "y": 800,
        "wires": [
            [
                "e5940ef569e348fb"
            ]
        ]
    },
    {
        "id": "e5940ef569e348fb",
        "type": "switch",
        "z": "11ae27e22bf567bd",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 415,
        "y": 800,
        "wires": [
            [
                "5977b90da331b6de"
            ]
        ],
        "l": false
    },
    {
        "id": "18d68d10de184735",
        "type": "inject",
        "z": "11ae27e22bf567bd",
        "name": "Captue CR ID for running bots",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "x": 190,
        "y": 960,
        "wires": [
            [
                "a14bd5877cb215d5"
            ]
        ]
    },
    {
        "id": "8850fc4b4a63a02c",
        "type": "change",
        "z": "11ae27e22bf567bd",
        "name": "Set Environment",
        "rules": [
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 960,
        "wires": [
            [
                "41feeb829fb860ea"
            ]
        ]
    },
    {
        "id": "41feeb829fb860ea",
        "type": "subflow:2ef09639923d028e",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 940,
        "y": 960,
        "wires": [
            [
                "579e6a7fca48c2c7"
            ]
        ]
    },
    {
        "id": "579e6a7fca48c2c7",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "Check for active bots",
        "func": "const TOKEN = msg.payload.token\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/activity/list\";\nmsg.headers = { \"Content-Type\": \"application/json\", \"accept\": \"application/json\", \"X-Authorization\": TOKEN };\nmsg.payload = {\n  \"filter\": {\n    \"operator\": \"and\",\n    \"operands\": [\n      {\n        \"field\": \"status\",\n        \"operator\": \"eq\",\n        \"value\": \"UPDATE\"\n      }\n    ],\n    \"sort\": [\n      {\n        \"field\": \"startDateTime\",\n        \"direction\": \"desc\"\n      }\n    ]\n  }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 960,
        "wires": [
            [
                "69870df7540d2725"
            ]
        ]
    },
    {
        "id": "69870df7540d2725",
        "type": "http request",
        "z": "11ae27e22bf567bd",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1380,
        "y": 960,
        "wires": [
            [
                "bc840df9575a894c"
            ]
        ]
    },
    {
        "id": "bc840df9575a894c",
        "type": "function",
        "z": "11ae27e22bf567bd",
        "name": "function 16",
        "func": "for (let i = 0; i< msg.payload.list.length; i++){\n    let fileName = msg.payload.list[i].fileName\n    let fileId = msg.payload.list[i].fileId\n    let sql = `UPDATE aa.bots SET aa_bot_id = '${fileId}' WHERE bot_name_calculated = '${fileName}';`\n\n    node.send({topic: sql})\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 960,
        "wires": [
            [
                "b043c9561b958f86"
            ]
        ]
    },
    {
        "id": "b043c9561b958f86",
        "type": "MSSQL",
        "z": "11ae27e22bf567bd",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1820,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "a14bd5877cb215d5",
        "type": "subflow:c4217fb89f6015dc",
        "z": "11ae27e22bf567bd",
        "name": "",
        "x": 430,
        "y": 960,
        "wires": [
            [
                "4e9395c202c666e3"
            ]
        ]
    },
    {
        "id": "4e9395c202c666e3",
        "type": "switch",
        "z": "11ae27e22bf567bd",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 555,
        "y": 960,
        "wires": [
            [
                "8850fc4b4a63a02c"
            ]
        ],
        "l": false
    },
    {
        "id": "df5b691e913ee8a1",
        "type": "inject",
        "z": "594708c349b147f4",
        "name": "",
        "props": [
            {
                "p": "payload.environment",
                "v": "live",
                "vt": "str"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 130,
        "y": 100,
        "wires": [
            [
                "8153da3e55fa906b"
            ]
        ]
    },
    {
        "id": "8153da3e55fa906b",
        "type": "subflow:2ef09639923d028e",
        "z": "594708c349b147f4",
        "name": "",
        "x": 320,
        "y": 100,
        "wires": [
            [
                "22c3d72a95b2cc04"
            ]
        ]
    },
    {
        "id": "22c3d72a95b2cc04",
        "type": "function",
        "z": "594708c349b147f4",
        "name": "Build get schedules payload",
        "func": "\nconst TOKEN = msg.payload.token;\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v2/schedule/automations/list\";\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  filter: {\n    operator: \"and\",\n    rules: [\n    ]\n  },\n  sort: [],\n  page: { offset: 0, length: 1000 }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 100,
        "wires": [
            [
                "bb8254af12e33bf6"
            ]
        ]
    },
    {
        "id": "bb8254af12e33bf6",
        "type": "http request",
        "z": "594708c349b147f4",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 810,
        "y": 100,
        "wires": [
            [
                "ba2d99dbfeb3ba6f"
            ]
        ]
    },
    {
        "id": "ba2d99dbfeb3ba6f",
        "type": "function",
        "z": "594708c349b147f4",
        "name": "Process Schedule data",
        "func": "// Node-RED Function: Filter response to schedules with runAsUserIds including \"599\"\nconst TARGET = \"599\";\n\n// Handle both shapes: { list: [...] } or direct array\nlet items = Array.isArray(msg.payload) ? msg.payload\n          : Array.isArray(msg.payload?.list) ? msg.payload.list\n          : [];\n\nitems = items.filter(s =>\n  Array.isArray(s.runAsUserIds) && s.runAsUserIds.includes(TARGET)\n);\n\n// Keep the structure you prefer; here we return just the filtered array\nmsg.payload = items;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1050,
        "y": 100,
        "wires": [
            [
                "eb622a991be0e087"
            ]
        ]
    },
    {
        "id": "eb622a991be0e087",
        "type": "debug",
        "z": "594708c349b147f4",
        "name": "debug 33",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1280,
        "y": 100,
        "wires": []
    },
    {
        "id": "966e3b368e7d6e23",
        "type": "template",
        "z": "f778b963edde7e03",
        "name": "Get missing IS PL Codes",
        "field": "sql",
        "fieldType": "msg",
        "format": "sql",
        "syntax": "mustache",
        "template": "SELECT\n    LTRIM(RTRIM(id)) id,\n    invoice_pl_c\nFROM OPENQUERY(SUGARCORP, '\nSELECT\n    i.id,\n    CASE\n      WHEN pc.pl_vertical_c = \"Assurance\" THEN\n        CASE\n          WHEN a.allocation_team_c = \"Key Accounts\"           THEN \"Key Accounts 2.25\"\n          WHEN a.allocation_team_c = \"Estate Intensive\"       THEN \"Estate Intensive 2.21\"\n          WHEN a.allocation_team_c = \"Energy Intensive\"       THEN \"Energy Intensive 2.19\"\n          WHEN a.allocation_team_c = \"Businesswise\"           THEN \"Businesswise 2.10\"\n          WHEN a.allocation_team_c = \"Public Services\"        THEN \"Public Services 2.28\"\n          WHEN a.allocation_team_c = \"Ignite Energy\"          THEN \"Ignite Assurance 2.09\"\n          WHEN a.allocation_team_c = \"Legacy Client Run Off\"  THEN \"Legacy Client Run Off 2.52\"\n          WHEN a.allocation_team_c = \"Systemslink\"            THEN \"Systemslink 4.02\"\n          ELSE \"\"\n        END\n      WHEN pc.pl_vertical_c = \"Businesswise\"                     THEN \"Businesswise 2.10\"\n      WHEN pc.pl_vertical_c = \"Energy Intensive\"                 THEN \"Energy Intensive 2.19\"\n      WHEN pc.pl_vertical_c = \"ESG\"                              THEN \"ESG 5.01\"\n      WHEN pc.pl_vertical_c = \"ESG Contingent Fees\"              THEN \"ESG : Contingent Fees 5.02\"\n      WHEN pc.pl_vertical_c = \"Estate Intensive\"                 THEN \"Estate Intensive 2.21\"\n      WHEN pc.pl_vertical_c = \"Green and Emissions Certificates\" THEN \"Green and Emissions Certificates 3.07\"\n      WHEN pc.pl_vertical_c = \"Horizon\"                          THEN \"Horizon 2.11\"\n      WHEN pc.pl_vertical_c = \"Ignite Assurance\"                 THEN \"Ignite Assurance 2.09\"\n      WHEN pc.pl_vertical_c = \"Key Accounts\"                     THEN \"Key Accounts 2.25\"\n      WHEN pc.pl_vertical_c = \"Legacy Client Run Off\"            THEN \"Legacy Client Run Off 2.52\"\n      WHEN pc.pl_vertical_c = \"Metering\"                         THEN \"Metering 3.02\"\n      WHEN pc.pl_vertical_c = \"Optimisation Solutions\"           THEN \"Optimisation Solutions 3.10\"\n      WHEN pc.pl_vertical_c = \"Public Services\"                  THEN \"Public Services 2.28\"\n      WHEN pc.pl_vertical_c = \"Systemslink\"                      THEN \"Systemslink 4.02\"\n      WHEN pc.pl_vertical_c = \"Water\"                            THEN \"Water 3.01\"\n      ELSE \"\"\n    END as invoice_pl_c\n\nFROM order_invoice_schedule AS i\nINNER JOIN order_invoice_schedule_cstm AS ic\n  ON ic.id_c = i.id AND i.deleted = 0\nINNER JOIN order_order_items_order_invoice_schedule_c AS oii\n  ON oii.order_orde6af9chedule_idb = i.id AND oii.deleted = 0\nINNER JOIN order_order_items AS oi\n  ON oi.id = oii.order_order_items_order_invoice_scheduleorder_order_items_ida AND oi.deleted = 0\nINNER JOIN accounts_order_order_items_1_c AS aoi\n  ON aoi.accounts_order_order_items_1order_order_items_idb = oi.id AND aoi.deleted = 0\nINNER JOIN accounts AS a\n  ON a.id = aoi.accounts_order_order_items_1accounts_ida AND a.deleted = 0\nINNER JOIN accounts_cstm AS ac\n  ON ac.id_c = a.id\nINNER JOIN order_order_items_jc_services_c AS oip\n  ON oip.order_order_items_jc_servicesorder_order_items_idb = oi.id AND oip.deleted = 0\nINNER JOIN jc_services AS p\n  ON p.id = oip.order_order_items_jc_servicesjc_services_ida AND p.deleted = 0\nINNER JOIN jc_services_cstm AS pc\n  ON pc.id_c = p.id\nWHERE ic.invoice_pl_c IS NULL\n  AND ic.status_c NOT LIKE \"% Raised\";\n\n')\norder by id desc",
        "output": "str",
        "x": 670,
        "y": 80,
        "wires": [
            [
                "33e1127e463d84e7"
            ]
        ]
    },
    {
        "id": "194bd35897d17539",
        "type": "inject",
        "z": "f778b963edde7e03",
        "name": "5 Mins",
        "props": [],
        "repeat": "18000",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 120,
        "y": 80,
        "wires": [
            [
                "353be57be86fb6f0"
            ]
        ]
    },
    {
        "id": "33e1127e463d84e7",
        "type": "MSSQL",
        "z": "f778b963edde7e03",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "sql",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 880,
        "y": 80,
        "wires": [
            [
                "8dda5aa93a965063"
            ]
        ]
    },
    {
        "id": "fbcbf50a6d24017c",
        "type": "debug",
        "z": "f778b963edde7e03",
        "name": "debug 19",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1840,
        "y": 80,
        "wires": []
    },
    {
        "id": "1f3945f83539c6b7",
        "type": "function",
        "z": "f778b963edde7e03",
        "name": "function 11",
        "func": "// Input:\n//   msg.payload = array of objects, e.g.\n//   [\n//     {\"id\":\"IS-SWAJ-251030-JOB8729-1\",\"invoice_pl_c\":null,\"pl_vertical_c\":\"Metering 3.02\"},\n//     {\"id\":\"IS-SWAJ-251030-JOB8726-1\",\"invoice_pl_c\":null,\"pl_vertical_c\":\"Metering 3.02\"},\n//     {\"id\":\"IS-SWAJ-251030-JOB8716-1\",\"invoice_pl_c\":null,\"pl_vertical_c\":\"Metering 3.02\"}\n//   ]\n//   msg.module = \"<Sugar module name>\"\n//   msg.action = \"POST\" | \"PUT\" | \"DELETE\"\n//\n// Output to MSSQL Plus: one msg per row with msg.query = EXEC aa.SugarApiQueue_Enqueue ...\n\nfunction ensureStr(x) {\n    return (x === null || x === undefined) ? '' : String(x);\n}\n\n// Minimal NVARCHAR literal escaper for SQL\nfunction sqlQuote(s) {\n    return \"N'\" + String(s).replace(/'/g, \"''\") + \"'\";\n}\n\nif (!Array.isArray(msg.payload)) {\n    node.error(\"payload must be an array of row objects\", msg);\n    return null;\n}\n\nconst moduleName = ensureStr(msg.module);\nconst action = ensureStr(msg.action).toUpperCase();\n\nif (!moduleName) {\n    node.error(\"msg.module is required\", msg);\n    return null;\n}\nif (!['POST', 'PUT', 'DELETE'].includes(action)) {\n    node.error(\"msg.action must be one of POST|PUT|DELETE\", msg);\n    return null;\n}\n\nconst outMsgs = [];\n\nfor (const row of msg.payload) {\n    if (!row || typeof row !== 'object') continue;\n\n    const id = ensureStr(row.id);\n    if (!id) {\n        node.warn(\"Skipping row without 'id': \" + JSON.stringify(row));\n        continue;\n    }\n\n    // dedupe_key = action:module:id\n    const dedupe_key = `${action}:${moduleName}:${id}`;\n\n    // Include id IN the payload body (as requested)\n    // Do not strip it out; keep the full object as Sugar’s request body.\n    // If needed, you can tailor the body structure here.\n    const payload_json = JSON.stringify(row);\n\n    const q =\n        \"EXEC aa.SugarApiQueue_Enqueue \" +\n        \"@dedupe_key=\"   + sqlQuote(dedupe_key)   + \", \" +\n        \"@module=\"       + sqlQuote(moduleName)   + \", \" +\n        \"@action=\"       + sqlQuote(action)       + \", \" +\n        \"@payload_json=\" + sqlQuote(payload_json) + \";\";\n\n    outMsgs.push({ query: q });\n}\n\nif (outMsgs.length === 0) {\n    node.warn(\"No rows enqueued (empty after validation).\");\n    return null;\n}\n\n// One message per row → MSSQL Plus executes sequentially\nreturn [outMsgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 80,
        "wires": [
            [
                "8227abe3e8d83090"
            ]
        ]
    },
    {
        "id": "8dda5aa93a965063",
        "type": "change",
        "z": "f778b963edde7e03",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "module",
                "pt": "msg",
                "to": "Order_Invoice_Schedule",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "action",
                "pt": "msg",
                "to": "PUT",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1080,
        "y": 80,
        "wires": [
            [
                "1f3945f83539c6b7"
            ]
        ]
    },
    {
        "id": "1b4833c02728ab64",
        "type": "MSSQL",
        "z": "f778b963edde7e03",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "query",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1660,
        "y": 80,
        "wires": [
            [
                "fbcbf50a6d24017c"
            ]
        ]
    },
    {
        "id": "7914058fe907a7d0",
        "type": "inject",
        "z": "f778b963edde7e03",
        "name": "30 Second Pulse",
        "props": [],
        "repeat": "30",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 150,
        "y": 440,
        "wires": [
            [
                "02baccb8aa57ecd1"
            ]
        ]
    },
    {
        "id": "382ecd4974ae5f3e",
        "type": "MSSQL",
        "z": "f778b963edde7e03",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "EXEC aa.SugarApiQueue_Claim @claimer='Node-Red Worker', @lease_minutes=240",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "payload",
        "queryOptType": "editor",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 630,
        "y": 440,
        "wires": [
            [
                "e87c220364707374"
            ]
        ]
    },
    {
        "id": "df393085b1ae9325",
        "type": "subflow:2ef09639923d028e",
        "z": "f778b963edde7e03",
        "name": "",
        "x": 1000,
        "y": 440,
        "wires": [
            [
                "8e6638759765c496"
            ]
        ]
    },
    {
        "id": "8e6638759765c496",
        "type": "function",
        "z": "f778b963edde7e03",
        "name": "Deployment Prep",
        "func": "// Node-RED Function: Deploy bot with typed botInput (A360 v3)\n\n// Token\nconst TOKEN = String(msg.payload.token);\n\n//Inputs\nconst strWorkId = String(msg.work_id)\nconst strPayload = String(msg.py_json)\n\n// IDs as strings\nconst fileId = String(331330);\n\nconst runAsUserIds = [623,624,625,626,627,569,514,600,571,517,594,595,596,597,598,599].map(String);\nconst poolIds = [\"24\"];\nconst automationName = `[SugarApiQueueWorker] ID: ${msg.work_id} - Action: ${msg.action} - Module: ${msg.module}`\n\n// Build botInput exactly as per docs\nconst botInput = {\n  strWorkId: { type: \"STRING\", string: strWorkId},\n  strPayload: { type: \"STRING\", string: strPayload}\n};\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/automations/deploy\";\nmsg.headers = {\n  \"Accept\": \"application/json\",\n  \"Content-Type\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  fileId,\n  automationName: automationName,\n  runAsUserIds,\n  overrideDefaultDevice: true,\n  numOfRunAsUsersToUse: 1,\n  automationPriority: \"PRIORITY_LOW\",\n  poolIds,\n  botInput\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 440,
        "wires": [
            [
                "01c4cff49f78c3e9"
            ]
        ]
    },
    {
        "id": "01c4cff49f78c3e9",
        "type": "http request",
        "z": "f778b963edde7e03",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1420,
        "y": 440,
        "wires": [
            [
                "883b2749233f8a0c"
            ]
        ]
    },
    {
        "id": "cfbadd0531b40401",
        "type": "function",
        "z": "f778b963edde7e03",
        "name": "Check Response",
        "func": "// Node-RED Function: route by presence of deploymentId and emit SQL UPDATE\n// Output #1: deploymentId present  -> success UPDATE\n// Output #2: deploymentId missing  -> failure UPDATE\n\nfunction esc(v) {\n    return String(v == null ? \"\" : v).replace(/'/g, \"''\");\n}\n\n// Normalize/parse HTTP response JSON in msg.payload\nlet body = msg.payload;\ntry {\n    if (Buffer.isBuffer(body)) body = body.toString(\"utf8\");\n    if (typeof body === \"string\") body = JSON.parse(body);\n} catch (e) {\n    // If not JSON, coerce to an object with message\n    body = { message: String(msg.payload) };\n}\n\n// Require event_id\nconst eventIdRaw = msg?.details?.event_id;\nif (!eventIdRaw) {\n    const out2 = { ...msg };\n    out2.reason = \"missing_event_id\";\n    return [null, out2];\n}\nconst eventId = String(eventIdRaw);\n\n// Read deploymentId and message (case-insensitive keys tolerated)\nconst deploymentId =\n    body?.deploymentId ?? body?.DeploymentId ?? body?.deploymentID ?? null;\n\nif (deploymentId && String(deploymentId).trim().length > 0) {\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 1, deployment_id = '${esc(deploymentId)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out1 = { ...msg, topic: sql, query: sql };\n    return [out1, null];\n} else {\n    const errMsg =\n        body?.message ??\n        body?.error ??\n        body?.Message ??\n        \"Unknown error\";\n\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 0, failure_resolved = 0, deployment_error = '${esc(errMsg)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out2 = { ...msg, topic: sql, query: sql };\n    return [null, out2];\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1430,
        "y": 560,
        "wires": [
            [],
            []
        ],
        "outputLabels": [
            "Deployed Successful",
            "Deployment Failure"
        ]
    },
    {
        "id": "e87c220364707374",
        "type": "function",
        "z": "f778b963edde7e03",
        "name": "Check Job",
        "func": "// Goal:\n// - If no job: stop quietly (no error), set a neutral status.\n// - If a job exists: set msg.work_id (number) and msg.py_json (string) and continue.\n\n// Normalize possible shapes from MSSQL-Plus\nfunction getRows(p) {\n    if (Array.isArray(p)) return p;\n    if (p && Array.isArray(p.recordset)) return p.recordset; // some drivers\n    if (p && Array.isArray(p.rows)) return p.rows;           // alt shape\n    return [];\n}\n\nfunction toIntIfNumeric(v) {\n    if (typeof v === 'number') return v;\n    if (typeof v === 'string' && /^[0-9]+$/.test(v)) return parseInt(v, 10);\n    return v;\n}\n\nconst rows = getRows(msg.payload);\n\n// No job → stop quietly\nif (rows.length === 0) {\n    node.status({ fill: \"grey\", shape: \"ring\", text: \"no job\" });\n    return null;\n}\n\n// Take the first row (Claim returns at most one)\nconst r = rows[0];\n\n// Be case-insensitive for column names\nconst workId = r.work_id ?? r.WORK_ID ?? r.Work_ID ?? r.WorkId;\nconst pyJson = r.py_json ?? r.PY_JSON ?? r.Py_Json ?? r.PyJSON ?? r.PYJSON;\n\nif (workId == null || pyJson == null) {\n    // If shape is unexpected, stop quietly (don’t spam logs)\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"claim: unexpected columns\" });\n    return null;\n}\n\n// Set outputs\nmsg.work_id = toIntIfNumeric(workId);\nmsg.py_json = typeof pyJson === 'string' ? pyJson : JSON.stringify(pyJson);\nmsg.action = msg.payload[0].action\nmsg.module = msg.payload[0].module\n\n// Optional housekeeping:\n// delete msg.payload;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `claimed ${msg.work_id}` });\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 440,
        "wires": [
            [
                "df393085b1ae9325"
            ]
        ]
    },
    {
        "id": "8227abe3e8d83090",
        "type": "delay",
        "z": "f778b963edde7e03",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "4",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1470,
        "y": 80,
        "wires": [
            [
                "1b4833c02728ab64"
            ]
        ]
    },
    {
        "id": "883b2749233f8a0c",
        "type": "debug",
        "z": "f778b963edde7e03",
        "name": "debug 32",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1600,
        "y": 440,
        "wires": []
    },
    {
        "id": "353be57be86fb6f0",
        "type": "subflow:c4217fb89f6015dc",
        "z": "f778b963edde7e03",
        "name": "",
        "x": 310,
        "y": 80,
        "wires": [
            [
                "650238c325f9e5d8"
            ]
        ]
    },
    {
        "id": "650238c325f9e5d8",
        "type": "switch",
        "z": "f778b963edde7e03",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 435,
        "y": 80,
        "wires": [
            [
                "966e3b368e7d6e23"
            ]
        ],
        "l": false
    },
    {
        "id": "02baccb8aa57ecd1",
        "type": "subflow:c4217fb89f6015dc",
        "z": "f778b963edde7e03",
        "name": "",
        "x": 370,
        "y": 440,
        "wires": [
            [
                "5a548d0d34389b8e"
            ]
        ]
    },
    {
        "id": "5a548d0d34389b8e",
        "type": "switch",
        "z": "f778b963edde7e03",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 495,
        "y": 440,
        "wires": [
            [
                "382ecd4974ae5f3e"
            ]
        ],
        "l": false
    },
    {
        "id": "ba449a138bb110d5",
        "type": "http in",
        "z": "d6212fb1464d8c29",
        "name": "",
        "url": "/watchfolder",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 360,
        "wires": [
            [
                "9a31f1c85a534ffd",
                "6416d54bfb7fa782",
                "3922706ba1e4f278"
            ]
        ]
    },
    {
        "id": "6416d54bfb7fa782",
        "type": "http response",
        "z": "d6212fb1464d8c29",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 440,
        "y": 500,
        "wires": []
    },
    {
        "id": "e921a9f28c50d579",
        "type": "debug",
        "z": "d6212fb1464d8c29",
        "name": "debug 38",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "details",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 660,
        "wires": []
    },
    {
        "id": "2a3f3c8e92bb2100",
        "type": "switch",
        "z": "d6212fb1464d8c29",
        "name": "",
        "property": "details.folder_name",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Sugar Many to Many Relationships [NEW]",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Sugar Many to Many Relationships [UPDATE/DELETE]",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 610,
        "y": 360,
        "wires": [
            [
                "ce5a44e76716bbec"
            ],
            [
                "151af69c044aa10b"
            ],
            [
                "1e7f0cf073502140"
            ]
        ]
    },
    {
        "id": "9a31f1c85a534ffd",
        "type": "change",
        "z": "d6212fb1464d8c29",
        "name": "Store Incoming Details",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "details",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.environment",
                "pt": "msg",
                "to": "live",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 360,
        "wires": [
            [
                "1691139dbf82c746",
                "2a3f3c8e92bb2100"
            ]
        ]
    },
    {
        "id": "ce5a44e76716bbec",
        "type": "subflow:2ef09639923d028e",
        "z": "d6212fb1464d8c29",
        "g": "6f225a1da665927d",
        "name": "",
        "x": 810,
        "y": 80,
        "wires": [
            [
                "054e3aad9e3f5dc4"
            ]
        ]
    },
    {
        "id": "054e3aad9e3f5dc4",
        "type": "function",
        "z": "d6212fb1464d8c29",
        "g": "6f225a1da665927d",
        "name": "Deployment Prep",
        "func": "// Node-RED Function: Deploy bot with typed botInput (A360 v3)\n\n// Token\nconst TOKEN = String(msg.payload.token);\n\n//event ID\nconst eventId = String(msg.details.event_id)\n\n// IDs as strings\nconst fileId = String(330384);\n\nconst runAsUserIds = [623,624,625,626,627,569,514,600,571,517,594,595,596,597,598,599].map(String);\nconst poolIds = [\"24\"];\nconst automationName = `[Folder Trigger] Multi Relationships (New) - ${msg.details.file_name}`\n\n// Windows path: normal JS string; JSON serializer will escape '\\'\nconst strFilePath = `${msg.details.folder_path}\\\\${msg.details.file_name}`;\n\n// Build botInput exactly as per docs\nconst botInput = {\n  strEventId: { type: \"STRING\", string: eventId},\n  strExcelFilePath: { type: \"STRING\", string: strFilePath }\n};\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/automations/deploy\";\nmsg.headers = {\n  \"Accept\": \"application/json\",\n  \"Content-Type\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  fileId,\n  automationName: automationName,\n  runAsUserIds,\n  overrideDefaultDevice: true,\n  numOfRunAsUsersToUse: 1,\n  automationPriority: \"PRIORITY_MEDIUM\",\n  poolIds,\n  botInput\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 80,
        "wires": [
            [
                "2575216802b03675"
            ]
        ]
    },
    {
        "id": "2575216802b03675",
        "type": "http request",
        "z": "d6212fb1464d8c29",
        "g": "6f225a1da665927d",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1230,
        "y": 80,
        "wires": [
            [
                "78f1d70fb7480504"
            ]
        ]
    },
    {
        "id": "78f1d70fb7480504",
        "type": "function",
        "z": "d6212fb1464d8c29",
        "g": "6f225a1da665927d",
        "name": "Check Response",
        "func": "// Node-RED Function: route by presence of deploymentId and emit SQL UPDATE\n// Output #1: deploymentId present  -> success UPDATE\n// Output #2: deploymentId missing  -> failure UPDATE\n\nfunction esc(v) {\n    return String(v == null ? \"\" : v).replace(/'/g, \"''\");\n}\n\n// Normalize/parse HTTP response JSON in msg.payload\nlet body = msg.payload;\ntry {\n    if (Buffer.isBuffer(body)) body = body.toString(\"utf8\");\n    if (typeof body === \"string\") body = JSON.parse(body);\n} catch (e) {\n    // If not JSON, coerce to an object with message\n    body = { message: String(msg.payload) };\n}\n\n// Require event_id\nconst eventIdRaw = msg?.details?.event_id;\nif (!eventIdRaw) {\n    const out2 = { ...msg };\n    out2.reason = \"missing_event_id\";\n    return [null, out2];\n}\nconst eventId = String(eventIdRaw);\n\n// Read deploymentId and message (case-insensitive keys tolerated)\nconst deploymentId =\n    body?.deploymentId ?? body?.DeploymentId ?? body?.deploymentID ?? null;\n\nif (deploymentId && String(deploymentId).trim().length > 0) {\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 1, deployment_id = '${esc(deploymentId)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out1 = { ...msg, topic: sql, query: sql };\n    return [out1, null];\n} else {\n    const errMsg =\n        body?.message ??\n        body?.error ??\n        body?.Message ??\n        \"Unknown error\";\n\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 0, failure_resolved = 0, deployment_error = '${esc(errMsg)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out2 = { ...msg, topic: sql, query: sql };\n    return [null, out2];\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 80,
        "wires": [
            [
                "2dc8996674a86345"
            ],
            [
                "2dc8996674a86345"
            ]
        ],
        "outputLabels": [
            "Deployed Successful",
            "Deployment Failure"
        ]
    },
    {
        "id": "2dc8996674a86345",
        "type": "MSSQL",
        "z": "d6212fb1464d8c29",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 1680,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "1e7f0cf073502140",
        "type": "function",
        "z": "d6212fb1464d8c29",
        "name": "Prepare SQL",
        "func": "const event_id = msg.details.event_id\nmsg.topic = `UPDATE aa.watchdog_watchfolder_logs SET [deployment_successful] = 0, [deployment_error] = 'No deployment configuration has been configured for this folder on Node-Red' WHERE [event_id] = '${event_id}'`\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 460,
        "wires": [
            [
                "e921a9f28c50d579",
                "e0f14f3b032c7fc3"
            ]
        ]
    },
    {
        "id": "e0f14f3b032c7fc3",
        "type": "MSSQL",
        "z": "d6212fb1464d8c29",
        "mssqlCN": "4159b2383138607d",
        "name": "",
        "outField": "payload",
        "returnType": 0,
        "throwErrors": 1,
        "query": "",
        "modeOpt": "queryMode",
        "modeOptType": "query",
        "queryOpt": "topic",
        "queryOptType": "msg",
        "paramsOpt": "queryParams",
        "paramsOptType": "none",
        "rows": "rows",
        "rowsType": "msg",
        "parseMustache": true,
        "params": [],
        "x": 980,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "151af69c044aa10b",
        "type": "subflow:2ef09639923d028e",
        "z": "d6212fb1464d8c29",
        "g": "0b41605f5c419952",
        "name": "",
        "x": 810,
        "y": 200,
        "wires": [
            [
                "8b60c785a303fd1f"
            ]
        ]
    },
    {
        "id": "8b60c785a303fd1f",
        "type": "function",
        "z": "d6212fb1464d8c29",
        "g": "0b41605f5c419952",
        "name": "Deployment Prep",
        "func": "// Node-RED Function: Deploy bot with typed botInput (A360 v3)\n\n// Token\nconst TOKEN = String(msg.payload.token);\n\n//event ID\nconst eventId = String(msg.details.event_id)\n\n// IDs as strings\nconst fileId = String(330385);\n\nconst runAsUserIds = [623,624,625,626,627,569,514,600,571,517,594,595,596,597,598,599].map(String);\nconst poolIds = [\"24\"];\nconst automationName = `[Folder Trigger] Multi Relationships (Update/Delete) - ${msg.details.file_name}`\n\n// Windows path: normal JS string; JSON serializer will escape '\\'\nconst strFilePath = `${msg.details.folder_path}\\\\${msg.details.file_name}`;\n\n// Build botInput exactly as per docs\nconst botInput = {\n  strEventId: { type: \"STRING\", string: eventId},\n  strExcelFilePath: { type: \"STRING\", string: strFilePath }\n};\n\nmsg.method = \"POST\";\nmsg.url = \"https://inspired-1.my.automationanywhere.digital/v3/automations/deploy\";\nmsg.headers = {\n  \"Accept\": \"application/json\",\n  \"Content-Type\": \"application/json\",\n  \"X-Authorization\": TOKEN\n};\n\nmsg.payload = {\n  fileId,\n  automationName: automationName,\n  runAsUserIds,\n  overrideDefaultDevice: true,\n  numOfRunAsUsersToUse: 1,\n  automationPriority: \"PRIORITY_MEDIUM\",\n  poolIds,\n  botInput\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 200,
        "wires": [
            [
                "e1571a0d7d10ecf2"
            ]
        ]
    },
    {
        "id": "e1571a0d7d10ecf2",
        "type": "http request",
        "z": "d6212fb1464d8c29",
        "g": "0b41605f5c419952",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1230,
        "y": 200,
        "wires": [
            [
                "639c78af7a2f0a7b"
            ]
        ]
    },
    {
        "id": "639c78af7a2f0a7b",
        "type": "function",
        "z": "d6212fb1464d8c29",
        "g": "0b41605f5c419952",
        "name": "Check Response",
        "func": "// Node-RED Function: route by presence of deploymentId and emit SQL UPDATE\n// Output #1: deploymentId present  -> success UPDATE\n// Output #2: deploymentId missing  -> failure UPDATE\n\nfunction esc(v) {\n    return String(v == null ? \"\" : v).replace(/'/g, \"''\");\n}\n\n// Normalize/parse HTTP response JSON in msg.payload\nlet body = msg.payload;\ntry {\n    if (Buffer.isBuffer(body)) body = body.toString(\"utf8\");\n    if (typeof body === \"string\") body = JSON.parse(body);\n} catch (e) {\n    // If not JSON, coerce to an object with message\n    body = { message: String(msg.payload) };\n}\n\n// Require event_id\nconst eventIdRaw = msg?.details?.event_id;\nif (!eventIdRaw) {\n    const out2 = { ...msg };\n    out2.reason = \"missing_event_id\";\n    return [null, out2];\n}\nconst eventId = String(eventIdRaw);\n\n// Read deploymentId and message (case-insensitive keys tolerated)\nconst deploymentId =\n    body?.deploymentId ?? body?.DeploymentId ?? body?.deploymentID ?? null;\n\nif (deploymentId && String(deploymentId).trim().length > 0) {\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 1, deployment_id = '${esc(deploymentId)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out1 = { ...msg, topic: sql, query: sql };\n    return [out1, null];\n} else {\n    const errMsg =\n        body?.message ??\n        body?.error ??\n        body?.Message ??\n        \"Unknown error\";\n\n    const sql =\n        `UPDATE aa.watchdog_watchfolder_logs ` +\n        `SET deployment_successful = 0, failure_resolved = 0, deployment_error = '${esc(errMsg)}' ` +\n        `WHERE event_id = '${esc(eventId)}'`;\n\n    const out2 = { ...msg, topic: sql, query: sql };\n    return [null, out2];\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 200,
        "wires": [
            [
                "2dc8996674a86345"
            ],
            [
                "2dc8996674a86345"
            ]
        ],
        "outputLabels": [
            "Deployed Successful",
            "Deployment Failure"
        ]
    },
    {
        "id": "3922706ba1e4f278",
        "type": "debug",
        "z": "d6212fb1464d8c29",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 400,
        "y": 280,
        "wires": []
    },
    {
        "id": "1691139dbf82c746",
        "type": "debug",
        "z": "d6212fb1464d8c29",
        "name": "debug 8",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "details",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 660,
        "wires": []
    }
]